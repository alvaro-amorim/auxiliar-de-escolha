<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Comerc IAs ‚Ä¢ Or√ßamento</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'ui-sans-serif', 'system-ui'] },
          boxShadow: {
            premium: '0 22px 60px rgba(2, 62, 138, .18)',
            soft: '0 14px 34px rgba(2, 62, 138, .12)',
          }
        }
      }
    }
  </script>

  <style>
    :root{
      --ink: #0b1220;
      --muted: #52627a;
      --muted2: #73839a;
      --blue-900:#0b3a7e;
      --blue-800:#0a4aa0;
      --blue-700:#0b5ed7;
      --blue-600:#1d7afc;
      --blue-200:#cfe5ff;
      --blue-100:#e8f3ff;
      --line: rgba(11,94,215,.18);
      --panel: rgba(255,255,255,.92);
    }

    body{
      color: var(--ink);
      background:
        radial-gradient(1100px 620px at 10% 0%, rgba(29,122,252,.18), transparent 55%),
        radial-gradient(900px 520px at 92% 12%, rgba(11,94,215,.12), transparent 55%),
        radial-gradient(880px 560px at 50% 98%, rgba(29,122,252,.10), transparent 60%),
        linear-gradient(180deg, #f6fbff, #ffffff);
    }

    .dots{
      background-image: radial-gradient(rgba(11,94,215,.10) 1px, transparent 1px);
      background-size: 18px 18px;
      mask-image: radial-gradient(circle at 30% 18%, black 0%, transparent 65%);
      opacity: .55;
      pointer-events:none;
    }

    .glass{
      background: var(--panel);
      border: 1px solid var(--line);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 22px 60px rgba(2, 62, 138, .18);
    }

    .panel{
      background: linear-gradient(180deg, #ffffff, #fbfdff);
      border: 1px solid rgba(11,94,215,.14);
      box-shadow: 0 14px 34px rgba(2, 62, 138, .10);
    }

    .btn-primary{
      background: linear-gradient(90deg, var(--blue-700), var(--blue-600));
      color: #fff;
      box-shadow: 0 16px 42px rgba(29,122,252,.22);
      transition: transform .14s ease, filter .14s ease;
    }
    .btn-primary:hover{ filter: brightness(1.03); transform: translateY(-1px); }

    .btn-ghost{
      background: #fff;
      border: 1px solid rgba(11,94,215,.18);
      color: var(--blue-900);
      transition: background .14s ease;
    }
    .btn-ghost:hover{ background: var(--blue-100); }

    .ring-focus:focus{ outline:none; box-shadow: 0 0 0 6px rgba(29,122,252,.18); }

    .fade{ opacity:0; transform: translateY(10px); transition: all .20s ease; }
    .fade.show{ opacity:1; transform: translateY(0); }

    .opt{
      border: 1px solid rgba(11,94,215,.16);
      background: #fff;
      transition: transform .14s ease, background .14s ease, border-color .14s ease;
    }
    .opt:hover{
      transform: translateY(-1px);
      background: #f3f9ff;
      border-color: rgba(11,94,215,.26);
    }
    .opt.active{
      background: linear-gradient(180deg, #f1f8ff, #ffffff);
      border-color: rgba(11,94,215,.40);
    }

    .chip{
      border: 1px solid rgba(11,94,215,.18);
      background: #fff;
      color: var(--blue-900);
      transition: background .14s ease, border-color .14s ease, transform .14s ease;
    }
    .chip:hover{ background: var(--blue-100); transform: translateY(-1px); }
    .chip.active{
      background: linear-gradient(90deg, rgba(11,94,215,.12), rgba(29,122,252,.10));
      border-color: rgba(11,94,215,.42);
      color: var(--blue-900);
    }

    .grad-border{
      position: relative;
      border-radius: 22px;
      overflow: hidden;
    }
    .grad-border:before{
      content:"";
      position:absolute; inset:0;
      padding: 1px;
      border-radius: 22px;
      background: linear-gradient(135deg, rgba(11,94,215,.60), rgba(29,122,252,.55), rgba(11,74,160,.55));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
      opacity: .9;
    }

    #modalPanel{ transform: translateY(10px) scale(.99); opacity:0; transition: all .16s ease; }
    #modalPanel.show{ transform: translateY(0) scale(1); opacity:1; }

    @media (max-width: 767px){
      #modalPanel{
        border-bottom-left-radius: 0 !important;
        border-bottom-right-radius: 0 !important;
        align-self: flex-end;
        max-height: 92vh;
      }
      .stickyMobileBar{
        position: sticky;
        bottom: 0;
        z-index: 10;
        background: rgba(255,255,255,.92);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-top: 1px solid rgba(11,94,215,.16);
      }
    }
  </style>
</head>

<body class="min-h-screen font-sans">
  <div class="fixed inset-0 dots"></div>

  <main class="relative min-h-screen flex items-center justify-center px-4 py-10">
    <div class="w-full max-w-6xl">

      <!-- Header -->
      <div class="flex items-center justify-between mb-6 md:mb-8">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-2xl bg-white border border-blue-200 flex items-center justify-center shadow-soft">
            <span class="text-sm font-extrabold text-blue-800">CI</span>
          </div>
          <div>
            <div class="text-sm text-slate-600">Comerc IAs</div>
            <div class="text-lg font-extrabold tracking-tight text-slate-900">Or√ßamento ‚Ä¢ Seletor de Servi√ßos</div>
          </div>
        </div>

        <div class="inline-flex items-center gap-1 p-1 rounded-2xl btn-ghost">
          <button id="langPTTop" class="ring-focus px-3 py-2 rounded-xl text-sm font-semibold bg-blue-50">üáßüá∑ PT</button>
          <button id="langENTop" class="ring-focus px-3 py-2 rounded-xl text-sm font-semibold text-slate-600">üá∫üá∏ EN</button>
        </div>
      </div>

      <!-- Hero -->
      <section class="glass rounded-[28px] overflow-hidden">
        <div class="p-6 md:p-10 grid lg:grid-cols-[1.1fr_.9fr] gap-8">
          <div>
            <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-blue-50 border border-blue-200 text-xs text-blue-900">
              <span class="inline-block h-2 w-2 rounded-full bg-blue-600"></span>
              <span id="heroBadge">Quiz ‚Ä¢ Pacotes ‚Ä¢ Economia por combo</span>
            </div>

            <h1 id="heroTitle" class="mt-4 text-3xl md:text-5xl font-extrabold tracking-tight leading-[1.05] text-slate-900">
              Encontre o pacote ideal para o seu objetivo.
            </h1>

            <p id="heroSub" class="mt-4 text-slate-600 text-base md:text-lg max-w-2xl">
              Responda em ~2 minutos. No final, selecione servi√ßos, veja o total estimado e v√° para o or√ßamento pr√©-preenchido.
            </p>

            <div class="mt-6 flex flex-col sm:flex-row gap-3">
              <button id="openModal" class="ring-focus btn-primary transition-all px-6 py-3.5 rounded-2xl font-extrabold inline-flex items-center justify-center gap-2">
                <span id="ctaStart">Come√ßar</span>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="opacity-95">
                  <path d="M8 5l8 7-8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>

              <div class="rounded-2xl btn-ghost px-4 py-3 text-sm text-slate-700 leading-snug">
                <div class="font-semibold text-blue-900" id="miniNoteTitle">Comerc IAs</div>
                <div id="miniNoteText">
                  Escolha um pacote pronto ou personalize selecionando servi√ßos.
                </div>
              </div>
            </div>

            <div class="mt-6 grid sm:grid-cols-3 gap-3">
              <div class="rounded-2xl panel p-4">
                <div class="font-semibold text-slate-900" id="b1t">Direto ao ponto</div>
                <div class="text-slate-600 text-sm mt-1" id="b1s">Perguntas objetivas para recomendar o melhor caminho.</div>
              </div>
              <div class="rounded-2xl panel p-4">
                <div class="font-semibold text-slate-900" id="b2t">Pacotes prontos</div>
                <div class="text-slate-600 text-sm mt-1" id="b2s">Essencial ‚Ä¢ Recomendado ‚Ä¢ Scale.</div>
              </div>
              <div class="rounded-2xl panel p-4">
                <div class="font-semibold text-slate-900" id="b3t">Finaliza√ß√£o r√°pida</div>
                <div class="text-slate-600 text-sm mt-1" id="b3s">Vai para o or√ßamento com tudo pr√©-preenchido.</div>
              </div>
            </div>
          </div>

          <!-- Preview -->
          <div class="grad-border">
            <div class="rounded-[22px] bg-white border border-blue-200 p-5 md:p-6 shadow-soft">
              <div class="flex items-center justify-between mb-4">
                <div class="text-sm text-slate-700" id="previewTitle">O que voc√™ recebe</div>
                <div class="text-xs text-slate-500" id="previewTime">~2 min</div>
              </div>

              <div class="space-y-3">
                <div class="rounded-2xl bg-blue-50 border border-blue-200 p-4">
                  <div class="text-slate-900 font-semibold" id="p1t">1) Diagn√≥stico</div>
                  <div class="text-slate-600 text-sm mt-1" id="p1s">Objetivo, canal, volume, prazo e or√ßamento.</div>
                </div>
                <div class="rounded-2xl bg-blue-50 border border-blue-200 p-4">
                  <div class="text-slate-900 font-semibold" id="p2t">2) 3 pacotes</div>
                  <div class="text-slate-600 text-sm mt-1" id="p2s">Escolha r√°pido ou personalize.</div>
                </div>
                <div class="rounded-2xl bg-blue-50 border border-blue-200 p-4">
                  <div class="text-slate-900 font-semibold" id="p3t">3) Economia</div>
                  <div class="text-slate-600 text-sm mt-1" id="p3s">Simula√ß√£o de desconto ao combinar servi√ßos.</div>
                </div>
              </div>

              <div class="mt-5 rounded-2xl bg-gradient-to-r from-blue-50 to-white border border-blue-200 p-4">
                <div class="text-sm font-semibold text-slate-900" id="dealTitle">Combo (simulado)</div>
                <div class="text-slate-600 text-sm mt-1" id="dealText">2 servi√ßos: 5% ‚Ä¢ 3: 8% ‚Ä¢ 4+: 12%</div>
              </div>
            </div>
          </div>
        </div>

        <div class="px-6 md:px-10 py-4 border-t border-blue-200 bg-white text-xs text-slate-500" id="footerLine">
          *Valores e descontos s√£o estimativas para facilitar a decis√£o.
        </div>
      </section>
    </div>
  </main>

  <!-- MODAL -->
  <div id="modal" class="fixed inset-0 hidden items-end md:items-center justify-center p-0 md:p-8">
    <div id="backdrop" class="absolute inset-0 bg-slate-900/40"></div>

    <div id="modalPanel" class="relative w-full md:w-[min(1140px,96vw)] glass rounded-t-[28px] md:rounded-[28px] overflow-hidden max-h-[92vh] md:max-h-[90vh] flex flex-col">

      <!-- Modal Header -->
      <div class="px-5 md:px-7 py-4 border-b border-blue-200 bg-white flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-2xl bg-blue-50 border border-blue-200 flex items-center justify-center">
            <span class="text-sm font-extrabold text-blue-800">CI</span>
          </div>
          <div>
            <div class="font-extrabold tracking-tight text-slate-900" id="modalTitle">Comerc IAs ‚Ä¢ Quiz de Or√ßamento</div>
            <div class="text-xs text-slate-600" id="modalSub">Pacotes + personaliza√ß√£o + or√ßamento pr√©-preenchido</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <div class="hidden sm:inline-flex items-center gap-1 p-1 rounded-2xl btn-ghost">
            <button id="langPT" class="ring-focus px-3 py-2 rounded-xl text-sm font-semibold bg-blue-50">üáßüá∑ PT</button>
            <button id="langEN" class="ring-focus px-3 py-2 rounded-xl text-sm font-semibold text-slate-600">üá∫üá∏ EN</button>
          </div>
          <button id="closeModal" class="ring-focus px-3 py-2 rounded-2xl btn-ghost text-blue-900">‚úï</button>
        </div>
      </div>

      <!-- Stepper -->
      <div class="px-5 md:px-7 py-4 border-b border-blue-200 bg-white">
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm font-semibold text-slate-900" id="stepTitle">Etapa</div>
          <div class="text-xs text-slate-500" id="stepMeta">0/0</div>
        </div>
        <div class="mt-3 h-2 rounded-full bg-blue-100 overflow-hidden">
          <div id="stepBar" class="h-2 rounded-full bg-gradient-to-r from-blue-700 to-blue-500" style="width:0%"></div>
        </div>
      </div>

      <!-- Body -->
      <div class="flex-1 overflow-y-auto bg-white">
        <div class="grid md:grid-cols-[1.35fr_.65fr]">
          <div class="p-5 md:p-7">
            <div id="screen"></div>
          </div>

          <aside class="p-5 md:p-7 border-t md:border-t-0 md:border-l border-blue-200 bg-blue-50">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold text-slate-900" id="sideTitle">Resumo</h3>
              <span class="text-xs text-slate-500" id="sideHint">live</span>
            </div>

            <div id="sideSummary" class="mt-4 text-sm text-slate-800 space-y-2">
              <div class="text-slate-500" id="sideEmpty">Responda para ver recomenda√ß√µes.</div>
            </div>

            <div class="mt-5 rounded-3xl border border-blue-200 bg-white p-4 shadow-soft">
              <div class="flex items-center justify-between mb-2">
                <div class="text-sm font-semibold text-slate-900" id="simTitle">Simula√ß√£o</div>
                <span class="text-xs text-slate-500" id="simRule">2=5% ‚Ä¢ 3=8% ‚Ä¢ 4+=12%</span>
              </div>
              <div id="totalsBox" class="text-sm text-slate-700 space-y-1">
                <div class="flex justify-between"><span id="lblSub">Subtotal (avulsos)</span><span id="vSub">‚Äî</span></div>
                <div class="flex justify-between"><span id="lblDisc">Desconto combo</span><span id="vDisc">‚Äî</span></div>
                <div class="flex justify-between"><span id="lblPlans">Planos</span><span id="vPlans">‚Äî</span></div>
                <div class="flex justify-between font-extrabold text-slate-900"><span id="lblTotal">Total</span><span id="vTotal">‚Äî</span></div>
              </div>

              <div class="mt-3 text-xs text-slate-500" id="noteTotals">
                *Estimativa para acelerar sua decis√£o.
              </div>
            </div>

            <div class="mt-4 text-xs text-slate-500" id="sideStrategy">
              Dica: o pacote ‚ÄúRecomendado‚Äù costuma ter o melhor custo-benef√≠cio.
            </div>
          </aside>
        </div>
      </div>

      <!-- Footer actions -->
      <div class="px-5 md:px-7 py-4 border-t border-blue-200 bg-white flex items-center justify-between gap-3">
        <button id="backBtn" class="ring-focus px-4 py-2.5 rounded-2xl btn-ghost hidden">Voltar</button>
        <button id="skipBtn" class="ring-focus px-4 py-2.5 rounded-2xl btn-ghost hidden">Pular</button>
        <button id="nextBtn" class="ring-focus px-5 py-2.5 rounded-2xl btn-primary font-extrabold transition-all disabled:opacity-50 disabled:cursor-not-allowed">Continuar</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const CATALOG = {
    observacoes: "Valores podem variar conforme briefing, revis√µes e prazo. O or√ßamento final confirma tudo.",
    categorias: [
      { nome: "Imagens", servicos: [
        { titulo:"Imagem (B√°sica)", descricao:"Arte r√°pida para post/an√∫ncio.", extras:"1 varia√ß√£o ‚Ä¢ Alta resolu√ß√£o", preco:50 },
        { titulo:"Imagem (Profissional)", descricao:"Mais elaborada para campanhas/carrossel.", extras:"2 varia√ß√µes ‚Ä¢ Ajustes finos", preco:90 },
        { titulo:"Imagem (Premium)", descricao:"Dire√ß√£o de arte premium e acabamento.", extras:"3 varia√ß√µes ‚Ä¢ Refinamento", preco:140 },
      ]},
      { nome: "V√≠deos", servicos: [
        { titulo:"V√≠deo (B√°sico)", descricao:"Cortes, legenda simples e ajustes.", extras:"At√© 30s", preco:120 },
        { titulo:"V√≠deo (Profissional)", descricao:"Ritmo + motion leve + legenda melhor.", extras:"At√© 60s", preco:250 },
        { titulo:"V√≠deo (Premium)", descricao:"Storytelling + motion avan√ßado + est√©tica.", extras:"At√© 90s", preco:420 },
      ]},
      { nome: "Servi√ßos Avulsos", servicos: [
        { titulo:"Logo", descricao:"Logo profissional e vers√°til.", extras:"2 op√ß√µes + ajustes", preco:220 },
        { titulo:"Identidade Visual", descricao:"Guia completo (cores/tipografia/padr√µes).", extras:"Manual de marca", preco:480 },
        { titulo:"Roteiro", descricao:"Roteiro curto com gancho e CTA.", extras:"Estrutura + CTA", preco:120 },
        { titulo:"Copywriting", descricao:"Texto persuasivo para an√∫ncios/p√°ginas.", extras:"1 vers√£o + varia√ß√£o", preco:180 },
        { titulo:"Pacote de An√∫ncios", descricao:"Criativos para tr√°fego pago.", extras:"3 pe√ßas", preco:300 },
        { titulo:"Website", descricao:"Landing page institucional.", extras:"P√°gina √∫nica", preco:650 },
        { titulo:"Narra√ß√£o", descricao:"Narra√ß√£o para v√≠deo/ads.", extras:"√Åudio limpo", preco:150 },
        { titulo:"Trilha Sonora", descricao:"Sele√ß√£o e ajuste de trilha.", extras:"Edi√ß√£o", preco:90 },
      ]},
      { nome: "Planos de Social Media", servicos: [
        {
          titulo:"Plano Mensal (B√°sico)",
          descricao:"Consist√™ncia mensal para presen√ßa profissional.",
          inclui:["10 imagens/m√™s","2 v√≠deos curtos/m√™s"],
          beneficios:["Consist√™ncia","Visual profissional"],
          precos_por_periodo:[
            {periodo:"Mensal", preco_total_sem_desc:750, desconto_percentual:0, preco_total_com_desc:750},
            {periodo:"Trimestral", preco_total_sem_desc:2250, desconto_percentual:10, preco_total_com_desc:2025},
            {periodo:"Semestral", preco_total_sem_desc:4500, desconto_percentual:15, preco_total_com_desc:3825},
            {periodo:"Anual", preco_total_sem_desc:9000, desconto_percentual:20, preco_total_com_desc:7200}
          ]
        },
        {
          titulo:"Plano Mensal (Profissional)",
          descricao:"Mais volume para crescer com variedade.",
          inclui:["20 imagens/m√™s","4 v√≠deos curtos/m√™s"],
          beneficios:["Maior volume","Performance melhor"],
          precos_por_periodo:[
            {periodo:"Mensal", preco_total_sem_desc:1400, desconto_percentual:0, preco_total_com_desc:1400},
            {periodo:"Trimestral", preco_total_sem_desc:4200, desconto_percentual:10, preco_total_com_desc:3780},
            {periodo:"Semestral", preco_total_sem_desc:8400, desconto_percentual:15, preco_total_com_desc:7140},
            {periodo:"Anual", preco_total_sem_desc:16800, desconto_percentual:20, preco_total_com_desc:13440}
          ]
        }
      ]}
    ]
  };

  const I18N = {
    pt: {
      heroBadge:"Quiz ‚Ä¢ Pacotes ‚Ä¢ Economia por combo",
      heroTitle:"Encontre o pacote ideal para o seu objetivo.",
      heroSub:"Responda em ~2 minutos. No final, selecione servi√ßos, veja o total estimado e v√° para o or√ßamento pr√©-preenchido.",
      ctaStart:"Come√ßar",
      miniNoteTitle:"Comerc IAs",
      miniNoteText:"Escolha um pacote pronto ou personalize selecionando servi√ßos.",
      b1t:"Direto ao ponto", b1s:"Perguntas objetivas para recomendar o melhor caminho.",
      b2t:"Pacotes prontos", b2s:"Essencial ‚Ä¢ Recomendado ‚Ä¢ Scale.",
      b3t:"Finaliza√ß√£o r√°pida", b3s:"Vai para o or√ßamento com tudo pr√©-preenchido.",
      previewTitle:"O que voc√™ recebe", previewTime:"~2 min",
      p1t:"1) Diagn√≥stico", p1s:"Objetivo, canal, volume, prazo e or√ßamento.",
      p2t:"2) 3 pacotes", p2s:"Escolha r√°pido ou personalize.",
      p3t:"3) Economia", p3s:"Simula√ß√£o de desconto ao combinar servi√ßos.",
      dealTitle:"Combo (simulado)", dealText:"2 servi√ßos: 5% ‚Ä¢ 3: 8% ‚Ä¢ 4+: 12%",
      footerLine:"*Valores e descontos s√£o estimativas para facilitar a decis√£o.",

      modalTitle:"Comerc IAs ‚Ä¢ Quiz de Or√ßamento",
      modalSub:"Pacotes + personaliza√ß√£o + or√ßamento pr√©-preenchido",
      sideTitle:"Resumo",
      sideEmpty:"Responda para ver recomenda√ß√µes.",
      simTitle:"Simula√ß√£o",
      lblSub:"Subtotal (avulsos)",
      lblDisc:"Desconto combo",
      lblPlans:"Planos",
      lblTotal:"Total",
      noteTotals:"*Estimativa para acelerar sua decis√£o.",
      sideStrategy:"Dica: o pacote ‚ÄúRecomendado‚Äù costuma ter o melhor custo-benef√≠cio.",

      back:"Voltar",
      next:"Continuar",
      skip:"Pular",

      step:"Etapa",
      stepOf:"de",

      q_goal:"Qual √© o seu objetivo principal?",
      goal_sales:"Gerar vendas/convers√£o",
      goal_social:"Conte√∫do cont√≠nuo para redes",
      goal_brand:"Fortalecer marca/branding",
      goal_edu:"Educar/explicar (conte√∫do t√©cnico)",

      q_channels:"Onde voc√™ vai publicar?",
      ch_instagram:"Instagram (Feed/Reels/Stories)",
      ch_tiktok:"TikTok",
      ch_youtube:"YouTube Shorts",
      ch_whatsapp:"WhatsApp",
      ch_site:"Site / Landing page",
      ch_multi:"V√°rios canais",

      q_focus:"Qual √°rea √© prioridade agora?",
      focus_auto:"Quero recomenda√ß√£o",
      focus_images:"Imagens / artes",
      focus_videos:"V√≠deos",
      focus_ads:"An√∫ncios (criativos)",
      focus_brand:"Branding (logo/identidade)",
      focus_site:"Site / landing",

      q_assets:"Voc√™ j√° tem materiais prontos?",
      as_yes:"Sim (logo/fotos/brand)",
      as_some:"Tenho algo, mas incompleto",
      as_no:"N√£o, preciso criar do zero",

      q_volume:"Volume aproximado",
      vol_low:"Pequeno (1‚Äì5 pe√ßas)",
      vol_mid:"M√©dio (6‚Äì15 pe√ßas)",
      vol_high:"Alto (15+ / premium)",

      q_budget:"Faixa de or√ßamento (aprox.)",
      bud_100:"At√© R$100",
      bud_300:"At√© R$300",
      bud_800:"At√© R$800",
      bud_more:"Acima de R$800",

      q_deadline:"Prazo desejado",
      dl_3:"At√© 3 dias",
      dl_7:"At√© 7 dias",
      dl_more:"Mais que 7 dias",

      q_pref:"Como prefere contratar?",
      pref_bundle:"Pacote (combos)",
      pref_single:"Avulso (1 servi√ßo)",
      pref_any:"Indiferente",

      resultsTitle:"Seu resultado",
      resultsSub:"Escolha um pacote pronto ou personalize selecionando servi√ßos.",
      pack_essential:"Essencial",
      pack_reco:"Recomendado",
      pack_scale:"Scale",
      badge_essential:"Come√ßar r√°pido",
      badge_reco:"Melhor custo-benef√≠cio",
      badge_scale:"M√°ximo impacto",
      selectPack:"Selecionar pacote",
      customize:"Personalizar servi√ßos",
      selected:"Selecionados",
      period:"Per√≠odo",
      savings:"economiza",
      goQuote:"Finalizar e ir para or√ßamento",
      copy:"Copiar resumo",
      copied:"Copiado!",
      notes:"Observa√ß√µes",
      estTotal:"Total estimado",
      comboHint:"2+ avulsos liberam desconto de combo (simulado)."
    },

    en: {
      heroBadge:"Quiz ‚Ä¢ Bundles ‚Ä¢ Combo savings",
      heroTitle:"Find the right package for your goal.",
      heroSub:"Answer in ~2 minutes. Then select services, see the estimated total, and go to a pre-filled quote page.",
      ctaStart:"Start",
      miniNoteTitle:"Comerc IAs",
      miniNoteText:"Pick a bundle or customize by selecting services.",
      b1t:"Straight to the point", b1s:"Objective questions to guide you to the best option.",
      b2t:"Ready bundles", b2s:"Essential ‚Ä¢ Recommended ‚Ä¢ Scale.",
      b3t:"Fast finish", b3s:"Go to the quote page with everything pre-filled.",
      previewTitle:"What you get", previewTime:"~2 min",
      p1t:"1) Diagnosis", p1s:"Goal, channel, volume, deadline and budget.",
      p2t:"2) 3 bundles", p2s:"Pick fast or customize.",
      p3t:"3) Savings", p3s:"Discount simulation when combining services.",
      dealTitle:"Combo (simulated)", dealText:"2 services: 5% ‚Ä¢ 3: 8% ‚Ä¢ 4+: 12%",
      footerLine:"*Prices and discounts are estimates to speed up decisions.",

      modalTitle:"Comerc IAs ‚Ä¢ Quote Quiz",
      modalSub:"Bundles + customization + pre-filled quote",
      sideTitle:"Summary",
      sideEmpty:"Answer to see recommendations.",
      simTitle:"Simulation",
      lblSub:"Subtotal (one-offs)",
      lblDisc:"Combo discount",
      lblPlans:"Plans",
      lblTotal:"Total",
      noteTotals:"*Estimate to speed up your decision.",
      sideStrategy:"Tip: the ‚ÄúRecommended‚Äù bundle is usually the best value.",

      back:"Back",
      next:"Continue",
      skip:"Skip",

      step:"Step",
      stepOf:"of",

      q_goal:"What's your main goal?",
      goal_sales:"Drive sales/conversions",
      goal_social:"Ongoing social content",
      goal_brand:"Strengthen brand/branding",
      goal_edu:"Educate/explain (technical)",

      q_channels:"Where will you publish?",
      ch_instagram:"Instagram (Feed/Reels/Stories)",
      ch_tiktok:"TikTok",
      ch_youtube:"YouTube Shorts",
      ch_whatsapp:"WhatsApp",
      ch_site:"Website / Landing page",
      ch_multi:"Multiple channels",

      q_focus:"What's the priority area now?",
      focus_auto:"I want recommendations",
      focus_images:"Images / creatives",
      focus_videos:"Videos",
      focus_ads:"Ads (creatives)",
      focus_brand:"Branding (logo/identity)",
      focus_site:"Website / landing",

      q_assets:"Do you have assets ready?",
      as_yes:"Yes (logo/photos/brand)",
      as_some:"Some, but incomplete",
      as_no:"No, need to build from scratch",

      q_volume:"Estimated volume",
      vol_low:"Small (1‚Äì5 items)",
      vol_mid:"Medium (6‚Äì15 items)",
      vol_high:"High (15+ / premium)",

      q_budget:"Budget range (approx.)",
      bud_100:"Up to R$100",
      bud_300:"Up to R$300",
      bud_800:"Up to R$800",
      bud_more:"Above R$800",

      q_deadline:"Desired deadline",
      dl_3:"Up to 3 days",
      dl_7:"Up to 7 days",
      dl_more:"More than 7 days",

      q_pref:"How do you prefer to hire?",
      pref_bundle:"Bundle (combos)",
      pref_single:"Single service",
      pref_any:"No preference",

      resultsTitle:"Your result",
      resultsSub:"Pick a ready bundle or customize by selecting services.",
      pack_essential:"Essential",
      pack_reco:"Recommended",
      pack_scale:"Scale",
      badge_essential:"Start fast",
      badge_reco:"Best value",
      badge_scale:"Max impact",
      selectPack:"Select bundle",
      customize:"Customize services",
      selected:"Selected",
      period:"Period",
      savings:"save",
      goQuote:"Finish and go to quote",
      copy:"Copy summary",
      copied:"Copied!",
      notes:"Notes",
      estTotal:"Estimated total",
      comboHint:"2+ one-offs unlock combo discount (simulated)."
    }
  };

  const $ = (id)=>document.getElementById(id);

  const modal = $('modal');
  const modalPanel = $('modalPanel');
  const screen = $('screen');
  const openModalBtn = $('openModal');
  const closeModalBtn = $('closeModal');
  const backdrop = $('backdrop');

  const backBtn = $('backBtn');
  const nextBtn = $('nextBtn');
  const skipBtn = $('skipBtn');

  const stepTitle = $('stepTitle');
  const stepMeta = $('stepMeta');
  const stepBar = $('stepBar');

  const sideSummary = $('sideSummary');
  const sideEmpty = $('sideEmpty');

  const vSub = $('vSub');
  const vDisc = $('vDisc');
  const vPlans = $('vPlans');
  const vTotal = $('vTotal');

  const langPTTop = $('langPTTop');
  const langENTop = $('langENTop');
  const langPT = $('langPT');
  const langEN = $('langEN');

  let lang = (localStorage.getItem('comercias_lang') || '').toLowerCase();
  if(lang !== 'pt' && lang !== 'en'){
    const nav = (navigator.language || 'pt').toLowerCase();
    lang = nav.startsWith('en') ? 'en' : 'pt';
  }
  const t = (k)=> I18N[lang]?.[k] ?? k;

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function money(n){
    const num = Number(n);
    if(!isFinite(num)) return '‚Äî';
    return new Intl.NumberFormat(lang==='en'?'en-US':'pt-BR',{style:'currency',currency:'BRL'}).format(num);
  }

  function showModal(){
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setTimeout(()=>modalPanel.classList.add('show'), 10);
  }
  function hideModal(){
    modalPanel.classList.remove('show');
    setTimeout(()=>{
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }, 150);
  }

  openModalBtn.addEventListener('click', showModal);
  closeModalBtn.addEventListener('click', hideModal);
  backdrop.addEventListener('click', hideModal);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && !modal.classList.contains('hidden')) hideModal(); });

  const allServices = [];
  CATALOG.categorias.forEach((cat)=>{
    (cat.servicos||[]).forEach((s, idx)=>{
      const isPlan = Array.isArray(s.precos_por_periodo) && s.precos_por_periodo.length;
      const minPrice = isPlan
        ? Number((s.precos_por_periodo.find(p=>String(p.periodo).toLowerCase().includes('mensal')) || s.precos_por_periodo[0]).preco_total_com_desc || 0)
        : Number(s.preco || 0);

      const text = [
        cat.nome, s.titulo||'', s.descricao||'', s.extras||'',
        (Array.isArray(s.inclui)?s.inclui.join(' '):''),
        (Array.isArray(s.beneficios)?s.beneficios.join(' '):'')
      ].join(' ').toLowerCase();

      allServices.push({
        ...s,
        __id: `${cat.nome}::${s.titulo || 'Servi√ßo'}::${idx}`,
        __cat: cat.nome,
        __isPlan: isPlan,
        __minPrice: isFinite(minPrice) ? minPrice : 0,
        __text: text
      });
    });
  });

  const state = {
    step: 0,
    answers: { goal:null, channels:[], focus:null, assets:null, volume:null, budget:null, deadline:null, pref:null },
    selected: new Map()
  };

  const steps = [
    {
      id:'goal', type:'single', titleKey:'q_goal', required:true,
      options: [
        { value:'sales', labelKey:'goal_sales', icon:'üíº' },
        { value:'social', labelKey:'goal_social', icon:'üìÖ' },
        { value:'brand', labelKey:'goal_brand', icon:'üß©' },
        { value:'edu', labelKey:'goal_edu', icon:'üìò' },
      ]
    },
    {
      id:'channels', type:'multi', titleKey:'q_channels', required:true, min:1,
      options: [
        { value:'instagram', labelKey:'ch_instagram' },
        { value:'tiktok', labelKey:'ch_tiktok' },
        { value:'youtube', labelKey:'ch_youtube' },
        { value:'whatsapp', labelKey:'ch_whatsapp' },
        { value:'site', labelKey:'ch_site' },
        { value:'multi', labelKey:'ch_multi' },
      ]
    },
    {
      id:'focus', type:'single', titleKey:'q_focus', required:true,
      options: [
        { value:'auto', labelKey:'focus_auto', icon:'üéØ' },
        { value:'images', labelKey:'focus_images', icon:'üñºÔ∏è' },
        { value:'videos', labelKey:'focus_videos', icon:'üé¨' },
        { value:'ads', labelKey:'focus_ads', icon:'üì£' },
        { value:'brand', labelKey:'focus_brand', icon:'üè∑Ô∏è' },
        { value:'site', labelKey:'focus_site', icon:'üåê' },
      ]
    },
    {
      id:'assets', type:'single', titleKey:'q_assets', required:true,
      options: [
        { value:'yes', labelKey:'as_yes', icon:'‚úÖ' },
        { value:'some', labelKey:'as_some', icon:'üü¶' },
        { value:'no', labelKey:'as_no', icon:'‚¨ú' },
      ]
    },
    {
      id:'volume', type:'single', titleKey:'q_volume', required:true,
      options: [
        { value:'low', labelKey:'vol_low', icon:'‚ë†' },
        { value:'mid', labelKey:'vol_mid', icon:'‚ë°' },
        { value:'high', labelKey:'vol_high', icon:'‚ë¢' },
      ]
    },
    {
      id:'budget', type:'single', titleKey:'q_budget', required:true,
      options: [
        { value:100, labelKey:'bud_100', icon:'‚óºÔ∏é' },
        { value:300, labelKey:'bud_300', icon:'‚óºÔ∏é‚óºÔ∏é' },
        { value:800, labelKey:'bud_800', icon:'‚óºÔ∏é‚óºÔ∏é‚óºÔ∏é' },
        { value:999999, labelKey:'bud_more', icon:'‚óºÔ∏é‚óºÔ∏é‚óºÔ∏é‚óºÔ∏é' },
      ]
    },
    {
      id:'deadline', type:'single', titleKey:'q_deadline', required:false, skippable:true,
      options: [
        { value:'3d', labelKey:'dl_3', icon:'‚è±Ô∏è' },
        { value:'7d', labelKey:'dl_7', icon:'üìÜ' },
        { value:'more', labelKey:'dl_more', icon:'üåø' },
      ]
    },
    {
      id:'pref', type:'single', titleKey:'q_pref', required:true,
      options: [
        { value:'bundle', labelKey:'pref_bundle', icon:'üì¶' },
        { value:'single', labelKey:'pref_single', icon:'üß©' },
        { value:'any', labelKey:'pref_any', icon:'‚öñÔ∏è' },
      ]
    }
  ];

  function comboPerc(qtd){
    if(qtd >= 4) return 12;
    if(qtd === 3) return 8;
    if(qtd === 2) return 5;
    return 0;
  }

  function scoreService(s){
    const a = state.answers;
    let score = 0;

    const budget = Number(a.budget || 999999);
    if(budget !== 999999 && s.__minPrice && s.__minPrice > budget) score -= 10;
    if(budget !== 999999 && s.__minPrice && s.__minPrice <= budget) score += 3;

    const cat = (s.__cat||'').toLowerCase();
    if(a.focus === 'images' && /imagens/.test(cat)) score += 8;
    if(a.focus === 'videos' && /v√≠deos|videos/.test(cat)) score += 8;
    if(a.focus === 'ads' && /avulsos/.test(cat)) score += 6;

    const txt = s.__text || '';
    if(a.goal === 'sales'){
      if(/an√∫nc|ads|promo|oferta|cta|copy|venda|convers/.test(txt)) score += 7;
      if(/v√≠deo|video/.test(txt)) score += 2;
    }
    if(a.goal === 'social'){
      if(s.__isPlan) score += 10;
      if(/imagem|imagens|v√≠deo|video|conte√∫do|reels|tiktok|shorts/.test(txt)) score += 5;
    }
    if(a.goal === 'brand'){
      if(/logo|identidade|marca|branding/.test(txt)) score += 9;
      if(/website|site|landing/.test(txt)) score += 3;
    }
    if(a.goal === 'edu'){
      if(/roteiro|narra√ß√£o|narracao|v√≠deo|video/.test(txt)) score += 7;
    }

    const ch = a.channels || [];
    if(ch.includes('site') && /website|site|landing/.test(txt)) score += 5;
    if((ch.includes('instagram')||ch.includes('tiktok')||ch.includes('youtube')||ch.includes('multi')) && /v√≠deo|video|imagem|reels|shorts|tiktok/.test(txt)) score += 2;
    if(ch.includes('whatsapp') && /imagem|banner|arte|imagens/.test(txt)) score += 2;

    if(a.assets === 'no'){
      if(/logo|identidade/.test(txt)) score += 6;
      if(/roteiro|copy/.test(txt)) score += 3;
    }
    if(a.assets === 'some'){
      if(/identidade|copy|roteiro/.test(txt)) score += 3;
    }

    if(!s.__isPlan){
      if(a.volume === 'low' && /(b√°sic|basic)/.test(txt)) score += 2;
      if(a.volume === 'mid' && /(profissional|professional)/.test(txt)) score += 2;
      if(a.volume === 'high' && /(premium)/.test(txt)) score += 2;
    }
    return score;
  }

  function topServices(limit=14){
    const budget = Number(state.answers.budget || 999999);
    const scored = allServices
      .map(s => ({ s, score: scoreService(s) }))
      .filter(x => budget === 999999 || !x.s.__minPrice || x.s.__minPrice <= budget || x.s.__isPlan)
      .sort((a,b)=> (b.score - a.score) || ((a.s.__minPrice||0) - (b.s.__minPrice||0)));
    const pos = scored.filter(x=>x.score > 0).map(x=>x.s);
    return (pos.length ? pos : scored.map(x=>x.s)).slice(0, limit);
  }

  function findByTitle(re){
    return allServices.find(s => re.test((s.titulo||'')+' '+(s.descricao||'')));
  }

  function buildPackages(list){
    const a = state.answers;

    const plan = list.find(s => s.__isPlan);
    const img = list.find(s => /imagens/i.test(s.__cat));
    const vid = list.find(s => /v√≠deos|videos/i.test(s.__cat));
    const logo = findByTitle(/\blogo\b/i);
    const idv  = findByTitle(/identidade/i);
    const ads  = findByTitle(/an√∫ncio|ads|pacote de an√∫ncios/i);
    const site = findByTitle(/website|site/i);
    const copy = findByTitle(/copy/i);
    const rot  = findByTitle(/roteiro/i);

    const essential = [];
    if(a.goal === 'social' && plan) essential.push({id: plan.__id, period: 'Mensal'});
    else {
      if(img) essential.push({id: img.__id});
      if((a.goal === 'sales' || a.goal === 'edu') && vid) essential.push({id: vid.__id});
      if(!essential.length && list[0]) essential.push({id: list[0].__id});
    }

    const recommended = [...essential];
    if(a.assets !== 'yes'){
      if(logo && !recommended.find(x=>x.id===logo.__id)) recommended.unshift({id: logo.__id});
      else if(idv && !recommended.find(x=>x.id===idv.__id)) recommended.unshift({id: idv.__id});
    }
    if(a.goal === 'sales'){
      if(ads && !recommended.find(x=>x.id===ads.__id)) recommended.push({id: ads.__id});
      if(copy && !recommended.find(x=>x.id===copy.__id)) recommended.push({id: copy.__id});
    }
    if(a.goal === 'edu'){
      if(rot && !recommended.find(x=>x.id===rot.__id)) recommended.push({id: rot.__id});
    }
    if((a.channels||[]).includes('site')){
      if(site && !recommended.find(x=>x.id===site.__id)) recommended.push({id: site.__id});
    }
    if(a.pref === 'bundle' && plan && !recommended.find(x=>x.id===plan.__id)) recommended.unshift({id: plan.__id, period:'Mensal'});

    const scale = [...recommended];
    list.slice(0, 8).forEach(s=>{
      if(scale.length >= 6) return;
      if(!scale.find(x=>x.id===s.__id)) scale.push({id: s.__id, period: s.__isPlan ? 'Mensal' : undefined});
    });

    return [
      { key:'essential', titleKey:'pack_essential', badgeKey:'badge_essential', items: essential },
      { key:'recommended', titleKey:'pack_reco', badgeKey:'badge_reco', items: recommended },
      { key:'scale', titleKey:'pack_scale', badgeKey:'badge_scale', items: scale }
    ];
  }

  function computeTotals(selectedMap){
    const selected = Array.from(selectedMap.values());
    const oneOff = [];
    const plans = [];

    selected.forEach(it=>{
      const s = allServices.find(x=>x.__id===it.id);
      if(!s) return;
      if(s.__isPlan) plans.push({s, period: it.period || 'Mensal'});
      else oneOff.push(s);
    });

    let subtotal = 0;
    oneOff.forEach(s=> subtotal += Number(s.preco || s.__minPrice || 0));

    const perc = comboPerc(oneOff.length);
    const disc = Math.round(subtotal * (perc/100) * 100)/100;

    let planTotal = 0;
    plans.forEach(({s, period})=>{
      const opt = (s.precos_por_periodo||[]).find(p => String(p.periodo).toLowerCase() === String(period).toLowerCase())
              || (s.precos_por_periodo||[])[0];
      planTotal += Number(opt?.preco_total_com_desc || s.__minPrice || 0);
    });

    const total = (subtotal - disc) + planTotal;
    return { subtotal, disc, planTotal, total, perc, count: selected.length, oneOffCount: oneOff.length };
  }

  function updateTotalsUI(){
    const tot = computeTotals(state.selected);
    vSub.textContent = money(tot.subtotal);
    vDisc.textContent = tot.disc ? `-${money(tot.disc)} (${tot.perc}%)` : '‚Äî';
    vPlans.textContent = tot.planTotal ? money(tot.planTotal) : '‚Äî';
    vTotal.textContent = money(tot.total);
  }

  function renderSideSummary(){
    const a = state.answers;
    const lines = [];

    const label = (kPt, kEn)=> (lang==='en'?kEn:kPt);

    if(a.goal) lines.push([label('Objetivo','Goal'), a.goal]);
    if(a.channels?.length) lines.push([label('Canais','Channels'), a.channels.join(', ')]);
    if(a.focus) lines.push([label('Prioridade','Priority'), a.focus]);
    if(a.assets) lines.push([label('Materiais','Assets'), a.assets]);
    if(a.volume) lines.push([label('Volume','Volume'), a.volume]);
    if(a.budget) lines.push([label('Or√ßamento','Budget'), `R$${a.budget}`]);
    if(a.deadline) lines.push([label('Prazo','Deadline'), a.deadline]);
    if(a.pref) lines.push([label('Prefer√™ncia','Preference'), a.pref]);

    if(!lines.length){
      sideSummary.innerHTML = `<div class="text-slate-500">${escapeHtml(t('sideEmpty'))}</div>`;
      return;
    }

    sideSummary.innerHTML = `
      <div class="space-y-2">
        ${lines.map(([k,v])=>`
          <div class="flex justify-between gap-3">
            <span class="text-slate-500">${escapeHtml(k)}</span>
            <span class="text-slate-900 font-semibold text-right">${escapeHtml(String(v))}</span>
          </div>
        `).join('')}
      </div>
    `;
  }

  function setStepUI(){
    const total = steps.length + 1;
    const current = Math.min(state.step + 1, total);
    const pct = Math.round(((current-1)/(total-1))*100);

    stepTitle.textContent = `${t('step')} ${current} ${t('stepOf')} ${total}`;
    stepMeta.textContent = `${current}/${total}`;
    stepBar.style.width = `${pct}%`;

    backBtn.classList.toggle('hidden', state.step === 0);
    skipBtn.classList.toggle('hidden', !(steps[state.step]?.skippable));
    skipBtn.textContent = t('skip');
    backBtn.textContent = t('back');
    nextBtn.textContent = t('next');
  }

  function setScreen(html){
    screen.innerHTML = html;
    const el = screen.querySelector('.fade');
    if(el) setTimeout(()=>el.classList.add('show'), 10);
  }

  function canProceed(){
    if(state.step >= steps.length) return true;
    const st = steps[state.step];
    const v = state.answers[st.id];
    if(st.type === 'single') return v !== null && v !== undefined;
    if(st.type === 'multi') return Array.isArray(v) && v.length >= (st.min || 1);
    return true;
  }

  function renderCurrent(){
    setStepUI();
    renderSideSummary();
    updateTotalsUI();

    if(state.step >= steps.length){
      renderResults();
      return;
    }

    const st = steps[state.step];
    const title = t(st.titleKey);

    if(st.type === 'single'){
      const active = state.answers[st.id];
      setScreen(`
        <div class="fade">
          <div class="mb-4">
            <div class="text-slate-900 font-extrabold text-2xl tracking-tight">${escapeHtml(title)}</div>
            <div class="text-slate-600 text-sm mt-1">${escapeHtml(lang==='en' ? 'Pick one option to continue.' : 'Escolha uma op√ß√£o para continuar.')}</div>
          </div>

          <div class="grid gap-3">
            ${st.options.map(o=>{
              const isActive = String(active) === String(o.value);
              return `
                <button class="opt ${isActive?'active':''} ring-focus w-full text-left rounded-3xl px-4 py-4" data-val="${escapeHtml(o.value)}">
                  <div class="flex items-start justify-between gap-3">
                    <div class="flex items-start gap-3">
                      ${o.icon ? `<div class="h-10 w-10 rounded-2xl bg-blue-50 border border-blue-200 flex items-center justify-center text-blue-900 font-extrabold">${escapeHtml(o.icon)}</div>` : ``}
                      <div>
                        <div class="font-extrabold text-slate-900">${escapeHtml(t(o.labelKey))}</div>
                        <div class="text-sm text-slate-600 mt-1">${escapeHtml(lang==='en' ? 'Tap to select' : 'Toque para selecionar')}</div>
                      </div>
                    </div>
                    <span class="text-slate-400 mt-1">‚Üí</span>
                  </div>
                </button>
              `;
            }).join('')}
          </div>

          <div class="mt-4 text-xs text-slate-500">${escapeHtml(CATALOG.observacoes || '')}</div>
        </div>
      `);

      screen.querySelectorAll('button[data-val]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const val = btn.dataset.val;
          state.answers[st.id] = isNaN(Number(val)) ? val : Number(val);
          nextBtn.disabled = !canProceed();
          renderCurrent();
        });
      });
    }

    if(st.type === 'multi'){
      const current = Array.isArray(state.answers[st.id]) ? state.answers[st.id] : [];
      const min = st.min || 1;

      setScreen(`
        <div class="fade">
          <div class="mb-4">
            <div class="text-slate-900 font-extrabold text-2xl tracking-tight">${escapeHtml(title)}</div>
            <div class="text-slate-600 text-sm mt-1">${escapeHtml(lang==='en' ? `Select at least ${min}.` : `Selecione pelo menos ${min}.`)}</div>
          </div>

          <div class="flex flex-wrap gap-2.5">
            ${st.options.map(o=>{
              const isActive = current.includes(o.value);
              return `
                <button type="button" class="chip ${isActive?'active':''} ring-focus px-4 py-3 rounded-2xl text-sm font-bold" data-val="${escapeHtml(o.value)}">
                  ${escapeHtml(t(o.labelKey))}
                </button>
              `;
            }).join('')}
          </div>

          <div class="mt-5 rounded-2xl bg-blue-50 border border-blue-200 p-4 flex items-center justify-between">
            <div class="text-sm text-slate-700">
              <span class="font-extrabold text-slate-900">${escapeHtml(t('selected'))}</span>: ${current.length}
              <span class="text-slate-400">‚Ä¢</span>
              <span class="text-slate-600">${escapeHtml(t('comboHint'))}</span>
            </div>
            <div class="text-xs text-slate-500">${escapeHtml(lang==='en'?'You can pick multiple':'Voc√™ pode escolher v√°rios')}</div>
          </div>
        </div>
      `);

      screen.querySelectorAll('button[data-val]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const val = btn.dataset.val;
          let cur = Array.isArray(state.answers[st.id]) ? [...state.answers[st.id]] : [];
          if(cur.includes(val)) cur = cur.filter(x=>x!==val);
          else cur.push(val);
          state.answers[st.id] = cur;
          nextBtn.disabled = !canProceed();
          renderCurrent();
        });
      });
    }

    nextBtn.disabled = !canProceed();
  }

  function buildSummaryText(){
    const a = state.answers;
    const tot = computeTotals(state.selected);

    const linesPt = [
      `- Comerc IAs`,
      `- Objetivo: ${a.goal}`,
      `- Canais: ${(a.channels||[]).join(', ')}`,
      `- Prioridade: ${a.focus}`,
      `- Materiais: ${a.assets}`,
      `- Volume: ${a.volume}`,
      `- Or√ßamento: R$${a.budget}`,
      `- Prazo: ${a.deadline || '‚Äî'}`,
      `- Prefer√™ncia: ${a.pref}`,
      `- Total estimado: ${money(tot.total)}`
    ];

    const linesEn = [
      `- Comerc IAs`,
      `- Goal: ${a.goal}`,
      `- Channels: ${(a.channels||[]).join(', ')}`,
      `- Priority: ${a.focus}`,
      `- Assets: ${a.assets}`,
      `- Volume: ${a.volume}`,
      `- Budget: R$${a.budget}`,
      `- Deadline: ${a.deadline || '‚Äî'}`,
      `- Preference: ${a.pref}`,
      `- Estimated total: ${money(tot.total)}`
    ];

    return (lang==='en'?linesEn:linesPt).join('\n');
  }

  function serviceCardHTML(s, checked){
    const priceLabel = s.__isPlan ? money(s.__minPrice) : money(s.preco || s.__minPrice || 0);
    const periodSel = (s.__isPlan && checked)
      ? `
        <div class="mt-3">
          <label class="text-xs text-slate-600">${escapeHtml(t('period'))}</label>
          <select class="planPeriod ring-focus mt-1 w-full border border-blue-200 bg-white rounded-2xl px-3 py-2.5 text-sm text-slate-900" data-id="${escapeHtml(s.__id)}">
            ${(s.precos_por_periodo||[]).map(p=>{
              const cur = state.selected.get(s.__id)?.period || 'Mensal';
              const selected = String(cur).toLowerCase() === String(p.periodo).toLowerCase() ? 'selected' : '';
              const econ = Math.max(0, Number(p.preco_total_sem_desc||0) - Number(p.preco_total_com_desc||0));
              const econTxt = econ>0 ? ` ‚Ä¢ ${t('savings')} ${money(econ)}` : '';
              return `<option value="${escapeHtml(p.periodo)}" ${selected}>${escapeHtml(p.periodo)} ‚Äî ${money(p.preco_total_com_desc)}${econTxt}</option>`;
            }).join('')}
          </select>
        </div>
      ` : '';

    return `
      <label class="rounded-3xl border border-blue-200 bg-white hover:bg-blue-50 transition-all p-4 flex gap-3 shadow-soft">
        <input type="checkbox" class="svcCheck mt-1.5 h-4 w-4 accent-blue-600" data-id="${escapeHtml(s.__id)}" ${checked?'checked':''}>
        <div class="flex-1">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-extrabold text-slate-900">${escapeHtml(s.titulo || 'Servi√ßo')}</div>
              <div class="text-xs text-slate-500 mt-0.5">${escapeHtml(s.__cat)}</div>
            </div>
            <div class="text-blue-800 font-extrabold whitespace-nowrap">${escapeHtml(priceLabel)}</div>
          </div>
          <div class="mt-2 text-sm text-slate-700">${escapeHtml((s.descricao||''))}</div>
          ${s.extras ? `<div class="mt-2 text-xs text-slate-600">${escapeHtml(s.extras)}</div>` : ''}
          ${periodSel}
        </div>
      </label>
    `;
  }

  function renderResults(){
    if(state.selected.size === 0){
      const list = topServices(16);
      const packs = buildPackages(list);
      (packs.find(p=>p.key==='recommended') || packs[0]).items.forEach(it=>{
        state.selected.set(it.id, { id: it.id, period: it.period });
      });
    }

    const list = topServices(18);
    const packs = buildPackages(list);

    const tot = computeTotals(state.selected);

    const packCards = packs.map(p=>{
      const temp = new Map();
      p.items.forEach(it=> temp.set(it.id, {id:it.id, period: it.period}));
      const tp = computeTotals(temp);
      const badgeKey = p.key==='essential'?'badge_essential':(p.key==='recommended'?'badge_reco':'badge_scale');
      const highlight = p.key==='recommended';

      return `
        <div class="rounded-3xl p-4 md:p-5 border ${highlight ? 'border-blue-400 bg-blue-50' : 'border-blue-200 bg-white'} shadow-soft">
          <div class="flex items-center justify-between gap-3">
            <div class="text-lg font-extrabold text-slate-900">${escapeHtml(t(p.titleKey))}</div>
            <span class="text-xs px-2 py-1 rounded-full border border-blue-200 bg-white text-blue-900 font-semibold">${escapeHtml(t(badgeKey))}</span>
          </div>

          <div class="mt-3 space-y-1">
            ${p.items.slice(0,6).map(it=>{
              const s = allServices.find(x=>x.__id===it.id);
              if(!s) return '';
              return `<div class="text-sm text-slate-700">‚Ä¢ ${escapeHtml(s.titulo)}</div>`;
            }).join('')}
          </div>

          <div class="mt-4 flex items-end justify-between gap-3">
            <div>
              <div class="text-xs text-slate-500">${escapeHtml(t('estTotal'))}</div>
              <div class="text-xl font-extrabold text-blue-800">${money(tp.total)}</div>
              <div class="text-xs text-slate-500">${tp.disc ? `-${money(tp.disc)} combo` : '‚Äî'}</div>
            </div>
            <button class="pickPack ring-focus px-4 py-2.5 rounded-2xl font-extrabold ${highlight ? 'btn-primary' : 'btn-ghost'}"
              data-pack="${escapeHtml(p.key)}">
              ${escapeHtml(t('selectPack'))}
            </button>
          </div>
        </div>
      `;
    }).join('');

    const selectedIds = new Set(Array.from(state.selected.keys()));
    const curated = [
      ...allServices.filter(s=>selectedIds.has(s.__id)),
      ...list.filter(s=>!selectedIds.has(s.__id))
    ].slice(0, 16);

    const servicesHTML = curated.map(s=>{
      const checked = state.selected.has(s.__id);
      return serviceCardHTML(s, checked);
    }).join('');

    setScreen(`
      <div class="fade">
        <div class="flex items-start justify-between gap-3 mb-5">
          <div>
            <div class="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-900">${escapeHtml(t('resultsTitle'))}</div>
            <div class="text-slate-600 text-sm mt-1">${escapeHtml(t('resultsSub'))}</div>
          </div>
          <button id="restart" class="ring-focus px-4 py-2.5 rounded-2xl btn-ghost font-extrabold">${escapeHtml(lang==='en'?'Restart':'Refazer')}</button>
        </div>

        <div class="grid md:grid-cols-3 gap-3 mb-6">
          ${packCards}
        </div>

        <div class="flex items-center justify-between gap-3 mb-3">
          <div class="text-slate-900 font-extrabold text-lg">${escapeHtml(t('customize'))}</div>
          <div class="text-xs text-slate-500">${escapeHtml(t('comboHint'))}</div>
        </div>

        <div id="svcList" class="grid gap-3 mb-6">
          ${servicesHTML}
        </div>

        <div class="rounded-3xl border border-blue-200 bg-white p-4 md:p-5 mb-4 shadow-soft">
          <div class="text-slate-900 font-extrabold mb-2">${escapeHtml(lang==='en'?'Summary (goes to quote)':'Resumo (vai pro or√ßamento)')}</div>
          <pre id="summaryText" class="whitespace-pre-wrap text-sm text-slate-700">${escapeHtml(buildSummaryText())}</pre>
          <div class="mt-3 text-xs text-slate-500">${escapeHtml(t('notes'))}: ${escapeHtml(CATALOG.observacoes || '')}</div>
        </div>

        <div class="stickyMobileBar rounded-3xl p-4 md:hidden">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xs text-slate-500">${escapeHtml(t('selected'))}: <span id="mCount" class="text-slate-900 font-extrabold">${tot.count}</span></div>
              <div class="text-lg font-extrabold text-blue-800" id="mTotal">${money(tot.total)}</div>
            </div>
            <button id="goQuoteMobile" class="ring-focus btn-primary px-4 py-3 rounded-2xl font-extrabold">${escapeHtml(t('goQuote'))}</button>
          </div>
        </div>

        <div class="hidden md:flex gap-3">
          <button id="copySummary" class="ring-focus btn-ghost px-6 py-3.5 rounded-2xl font-extrabold">${escapeHtml(t('copy'))}</button>
          <button id="goQuote" class="ring-focus btn-primary flex-1 px-6 py-3.5 rounded-2xl font-extrabold">${escapeHtml(t('goQuote'))}</button>
        </div>

        <div class="md:hidden h-2"></div>
      </div>
    `);

    backBtn.classList.remove('hidden');
    skipBtn.classList.add('hidden');
    nextBtn.textContent = lang==='en' ? 'Back to edit' : 'Voltar para editar';
    nextBtn.disabled = false;

    $('restart').addEventListener('click', ()=>{
      state.step = 0;
      state.answers = { goal:null, channels:[], focus:null, assets:null, volume:null, budget:null, deadline:null, pref:null };
      state.selected.clear();
      renderCurrent();
    });

    screen.querySelectorAll('.pickPack').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const key = btn.dataset.pack;
        const pack = packs.find(p=>p.key===key);
        if(!pack) return;
        state.selected.clear();
        pack.items.forEach(it=> state.selected.set(it.id, {id:it.id, period:it.period}));
        updateTotalsUI();
        renderSideSummary();
        renderResults();
      });
    });

    screen.querySelectorAll('.svcCheck').forEach(ch=>{
      ch.addEventListener('change', ()=>{
        const id = ch.dataset.id;
        if(ch.checked) state.selected.set(id, {id, period: 'Mensal'});
        else state.selected.delete(id);

        updateTotalsUI();
        renderSideSummary();

        const newTot = computeTotals(state.selected);
        const mCount = $('mCount'); const mTotal = $('mTotal');
        if(mCount) mCount.textContent = newTot.count;
        if(mTotal) mTotal.textContent = money(newTot.total);

        const st = $('summaryText');
        if(st) st.textContent = buildSummaryText();

        const s = allServices.find(x=>x.__id===id);
        if(s?.__isPlan) renderResults();
      });
    });

    screen.querySelectorAll('.planPeriod').forEach(sel=>{
      sel.addEventListener('change', ()=>{
        const id = sel.dataset.id;
        const it = state.selected.get(id);
        if(it){ it.period = sel.value; state.selected.set(id, it); }
        updateTotalsUI();
        const st = $('summaryText');
        if(st) st.textContent = buildSummaryText();
      });
    });

    const copyBtn = $('copySummary');
    if(copyBtn){
      copyBtn.addEventListener('click', async ()=>{
        try{
          await navigator.clipboard.writeText(buildSummaryText());
          copyBtn.textContent = t('copied');
          setTimeout(()=>copyBtn.textContent = t('copy'), 1100);
        }catch(e){
          alert(lang==='en' ? 'Copy failed. Please select and copy manually.' : 'Falha ao copiar. Selecione e copie manualmente.');
        }
      });
    }

    function goToQuote(){
      const summary = buildSummaryText();
      const selectedDetail = Array.from(state.selected.values()).map(it=>{
        const s = allServices.find(x=>x.__id===it.id);
        if(!s) return null;

        let price = s.__minPrice;
        if(s.__isPlan){
          const opt = (s.precos_por_periodo||[]).find(p=>String(p.periodo).toLowerCase()===String(it.period||'Mensal').toLowerCase())
                  || (s.precos_por_periodo||[])[0];
          price = Number(opt?.preco_total_com_desc || s.__minPrice || 0);
        } else {
          price = Number(s.preco || s.__minPrice || 0);
        }

        return {
          category: s.__cat,
          title: s.titulo,
          kind: s.__isPlan ? 'plan' : 'one_off',
          period: s.__isPlan ? (it.period || 'Mensal') : undefined,
          price
        };
      }).filter(Boolean);

      const base = (lang==='en')
        ? 'https://www.comercias.com.br/en/orcamento'
        : 'https://www.comercias.com.br/pt/orcamento';

      const encodedResumo = encodeURIComponent(summary);
      const encodedServices = encodeURIComponent(JSON.stringify(selectedDetail));
      const totalsPayload = computeTotals(state.selected);
      const encodedTotals = encodeURIComponent(JSON.stringify(totalsPayload));

      window.location.href = `${base}?servicos=${encodedServices}&resumo=${encodedResumo}&totais=${encodedTotals}`;
    }

    const goBtn = $('goQuote');
    if(goBtn) goBtn.addEventListener('click', goToQuote);
    const goBtnM = $('goQuoteMobile');
    if(goBtnM) goBtnM.addEventListener('click', goToQuote);
  }

  backBtn.addEventListener('click', ()=>{
    if(state.step > 0){
      state.step -= 1;
      renderCurrent();
    }
  });

  skipBtn.addEventListener('click', ()=>{
    const st = steps[state.step];
    if(st?.skippable){
      state.answers[st.id] = null;
      state.step += 1;
      renderCurrent();
    }
  });

  nextBtn.addEventListener('click', ()=>{
    if(state.step >= steps.length){
      state.step = steps.length - 1;
      renderCurrent();
      return;
    }
    if(!canProceed()) return;

    state.step += 1;

    if(state.step === steps.length){
      if(state.selected.size === 0){
        const list = topServices(16);
        const packs = buildPackages(list);
        (packs.find(p=>p.key==='recommended') || packs[0]).items.forEach(it=>{
          state.selected.set(it.id, {id:it.id, period:it.period});
        });
      }
    }
    renderCurrent();
  });

  function canProceed(){
    if(state.step >= steps.length) return true;
    const st = steps[state.step];
    const v = state.answers[st.id];
    if(st.type === 'single') return v !== null && v !== undefined;
    if(st.type === 'multi') return Array.isArray(v) && v.length >= (st.min || 1);
    return true;
  }

  function applyCopy(){
    $('heroBadge').textContent = t('heroBadge');
    $('heroTitle').textContent = t('heroTitle');
    $('heroSub').textContent = t('heroSub');
    $('ctaStart').textContent = t('ctaStart');
    $('miniNoteTitle').textContent = t('miniNoteTitle');
    $('miniNoteText').textContent = t('miniNoteText');

    $('b1t').textContent = t('b1t'); $('b1s').textContent = t('b1s');
    $('b2t').textContent = t('b2t'); $('b2s').textContent = t('b2s');
    $('b3t').textContent = t('b3t'); $('b3s').textContent = t('b3s');

    $('previewTitle').textContent = t('previewTitle');
    $('previewTime').textContent = t('previewTime');
    $('p1t').textContent = t('p1t'); $('p1s').textContent = t('p1s');
    $('p2t').textContent = t('p2t'); $('p2s').textContent = t('p2s');
    $('p3t').textContent = t('p3t'); $('p3s').textContent = t('p3s');
    $('dealTitle').textContent = t('dealTitle');
    $('dealText').textContent = t('dealText');
    $('footerLine').textContent = t('footerLine');

    $('modalTitle').textContent = t('modalTitle');
    $('modalSub').textContent = t('modalSub');
    $('sideTitle').textContent = t('sideTitle');
    $('sideEmpty').textContent = t('sideEmpty');
    $('simTitle').textContent = t('simTitle');
    $('lblSub').textContent = t('lblSub');
    $('lblDisc').textContent = t('lblDisc');
    $('lblPlans').textContent = t('lblPlans');
    $('lblTotal').textContent = t('lblTotal');
    $('noteTotals').textContent = t('noteTotals');
    $('sideStrategy').textContent = t('sideStrategy');

    backBtn.textContent = t('back');
    nextBtn.textContent = t('next');
    skipBtn.textContent = t('skip');
  }

  function setLang(newLang){
    lang = newLang;
    localStorage.setItem('comercias_lang', newLang);
    document.documentElement.lang = (newLang === 'en') ? 'en' : 'pt-BR';

    langPTTop.classList.toggle('bg-blue-50', newLang==='pt');
    langENTop.classList.toggle('bg-blue-50', newLang==='en');
    langPTTop.classList.toggle('text-slate-600', newLang!=='pt');
    langENTop.classList.toggle('text-slate-600', newLang!=='en');

    langPT.classList.toggle('bg-blue-50', newLang==='pt');
    langEN.classList.toggle('bg-blue-50', newLang==='en');
    langPT.classList.toggle('text-slate-600', newLang!=='pt');
    langEN.classList.toggle('text-slate-600', newLang!=='en');

    applyCopy();
    renderCurrent();
  }

  langPTTop.addEventListener('click', ()=>setLang('pt'));
  langENTop.addEventListener('click', ()=>setLang('en'));
  langPT.addEventListener('click', ()=>setLang('pt'));
  langEN.addEventListener('click', ()=>setLang('en'));

  applyCopy();
  setLang(lang);
  renderCurrent();

})();
</script>
</body>
</html>
