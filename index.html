<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Comerc IAs — Quiz de Orçamento</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Sora:wght@500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Brand blues */
      --b950:#04142f;
      --b900:#062352;
      --b800:#0A2E6B;
      --b700:#0B46B0;
      --b650:#0B56E8;
      --b600:#0B5FFF;
      --b500:#2E7BFF;
      --b100:#EAF2FF;

      /* LIGHT (default) */
      --bgA:#F7FBFF;
      --bgB:#FFFFFF;
      --grid: rgba(11,95,255,.06);

      --surface: rgba(255,255,255,.78);
      --surface2: rgba(255,255,255,.92);
      --stroke: rgba(11,95,255,.14);

      --text: rgba(6,35,82,1);
      --muted: rgba(6,35,82,.64);
      --shadow1: rgba(6,35,82,.16);
      --shadow2: rgba(6,35,82,.10);

      --soft1: rgba(6,35,82,.08);
      --soft2: rgba(6,35,82,.06);

      --divider: rgba(11,95,255,.20);
      --focus: rgba(11,95,255,.18);

      --pillBg: rgba(255,255,255,.72);
      --pillStroke: rgba(11,95,255,.16);

      --btnGhostBg: rgba(255,255,255,.62);
      --btnGhostStroke: rgba(11,95,255,.18);

      --chipBg: rgba(11,95,255,.08);
      --chipText: rgba(11,95,255,1);

      --scrollThumb: rgba(11,95,255,.18);
      --scrollTrack: rgba(11,95,255,.05);

      --ok: rgba(19, 190, 115, 1);
      --okBg: rgba(19, 190, 115, .10);
      --warn: rgba(255, 145, 0, 1);
      --warnBg: rgba(255, 145, 0, .10);
    }

    [data-theme="dark"]{
      --bgA: #04142f;
      --bgB: #031029;
      --grid: rgba(234,242,255,.07);

      --surface: rgba(4,20,47,.76);
      --surface2: rgba(4,20,47,.88);
      --stroke: rgba(234,242,255,.12);

      --text: rgba(234,242,255,1);
      --muted: rgba(234,242,255,.72);
      --shadow1: rgba(0,0,0,.45);
      --shadow2: rgba(0,0,0,.28);

      --soft1: rgba(0,0,0,.30);
      --soft2: rgba(0,0,0,.20);

      --divider: rgba(234,242,255,.14);
      --focus: rgba(234,242,255,.14);

      --pillBg: rgba(4,20,47,.70);
      --pillStroke: rgba(234,242,255,.12);

      --btnGhostBg: rgba(4,20,47,.72);
      --btnGhostStroke: rgba(234,242,255,.12);

      --chipBg: rgba(46,123,255,.16);
      --chipText: rgba(234,242,255,1);

      --scrollThumb: rgba(234,242,255,.16);
      --scrollTrack: rgba(234,242,255,.06);

      --ok: rgba(90, 220, 160, 1);
      --okBg: rgba(90, 220, 160, .12);
      --warn: rgba(255, 175, 45, 1);
      --warnBg: rgba(255, 175, 45, .12);
    }

    html,body{ height:100%; }
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1100px 680px at 14% 10%, rgba(11,95,255,.14), transparent 55%),
        radial-gradient(900px 520px at 92% 0%, rgba(11,95,255,.10), transparent 50%),
        linear-gradient(180deg, var(--bgA), var(--bgB) 55%);
    }
    [data-theme="dark"] body{
      background:
        radial-gradient(1100px 680px at 14% 12%, rgba(11,95,255,.22), transparent 55%),
        radial-gradient(900px 520px at 90% 0%, rgba(11,95,255,.14), transparent 50%),
        radial-gradient(700px 420px at 50% 110%, rgba(46,123,255,.10), transparent 55%),
        linear-gradient(180deg, var(--bgA), var(--bgB) 55%);
    }

    h1,h2,h3,.font-display{ font-family: Sora, Inter, system-ui, sans-serif; }

    .bg-grid{
      background-image:
        linear-gradient(to right, var(--grid) 1px, transparent 1px),
        linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
      background-size: 56px 56px;
      background-position: center;
      mask-image: radial-gradient(circle at 50% 10%, black 42%, transparent 82%);
    }

    .shell{
      position: relative;
      border-radius: 26px;
      background: var(--surface);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border: 1px solid rgba(11,95,255,.06);
      box-shadow: 0 26px 70px var(--shadow1), 0 8px 22px var(--shadow2);
      overflow: hidden;
    }
    [data-theme="dark"] .shell{ border: 1px solid rgba(234,242,255,.06); }

    .shell::before{
      content:"";
      position:absolute;
      inset:0;
      padding:1px;
      border-radius: 26px;
      background: linear-gradient(135deg, rgba(11,95,255,.55), rgba(255,255,255,.12), rgba(11,95,255,.22));
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
    }
    [data-theme="dark"] .shell::before{
      background: linear-gradient(135deg, rgba(11,95,255,.60), rgba(234,242,255,.10), rgba(11,95,255,.28));
    }

    .card{
      border-radius: 20px;
      border: 1px solid var(--stroke);
      background: var(--surface2);
      box-shadow: 0 12px 30px var(--soft1);
    }

    .divider{
      height:1px;
      background: linear-gradient(90deg, transparent, var(--divider), transparent);
    }

    .btn{
      border-radius: 16px;
      transition: transform .12s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease, color .18s ease, opacity .18s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn:focus{ outline:none; box-shadow: 0 0 0 5px var(--focus); }
    .btn:focus-visible{ outline:none; box-shadow: 0 0 0 5px var(--focus); }

    .btn-primary{
      background: linear-gradient(180deg, rgba(11,95,255,1), rgba(10,72,190,1));
      box-shadow: 0 14px 30px rgba(11,95,255,.22);
      color:#fff;
    }
    .btn-primary:hover{ box-shadow: 0 18px 40px rgba(11,95,255,.26); filter: saturate(1.05); }

    .btn-ghost{
      background: var(--btnGhostBg);
      border: 1px solid var(--btnGhostStroke);
      color: rgba(11,95,255,1);
    }
    [data-theme="dark"] .btn-ghost{ color: rgba(234,242,255,.92); }

    .btn-danger{
      background: rgba(255, 59, 48, .10);
      border: 1px solid rgba(255, 59, 48, .22);
      color: rgba(255, 59, 48, 1);
    }
    [data-theme="dark"] .btn-danger{
      background: rgba(255, 59, 48, .14);
      border: 1px solid rgba(255, 59, 48, .26);
    }

    .pill{
      border-radius: 999px;
      border: 1px solid var(--pillStroke);
      background: var(--pillBg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      color: var(--muted);
    }

    .chip{
      border-radius: 999px;
      background: var(--chipBg);
      color: var(--chipText);
      border: 1px solid rgba(11,95,255,.14);
    }
    [data-theme="dark"] .chip{ border: 1px solid rgba(234,242,255,.12); }

    /* Options */
    .option{
      border-radius: 20px;
      border: 1px solid rgba(11,95,255,.16);
      background: var(--surface2);
      box-shadow: 0 10px 24px var(--soft2);
      transition: transform .12s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
      position: relative;
    }
    [data-theme="dark"] .option{
      border: 1px solid rgba(234,242,255,.12);
      background: rgba(4,20,47,.84);
      box-shadow: 0 16px 36px rgba(0,0,0,.25);
    }
    .option:hover{
      transform: translateY(-2px);
      border-color: rgba(11,95,255,.30);
      box-shadow: 0 18px 40px var(--soft1);
    }
    [data-theme="dark"] .option:hover{
      border-color: rgba(46,123,255,.38);
      box-shadow: 0 18px 46px rgba(0,0,0,.34);
    }

    .option.selected{
      border-color: rgba(11,95,255,.55);
      box-shadow: 0 18px 44px rgba(11,95,255,.18);
      background:
        radial-gradient(700px 220px at 20% 0%, rgba(11,95,255,.12), transparent 55%),
        var(--surface2);
    }
    [data-theme="dark"] .option.selected{
      border-color: rgba(46,123,255,.62);
      box-shadow: 0 18px 46px rgba(0,0,0,.34);
      background:
        radial-gradient(700px 240px at 20% 0%, rgba(46,123,255,.16), transparent 58%),
        rgba(4,20,47,.88);
    }

    .check-dot{
      width: 12px; height: 12px; border-radius: 999px;
      background: rgba(11,95,255,.18);
      border: 1px solid rgba(11,95,255,.20);
    }
    .option.selected .check-dot{
      background: rgba(11,95,255,1);
      border-color: rgba(255,255,255,.65);
      box-shadow: 0 0 0 6px rgba(11,95,255,.12);
    }

    .fade{ opacity:0; transform: translateY(10px); transition: all .28s ease; }
    .fade.show{ opacity:1; transform: translateY(0); }

    .scrollbar::-webkit-scrollbar{ width: 10px; height:10px; }
    .scrollbar::-webkit-scrollbar-thumb{ background: var(--scrollThumb); border-radius: 999px; border: 2px solid rgba(255,255,255,.6); }
    [data-theme="dark"] .scrollbar::-webkit-scrollbar-thumb{ border: 2px solid rgba(4,20,47,.8); }
    .scrollbar::-webkit-scrollbar-track{ background: var(--scrollTrack); border-radius: 999px; }

    /* Floating bar */
    .floating{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 50;
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 10px;
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: var(--surface);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 18px 46px var(--shadow2);
    }
    .floating a, .floating button{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(11,95,255,.18);
      background: rgba(255,255,255,.70);
      color: var(--text);
      font-weight: 800;
      font-family: Sora, Inter, system-ui, sans-serif;
      font-size: 13px;
      letter-spacing: -.01em;
      transition: transform .12s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
      white-space: nowrap;
    }
    [data-theme="dark"] .floating a, [data-theme="dark"] .floating button{
      background: rgba(4,20,47,.82);
      border: 1px solid rgba(234,242,255,.12);
      color: var(--text);
    }
    .floating a:hover, .floating button:hover{
      transform: translateY(-2px);
      border-color: rgba(11,95,255,.34);
      box-shadow: 0 16px 40px var(--soft1);
    }
    [data-theme="dark"] .floating a:hover, [data-theme="dark"] .floating button:hover{
      border-color: rgba(46,123,255,.38);
      box-shadow: 0 18px 46px rgba(0,0,0,.34);
    }
    .floating .mini{
      width: 36px;
      height: 36px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(11,95,255,.10);
      border: 1px solid rgba(11,95,255,.12);
    }
    [data-theme="dark"] .floating .mini{
      background: rgba(46,123,255,.12);
      border: 1px solid rgba(234,242,255,.10);
    }
    .floating .primary{
      background: linear-gradient(180deg, rgba(11,95,255,1), rgba(10,72,190,1));
      color:#fff;
      border-color: rgba(11,95,255,.28);
      box-shadow: 0 12px 26px rgba(11,95,255,.22);
    }
    .floating .primary .mini{
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.18);
    }
    .floating .primary:hover{ box-shadow: 0 18px 40px rgba(11,95,255,.26); }

    @media (max-width: 640px){
      .floating{
        left: 12px;
        right: 12px;
        bottom: 12px;
        border-radius: 22px;
        justify-content: space-between;
        padding: 10px;
      }
      .floating a, .floating button{
        flex: 1;
        justify-content: center;
        padding: 12px 10px;
        font-size: 13px;
      }
      .floating .mini{ width: 34px; height: 34px; border-radius: 14px; }
      body{ padding-bottom: 96px; }
    }

    .i{ width: 18px; height: 18px; }
    .muted{ color: var(--muted); }

    /* Sticky internal action bar (inside app) */
    .actionbar{
      position: sticky;
      bottom: 0;
      z-index: 20;
      margin-top: 14px;
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: var(--surface);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 18px 46px var(--shadow2);
    }

    /* Mini stepper */
    .stepper-dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: rgba(11,95,255,.18);
      border: 1px solid rgba(11,95,255,.18);
    }
    .stepper-dot.on{
      background: rgba(11,95,255,1);
      border-color: rgba(255,255,255,.70);
      box-shadow: 0 0 0 6px rgba(11,95,255,.12);
    }
    [data-theme="dark"] .stepper-dot.on{
      border-color: rgba(4,20,47,.85);
      box-shadow: 0 0 0 6px rgba(46,123,255,.14);
    }

    /* Price UI helpers */
    .strike{ text-decoration: line-through; opacity:.6; }
  </style>
</head>

<body>
  <div class="absolute inset-0 bg-grid pointer-events-none"></div>

  <!-- Always-visible links -->
  <div class="floating" aria-label="Comerc IAs links">
    <a class="primary btn" href="https://www.comercias.com.br/pt" target="_blank" rel="noopener noreferrer" id="siteBtn">
      <span class="mini" aria-hidden="true">
        <svg class="i" viewBox="0 0 24 24" fill="none">
          <path d="M12 2a10 10 0 100 20 10 10 0 000-20Z" stroke="currentColor" stroke-width="1.8"/>
          <path d="M2 12h20" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          <path d="M12 2c3 2.5 5 6.7 5 10s-2 7.5-5 10c-3-2.5-5-6.7-5-10S9 4.5 12 2Z" stroke="currentColor" stroke-width="1.8"/>
        </svg>
      </span>
      <span id="siteLabel">Site</span>
    </a>

    <a class="btn" href="https://www.instagram.com/comerc_ias?utm_source=ig_web_button_share_sheet&igsh=ZDNlZDc0MzIxNw==" target="_blank" rel="noopener noreferrer" id="igBtn">
      <span class="mini" aria-hidden="true">
        <svg class="i" viewBox="0 0 24 24" fill="none">
          <path d="M7 2h10a5 5 0 015 5v10a5 5 0 01-5 5H7a5 5 0 01-5-5V7a5 5 0 015-5Z" stroke="currentColor" stroke-width="1.8"/>
          <path d="M12 8a4 4 0 100 8 4 4 0 000-8Z" stroke="currentColor" stroke-width="1.8"/>
          <path d="M17.6 6.4h.01" stroke="currentColor" stroke-width="3.2" stroke-linecap="round"/>
        </svg>
      </span>
      <span id="igLabel">Instagram</span>
    </a>

    <button class="btn" type="button" id="themeBtn" aria-label="Alternar tema">
      <span class="mini" aria-hidden="true" id="themeIcon"></span>
      <span id="themeLabel">Modo escuro</span>
    </button>
  </div>

  <main class="mx-auto w-full max-w-5xl px-4 sm:px-6 py-6 sm:py-10">
    <section class="shell">
      <!-- Header -->
      <div class="px-5 sm:px-7 py-5 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3 min-w-0">
          <div class="w-11 h-11 rounded-2xl flex items-center justify-center text-white font-display font-extrabold"
               style="background: linear-gradient(180deg, rgba(11,95,255,1), rgba(10,72,190,1)); box-shadow: 0 14px 30px rgba(11,95,255,.24);">
            CI
          </div>
          <div class="leading-tight min-w-0">
            <div class="font-display font-extrabold text-[15px] sm:text-[16px] tracking-tight truncate">
              Comerc <span style="color: rgba(11,95,255,1);">IAs</span>
            </div>
            <div id="brandSub" class="text-xs muted truncate">Orçamento premium • rápido e profissional</div>
          </div>
        </div>

        <div class="pill p-1 flex items-center gap-1 shrink-0">
          <button id="langPT" class="btn px-3 py-1.5 text-sm font-semibold text-white"
            style="background: linear-gradient(180deg, rgba(11,95,255,1), rgba(10,72,190,1));">
            PT
          </button>
          <button id="langEN" class="btn px-3 py-1.5 text-sm font-semibold"
            style="color: rgba(11,95,255,1);">
            EN
          </button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- App -->
      <div class="px-5 sm:px-7 py-6 sm:py-7">
        <div id="app"></div>
      </div>

      <div class="divider"></div>

      <!-- Footer -->
      <div class="px-5 sm:px-7 py-5 text-xs muted flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <div id="footerLeft">© Comerc IAs • Atendimento rápido e profissional</div>
        <div id="footerRight">Paleta azul & branco • Responsivo • Modo escuro</div>
      </div>
    </section>
  </main>

  <!-- Embedded catalog (no fetch) -->
  <script type="application/json" id="catalog">
{
  "orcamento": {
    "categorias": [
      {
        "nome": "Imagens",
        "servicos": [
          { "titulo": "5 imagens", "titulo_venda": "Pack Visual Rápido — 5 artes", "descricao": "Criação de até 5 artes originais pensadas para redes sociais ou anúncios.", "prazo_entrega": "1 dia útil", "revisoes_incluidas": 2, "preco_original": 50, "preco": 45 },
          { "titulo": "10 imagens", "titulo_venda": "Pack Engajamento — 10 artes", "descricao": "Série de 10 artes alinhadas à sua identidade visual ou campanha.", "prazo_entrega": "1 dia útil", "revisoes_incluidas": 3, "preco_original": 80, "preco": 80 },
          { "titulo": "15 imagens", "titulo_venda": "Pack Crescimento — 15 artes", "descricao": "15 artes com identidade sólida, pronto para calendário mensal.", "prazo_entrega": "2 dias úteis", "revisoes_incluidas": 4, "preco_original": 110, "preco": 110 }
        ]
      },
      {
        "nome": "Vídeos",
        "servicos": [
          { "titulo": "Vídeo Rápido", "titulo_venda": "Vídeo Short — até 15s", "descricao": "Vídeo curto otimizado para Reels / Shorts / Tiktok.", "prazo_entrega": "1 dia útil", "revisoes_incluidas": 1, "preco_original": 70, "preco": 70 },
          { "titulo": "Vídeo Simples", "titulo_venda": "Vídeo Storytelling — até 30s", "descricao": "Vídeo de 30 segundos com narrativa simples.", "prazo_entrega": "1 dia útil", "revisoes_incluidas": 2, "preco_original": 140, "preco": 125 },
          { "titulo": "Vídeo Premium", "titulo_venda": "Vídeo Premium — até 60s", "descricao": "Vídeo com edição refinada e narrativa estruturada.", "prazo_entrega": "2 dias úteis", "revisoes_incluidas": 3, "preco_original": 240, "preco": 240 },
          { "titulo": "Vídeo Elaborado", "titulo_venda": "Vídeo Pro — até 120s (Efeitos especiais)", "descricao": "Vídeo com efeitos, composições e cenas mais elaboradas.", "prazo_entrega": "2 dias úteis", "revisoes_incluidas": 4, "preco_original": 380, "preco": 380 }
        ]
      },
      {
        "nome": "Planos de Social Media (Conteúdo Mensal)",
        "servicos": [
          { "titulo": "Plano Básico", "titulo_venda": "Plano Conteúdo Básico", "descricao": "10 Artes + 120s em Vídeos por mês.", "prazo_entrega": "Entrega semanal", "revisoes_incluidas": 1,
            "precos_por_periodo": [
              { "periodo": "Mensal", "meses": 1, "desconto_perc": 0, "preco_total_sem_desc": 400, "preco_total_com_desc": 400, "preco_mensal_efetivo": 400 },
              { "periodo": "Trimestral", "meses": 3, "desconto_perc": 5, "preco_total_sem_desc": 1200, "preco_total_com_desc": 1140, "preco_mensal_efetivo": 380 },
              { "periodo": "Semestral", "meses": 6, "desconto_perc": 10, "preco_total_sem_desc": 2400, "preco_total_com_desc": 2160, "preco_mensal_efetivo": 360 },
              { "periodo": "Anual", "meses": 12, "desconto_perc": 15, "preco_total_sem_desc": 4800, "preco_total_com_desc": 4080, "preco_mensal_efetivo": 340 }
            ]
          },
          { "titulo": "Plano Standart", "titulo_venda": "Plano Conteúdo Standart", "descricao": "20 Artes + 240s em Vídeos por mês.", "prazo_entrega": "Entrega semanal", "revisoes_incluidas": 2,
            "precos_por_periodo": [
              { "periodo": "Mensal", "meses": 1, "desconto_perc": 0, "preco_total_sem_desc": 800, "preco_total_com_desc": 800, "preco_mensal_efetivo": 800 },
              { "periodo": "Trimestral", "meses": 3, "desconto_perc": 5, "preco_total_sem_desc": 2400, "preco_total_com_desc": 2280, "preco_mensal_efetivo": 760 },
              { "periodo": "Semestral", "meses": 6, "desconto_perc": 10, "preco_total_sem_desc": 4800, "preco_total_com_desc": 4320, "preco_mensal_efetivo": 720 },
              { "periodo": "Anual", "meses": 12, "desconto_perc": 15, "preco_total_sem_desc": 9600, "preco_total_com_desc": 8160, "preco_mensal_efetivo": 680 }
            ]
          },
          { "titulo": "Plano Premium", "titulo_venda": "Plano Conteúdo Premium", "descricao": "40 Artes + 320s em Vídeos por mês.", "prazo_entrega": "Entrega semanal", "revisoes_incluidas": 2,
            "precos_por_periodo": [
              { "periodo": "Mensal", "meses": 1, "desconto_perc": 0, "preco_total_sem_desc": 1200, "preco_total_com_desc": 1200, "preco_mensal_efetivo": 1200 },
              { "periodo": "Trimestral", "meses": 3, "desconto_perc": 5, "preco_total_sem_desc": 3600, "preco_total_com_desc": 3420, "preco_mensal_efetivo": 1140 },
              { "periodo": "Semestral", "meses": 6, "desconto_perc": 10, "preco_total_sem_desc": 7200, "preco_total_com_desc": 6480, "preco_mensal_efetivo": 1080 },
              { "periodo": "Anual", "meses": 12, "desconto_perc": 15, "preco_total_sem_desc": 14400, "preco_total_com_desc": 12240, "preco_mensal_efetivo": 1020 }
            ]
          }
        ]
      },
      {
        "nome": "Serviços Avulsos",
        "servicos": [
          { "titulo": "Narração profissional IA", "titulo_venda": "Voz Profissional (IA) — por bloco", "descricao": "Narração por IA com entonação natural.", "prazo_entrega": "6–12 horas", "revisoes_incluidas": 2, "preco_original": 25, "preco": 25 },
          { "titulo": "Cartaz de divulgação", "titulo_venda": "Poster Promocional — Arte personalizada", "descricao": "Criação de cartaz para eventos e promoções.", "prazo_entrega": "1 dia útil", "revisoes_incluidas": 2, "preco_original": 50, "preco": 50 },
          { "titulo": "Edição de foto com IA", "titulo_venda": "Retoque Rápido — por foto", "descricao": "Melhoria e tratamento de imagem.", "prazo_entrega": "1 dia útil", "revisoes_incluidas": 1, "preco_original": 25, "preco": 25 },
          { "titulo": "Ensaio de produto", "titulo_venda": "Shooting Compact — 10 fotos + 2 vídeos", "descricao": "10 fotos tratadas + 2 vídeos até 30s.", "prazo_entrega": "3 dias úteis", "revisoes_incluidas": 4, "preco_original": 330, "preco": 299 },
          { "titulo": "Criação de logomarca", "titulo_venda": "Identidade Visual Básica — logomarca", "descricao": "Criação de logotipo com conceitos alinhados à marca.", "prazo_entrega": "1 dia útil", "revisoes_incluidas": 4, "preco_original": 100, "preco": 100 },
          { "titulo": "Trilha sonora IA", "titulo_venda": "Trilha Sonora Exclusiva por IA", "descricao": "Composição musical gerada sob briefing.", "prazo_entrega": "2 dias úteis", "revisoes_incluidas": 2, "preco_original": 170, "preco": 170 },
          { "titulo": "Dublagem IA", "titulo_venda": "Dublagem profissional por IA", "descricao": "Dublagem em qualquer idioma (até 15 min).", "prazo_entrega": "3 dias úteis", "revisoes_incluidas": 2, "preco_original": 300, "preco": 300 },
          { "titulo": "Site empresarial personalizado", "titulo_venda": "Website Corporativo Básico", "descricao": "Website institucional com design responsivo.", "prazo_entrega": "5 dias úteis", "revisoes_incluidas": 4, "preco_original": 650, "preco": 590 }
        ]
      },
      {
        "nome": "Criação de Personagem Personalizado",
        "servicos": [
          { "titulo": "Personagem estático", "titulo_venda": "Mascote Ilustrado — 5 poses", "descricao": "Personagem estático com 5 poses.", "prazo_entrega": "1 dia útil", "revisoes_incluidas": 4, "preco_original": 170, "preco": 170 },
          { "titulo": "Personagem animado (curto)", "titulo_venda": "Mascote Animado — 30s + narração", "descricao": "Animação curta com narração.", "prazo_entrega": "1 dia útil", "revisoes_incluidas": 3, "preco_original": 290, "preco": 290 },
          { "titulo": "Personagem animado (longo)", "titulo_venda": "Mascote Cinemático — 1 min + narração", "descricao": "Animação de 1 minuto com narrativa.", "prazo_entrega": "2 dias úteis", "revisoes_incluidas": 4, "preco_original": 420, "preco": 420 }
        ]
      },
      {
        "nome": "Pacotes de Personagem Personalizado",
        "servicos": [
          { "titulo": "Pacote básico", "titulo_venda": "Starter Pack — 1x 30s + 3 poses", "descricao": "1 vídeo 30s + 3 poses.", "prazo_entrega": "1 dia útil", "revisoes_incluidas": 2, "preco_original": 420, "preco": 420 },
          { "titulo": "Pacote standart", "titulo_venda": "Brand Pack — 1x 1min + 3 poses", "descricao": "1 vídeo 60s + 3 poses.", "prazo_entrega": "2 dias úteis", "revisoes_incluidas": 3, "preco_original": 550, "preco": 550 },
          { "titulo": "Pacote premium", "titulo_venda": "Pro Pack — 3x 30s + 5 poses", "descricao": "3 vídeos 30s + 5 poses.", "prazo_entrega": "3 dias úteis", "revisoes_incluidas": 4, "preco_original": 750, "preco": 675 },
          { "titulo": "Pacote deluxe", "titulo_venda": "Deluxe Pack — 6x 30s ou 3x 1min", "descricao": "Pacote robusto para lançamentos.", "prazo_entrega": "5 dias úteis", "revisoes_incluidas": 6, "preco_original": 1100, "preco": 1100 }
        ]
      }
    ],
    "observacoes": "Descontos progressivos em combos e em parcerias mensais, semestrais ou anuais. Conte sua ideia para a gente!"
  }
}
  </script>

  <script>
  (function(){
    const WHATSAPP_NUMBER = "5532991147944";

    const root = document.documentElement;
    const app = document.getElementById("app");

    // -------------------- Theme --------------------
    const THEME_KEY = "comerc_theme";
    const prefersDark = () => window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    const getSavedTheme = () => {
      const v = localStorage.getItem(THEME_KEY);
      return (v === "dark" || v === "light") ? v : null;
    };
    function setTheme(theme){
      root.setAttribute("data-theme", theme);
      localStorage.setItem(THEME_KEY, theme);
      updateThemeBtn();
    }
    function themeIconMoon(){
      return `<svg class="i" viewBox="0 0 24 24" fill="none"><path d="M21 14.5A8.5 8.5 0 1110.5 3a7 7 0 0010.5 11.5Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/></svg>`;
    }
    function themeIconSun(){
      return `<svg class="i" viewBox="0 0 24 24" fill="none"><path d="M12 18a6 6 0 100-12 6 6 0 000 12Z" stroke="currentColor" stroke-width="1.8"/><path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l-1.4-1.4M20.4 20.4L19 19M5 19l-1.4 1.4M20.4 3.6L19 5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>`;
    }
    function updateThemeBtn(){
      const theme = root.getAttribute("data-theme") || "light";
      const isDark = theme === "dark";
      document.getElementById("themeIcon").innerHTML = isDark ? themeIconSun() : themeIconMoon();
      document.getElementById("themeLabel").textContent = isDark ? t("theme_light") : t("theme_dark");
      document.getElementById("themeBtn").setAttribute("aria-label", t("theme_toggle"));
    }

    // -------------------- i18n --------------------
    const I18N = {
      pt: {
        brandSub: "Orçamento premium • rápido e profissional",
        footerLeft: "© Comerc IAs • Atendimento rápido e profissional",
        footerRight: "Paleta azul & branco • Responsivo • Modo escuro",

        site:"Site",
        instagram:"Instagram",
        theme_dark:"Modo escuro",
        theme_light:"Modo claro",
        theme_toggle:"Alternar tema",

        intro_badge:"ORÇAMENTO INSTANTÂNEO",
        intro_title:"Receba 3 ofertas claras em 45 segundos",
        intro_sub:"Responda o quiz e receba 3 opções (essencial, custo-benefício e avançada). Depois é só finalizar pelo WhatsApp.",
        start:"Começar agora",
        restart:"Reiniciar",

        step:"Pergunta",
        of:"de",
        back:"Voltar",
        next:"Continuar",
        skip:"Pular",
        choose_one:"Escolha 1 opção para continuar",
        optional:"Opcional",

        q_goal:"Qual é o seu objetivo principal?",
        goal_sales:"Gerar vendas / conversão",
        goal_brand:"Fortalecer marca / identidade",
        goal_social:"Conteúdo para redes sociais",
        goal_edu:"Educativo / explicativo",
        goal_intl:"Internacionalizar (idiomas)",
        goal_launch:"Lançamento / campanha",

        q_need:"O que você precisa agora?",
        need_images:"Artes e imagens",
        need_videos:"Vídeos (Reels/Ads)",
        need_plan:"Plano mensal de conteúdo",
        need_oneoff:"Serviços avulsos (logo, site, etc.)",
        need_mascot:"Personagem / mascote",
        need_unsure:"Não tenho certeza",

        q_volume:"Qual volume você imagina?",
        vol_low:"Baixo (rápido / essencial)",
        vol_mid:"Médio (consistente)",
        vol_high:"Alto (campanha forte)",
        vol_mega:"Muito alto (máxima presença)",

        q_invest:"Investimento desejado",
        inv_100:"Até R$100",
        inv_300:"Até R$300",
        inv_600:"Até R$600",
        inv_1000:"Até R$1.000",
        inv_2000:"Até R$2.000",
        invest_hint:"Se preferir, pule — estimamos pelo volume.",

        q_deadline:"Prazo desejado",
        d1:"Urgente (até 2 dias)",
        d2:"Até 7 dias",
        d3:"Flexível",
        deadline_hint:"Se preferir, pule — alinhamos no WhatsApp.",

        offers_title:"Escolha sua oferta",
        offers_sub:"3 opções claras e limpas. Você escolhe 1 e finaliza no WhatsApp.",
        essential:"Essencial",
        best_value:"Custo-benefício",
        advanced:"Avançada",
        best_seller:"MAIS VENDIDA",
        est_total:"Total estimado",
        save:"Você economiza",
        details:"Ver o que está incluso",
        choose:"Escolher esta oferta",
        change_answers:"Alterar respostas",

        customize_title:"Ajuste fino (opcional)",
        customize_sub:"Opcional: adicione 1–2 extras relevantes (sem poluir a tela).",
        included:"Incluso na oferta",
        extras:"Extras sugeridos",
        note:"Observações rápidas (opcional):",
        note_ph:"Ex.: Quero focar em promoções da semana, público X, referência de estilo…",
        send_wa:"Enviar no WhatsApp",
        copy_msg:"Copiar mensagem",
        copied:"Copiado!",
        preview:"Prévia da mensagem",
        summary:"Resumo do quiz",
        obs:"Observação"
      },
      en: {
        brandSub: "Premium quote • fast and professional",
        footerLeft: "© Comerc IAs • Fast and professional service",
        footerRight: "Blue & white palette • Responsive • Dark mode",

        site:"Website",
        instagram:"Instagram",
        theme_dark:"Dark mode",
        theme_light:"Light mode",
        theme_toggle:"Toggle theme",

        intro_badge:"INSTANT QUOTE",
        intro_title:"Get 3 clear offers in 45 seconds",
        intro_sub:"Answer the quiz and get 3 options (simple, best value, advanced). Then finish via WhatsApp.",
        start:"Start now",
        restart:"Restart",

        step:"Question",
        of:"of",
        back:"Back",
        next:"Continue",
        skip:"Skip",
        choose_one:"Choose 1 option to continue",
        optional:"Optional",

        q_goal:"What’s your main goal?",
        goal_sales:"Sales / conversion",
        goal_brand:"Brand / identity",
        goal_social:"Social media content",
        goal_edu:"Educational / explanatory",
        goal_intl:"Go international (languages)",
        goal_launch:"Launch / campaign",

        q_need:"What do you need right now?",
        need_images:"Designs & images",
        need_videos:"Videos (Reels/Ads)",
        need_plan:"Monthly content plan",
        need_oneoff:"One-off services (logo, website, etc.)",
        need_mascot:"Character / mascot",
        need_unsure:"Not sure yet",

        q_volume:"What volume are you aiming for?",
        vol_low:"Low (fast / essential)",
        vol_mid:"Medium (consistent)",
        vol_high:"High (strong campaign)",
        vol_mega:"Very high (maximum presence)",

        q_invest:"Desired budget",
        inv_100:"Up to R$100",
        inv_300:"Up to R$300",
        inv_600:"Up to R$600",
        inv_1000:"Up to R$1,000",
        inv_2000:"Up to R$2,000",
        invest_hint:"If you prefer, skip — we estimate by volume.",

        q_deadline:"Desired timeline",
        d1:"Urgent (up to 2 days)",
        d2:"Up to 7 days",
        d3:"Flexible",
        deadline_hint:"If you prefer, skip — we align on WhatsApp.",

        offers_title:"Choose your offer",
        offers_sub:"3 clean options. Pick one and finish on WhatsApp.",
        essential:"Simple",
        best_value:"Best value",
        advanced:"Advanced",
        best_seller:"BEST SELLER",
        est_total:"Estimated total",
        save:"You save",
        details:"See what’s included",
        choose:"Choose this offer",
        change_answers:"Change answers",

        customize_title:"Fine-tune (optional)",
        customize_sub:"Optional: add 1–2 relevant add-ons (kept minimal).",
        included:"Included in the offer",
        extras:"Suggested add-ons",
        note:"Quick notes (optional):",
        note_ph:"E.g., I want weekly promos, audience X, style reference…",
        send_wa:"Send on WhatsApp",
        copy_msg:"Copy message",
        copied:"Copied!",
        preview:"Message preview",
        summary:"Quiz summary",
        obs:"Note"
      }
    };

    function detectLang(){
      const qs = new URLSearchParams(location.search);
      const l = (qs.get("lang")||"").toLowerCase();
      if(l==="en") return "en";
      if(l==="pt") return "pt";
      return (navigator.language||"pt").toLowerCase().startsWith("en") ? "en" : "pt";
    }
    let lang = detectLang();
    const t = (k)=>(I18N[lang] && I18N[lang][k]) ? I18N[lang][k] : (I18N.pt[k]||k);

    // -------------------- Data --------------------
    const raw = JSON.parse(document.getElementById("catalog").textContent);
    const catalog = raw.orcamento || raw;
    const categories = Array.isArray(catalog.categorias) ? catalog.categorias : [];
    const OBS = catalog.observacoes || "";

    const services = [];
    categories.forEach(cat=>{
      (cat.servicos||[]).forEach(s=>{
        services.push({
          ...s,
          __cat: cat.nome,
          __id: (cat.nome + "|" + (s.titulo_venda || s.titulo)).toLowerCase().replace(/\s+/g,"-")
        });
      });
    });
    const isPlan = (s)=>Array.isArray(s.precos_por_periodo);

    function money(n){
      const val = Number(n||0);
      return new Intl.NumberFormat(lang==="en" ? "en-US" : "pt-BR", {
        style:"currency", currency:"BRL", maximumFractionDigits:0
      }).format(val);
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function getPlanPeriod(s, periodo){
      const list = s.precos_por_periodo || [];
      const found = list.find(p=>p.periodo===periodo) || list[0];
      if(!found) return {periodo:"Mensal", meses:1, desconto:0, total:Number(s.preco||0), monthly:Number(s.preco||0)};
      return {
        periodo: found.periodo,
        meses: Number(found.meses||1),
        desconto: Number(found.desconto_perc||0),
        total: Number(found.preco_total_com_desc||0),
        monthly: Number(found.preco_mensal_efetivo||0)
      };
    }

    // -------------------- UI helpers --------------------
    function setFade(html){
      app.innerHTML = html;
      const el = app.querySelector(".fade");
      if(el) requestAnimationFrame(()=>el.classList.add("show"));
      // garante foco no topo do conteúdo renderizado (melhor para teclado/leitor de tela)
      const focusTarget = app.querySelector("[data-autofocus]");
      if(focusTarget) focusTarget.focus({preventScroll:true});
      // mantém a rolagem consistente em mudanças de view
      window.scrollTo({top: 0, behavior: "smooth"});
    }

    function applyLangUI(){
      document.documentElement.lang = (lang==="en") ? "en" : "pt-BR";
      document.getElementById("brandSub").textContent = t("brandSub");
      document.getElementById("footerLeft").textContent = t("footerLeft");
      document.getElementById("footerRight").textContent = t("footerRight");
      document.getElementById("siteLabel").textContent = t("site");
      document.getElementById("igLabel").textContent = t("instagram");

      const pt = document.getElementById("langPT");
      const en = document.getElementById("langEN");
      if(lang==="pt"){
        pt.style.background = "linear-gradient(180deg, rgba(11,95,255,1), rgba(10,72,190,1))";
        pt.style.color = "#fff";
        en.style.background = "transparent";
        en.style.color = "rgba(11,95,255,1)";
      }else{
        en.style.background = "linear-gradient(180deg, rgba(11,95,255,1), rgba(10,72,190,1))";
        en.style.color = "#fff";
        pt.style.background = "transparent";
        pt.style.color = "rgba(11,95,255,1)";
      }
      updateThemeBtn();
    }

    // -------------------- State (persist) --------------------
    const STATE_KEY = "comerc_quiz_state_v2";
    function loadState(){
      try{
        const s = sessionStorage.getItem(STATE_KEY);
        return s ? JSON.parse(s) : null;
      }catch(e){ return null; }
    }
    function saveState(){
      try{
        sessionStorage.setItem(STATE_KEY, JSON.stringify({
          answers, stepIndex, view,
          chosenTier: chosenOffer?.tier || null,
          custom: customState ? {
            selectedIds: Array.from(customState.selectedIds),
            extraIds: Array.from(customState.extraIds),
            periodById: Array.from(customState.periodById.entries())
          } : null
        }));
      }catch(e){}
    }
    function clearState(){
      try{ sessionStorage.removeItem(STATE_KEY); }catch(e){}
    }

    // -------------------- Quiz flow --------------------
    let answers = {};
    let stepIndex = 0;
    let view = "intro"; // intro | quiz | offers | customize
    let chosenOffer = null;
    let customState = null;
    let offersCache = null;

    const steps = [
      { id:"goal", titleKey:"q_goal", optional:false, options:[
        {k:"goal_sales", v:"sales"}, {k:"goal_brand", v:"brand"}, {k:"goal_social", v:"social"},
        {k:"goal_edu", v:"edu"}, {k:"goal_intl", v:"intl"}, {k:"goal_launch", v:"launch"}
      ]},
      { id:"need", titleKey:"q_need", optional:false, options:[
        {k:"need_images", v:"images"}, {k:"need_videos", v:"videos"}, {k:"need_plan", v:"plan"},
        {k:"need_oneoff", v:"oneoff"}, {k:"need_mascot", v:"mascot"}, {k:"need_unsure", v:"unsure"}
      ]},
      { id:"volume", titleKey:"q_volume", optional:false, options:[
        {k:"vol_low", v:"low"}, {k:"vol_mid", v:"mid"}, {k:"vol_high", v:"high"}, {k:"vol_mega", v:"mega"}
      ]},
      { id:"invest", titleKey:"q_invest", optional:true, hintKey:"invest_hint", options:[
        {k:"inv_100", v:100}, {k:"inv_300", v:300},
        {k:"inv_600", v:600}, {k:"inv_1000", v:1000}, {k:"inv_2000", v:2000}
      ]},
      { id:"deadline", titleKey:"q_deadline", optional:true, hintKey:"deadline_hint", options:[
        {k:"d1", v:"urgent"}, {k:"d2", v:"week"}, {k:"d3", v:"flex"}
      ]}
    ];

    function progressPct(){
      const total = steps.length + 2; // offers + customize
      const done = view==="intro" ? 0 :
        view==="quiz" ? stepIndex :
        view==="offers" ? steps.length :
        steps.length + 1;
      return Math.round((done/total)*100);
    }

    function anchorByVolume(vol){
      if(vol==="low") return 300;
      if(vol==="mid") return 600;
      if(vol==="high") return 1000;
      return 2000;
    }
    function getAnchor(){
      const inv = answers.invest;
      if(typeof inv === "number" && isFinite(inv)) return inv;
      return anchorByVolume(answers.volume || "mid");
    }

    function findByVenda(venda){
      return services.find(s => (s.titulo_venda||"") === venda);
    }

    function pickCore(tier){
      const need = answers.need;
      const vol = answers.volume;

      const pick = (a,b,c)=>{
        if(tier==="simple") return findByVenda(a);
        if(tier==="value") return findByVenda(b);
        return findByVenda(c);
      };

      if(need==="images"){
        if(vol==="high" || vol==="mega") return pick("Pack Engajamento — 10 artes","Pack Crescimento — 15 artes","Pack Crescimento — 15 artes");
        return pick("Pack Visual Rápido — 5 artes","Pack Engajamento — 10 artes","Pack Crescimento — 15 artes");
      }

      if(need==="videos"){
        if(vol==="mega") return pick("Vídeo Storytelling — até 30s","Vídeo Premium — até 60s","Vídeo Pro — até 120s (Efeitos especiais)");
        if(vol==="high") return pick("Vídeo Short — até 15s","Vídeo Storytelling — até 30s","Vídeo Premium — até 60s");
        return pick("Vídeo Short — até 15s","Vídeo Storytelling — até 30s","Vídeo Premium — até 60s");
      }

      if(need==="plan"){
        return pick("Plano Conteúdo Básico","Plano Conteúdo Standart","Plano Conteúdo Premium");
      }

      if(need==="mascot"){
        if((answers.goal==="launch" || vol==="mega")){
          return pick("Mascote Ilustrado — 5 poses","Starter Pack — 1x 30s + 3 poses","Brand Pack — 1x 1min + 3 poses");
        }
        return pick("Mascote Ilustrado — 5 poses","Mascote Animado — 30s + narração","Mascote Cinemático — 1 min + narração");
      }

      const g = answers.goal;
      if(g==="brand") return pick("Identidade Visual Básica — logomarca","Website Corporativo Básico","Website Corporativo Básico");
      if(g==="sales") return pick("Poster Promocional — Arte personalizada","Shooting Compact — 10 fotos + 2 vídeos","Shooting Compact — 10 fotos + 2 vídeos");
      if(g==="intl") return pick("Dublagem profissional por IA","Dublagem profissional por IA","Dublagem profissional por IA");
      if(g==="edu") return pick("Voz Profissional (IA) — por bloco","Trilha Sonora Exclusiva por IA","Trilha Sonora Exclusiva por IA");
      if(g==="launch") return pick("Poster Promocional — Arte personalizada","Vídeo Storytelling — até 30s","Vídeo Premium — até 60s");

      return pick("Poster Promocional — Arte personalizada","Pack Engajamento — 10 artes","Vídeo Premium — até 60s");
    }

    function uniquePush(arr, svc){
      if(!svc) return;
      if(arr.find(x=>x.__id===svc.__id)) return;
      arr.push(svc);
    }

    function suggestExtras(tier, core){
      const maxExtras = (tier==="simple") ? 1 : 2;
      const extras = [];
      const g = answers.goal;
      const need = answers.need;

      const add = (venda)=> uniquePush(extras, findByVenda(venda));

      if(core && core.__cat==="Vídeos"){
        if(g==="sales" || g==="launch" || g==="social"){
          add("Pack Engajamento — 10 artes");
        }
      }
      if(core && core.__cat==="Imagens"){
        if(g==="sales" || g==="launch" || g==="social"){
          add("Vídeo Storytelling — até 30s");
        }
      }

      if(g==="sales" || g==="launch"){
        add("Poster Promocional — Arte personalizada");
        if(tier!=="simple") add("Shooting Compact — 10 fotos + 2 vídeos");
      }
      if(g==="brand"){
        add("Identidade Visual Básica — logomarca");
        if(tier!=="simple") add("Website Corporativo Básico");
      }
      if(g==="edu"){
        add("Voz Profissional (IA) — por bloco");
        if(tier!=="simple") add("Trilha Sonora Exclusiva por IA");
      }
      if(g==="intl"){
        add("Dublagem profissional por IA");
      }

      if(need==="plan"){
        if(tier==="advanced") add("Vídeo Storytelling — até 30s");
      }

      const filtered = extras.filter(x=>!core || x.__id !== core.__id);
      return filtered.slice(0, maxExtras);
    }

    function calcTotals(items, discountPerc, periodById){
      let subtotal = 0;
      let originalSubtotal = 0;

      const lines = items.map(s=>{
        if(isPlan(s)){
          const period = periodById?.get(s.__id) || "Mensal";
          const p = getPlanPeriod(s, period);
          subtotal += p.monthly;
          originalSubtotal += p.monthly; // plano já vem "mensal efetivo" no catálogo
          return {svc:s, kind:"plan", period:p.periodo, monthly:p.monthly, termTotal:p.total};
        } else {
          const price = Number(s.preco||0);
          const original = Number(s.preco_original||price);
          subtotal += price;
          originalSubtotal += original;
          return {svc:s, kind:"oneoff", price, original};
        }
      });

      const discount = Math.round(subtotal * (discountPerc/100));
      const total = subtotal - discount;

      // economia total inclui: (orig - atual) + desconto combo
      const instantSave = Math.max(0, Math.round(originalSubtotal - subtotal));
      const totalSave = instantSave + discount;

      return {lines, subtotal, originalSubtotal, instantSave, discount, total, totalSave};
    }

    function buildOffers(){
      const anchor = getAnchor();
      const discounts = { simple: 0, value: 10, advanced: 12 };
      const periodSimple = "Mensal";
      const periodValue = "Trimestral";
      const periodAdvanced = "Semestral";

      function buildTier(tier){
        const core = pickCore(tier);
        const items = [];
        uniquePush(items, core);
        suggestExtras(tier, core).forEach(x=>uniquePush(items, x));

        const periodById = new Map();
        items.forEach(s=>{
          if(isPlan(s)){
            periodById.set(s.__id, tier==="simple" ? periodSimple : tier==="value" ? periodValue : periodAdvanced);
          }
        });

        let totals = calcTotals(items, discounts[tier] || 0, periodById);

        const target = tier==="simple" ? anchor*0.75 : tier==="value" ? anchor*1.0 : anchor*1.45;
        if(tier!=="simple" && totals.total > target*1.35 && items.length>1){
          items.pop();
          totals = calcTotals(items, discounts[tier] || 0, periodById);
        }
        return {tier, items, periodById, discountPerc: discounts[tier]||0, ...totals};
      }

      return [buildTier("simple"), buildTier("value"), buildTier("advanced")];
    }

    function labelOf(stepId, val){
      if(val === null || typeof val === "undefined") return lang==="en" ? "Skipped" : "Pulou";
      const s = steps.find(x=>x.id===stepId);
      if(!s) return String(val ?? "");
      const opt = s.options.find(o=>String(o.v)===String(val));
      return opt ? t(opt.k) : String(val ?? "");
    }

    function offerTitle(tier){
      if(tier==="simple") return t("essential");
      if(tier==="value") return t("best_value");
      return t("advanced");
    }

    // -------------------- Render: shared header blocks --------------------
    function renderTopProgress(){
      const pct = progressPct();
      const dots = steps.map((_, idx)=>{
        const on = (view==="quiz" && idx <= stepIndex) || (view!=="quiz" && idx < steps.length);
        return `<span class="stepper-dot ${on ? "on":""}" aria-hidden="true"></span>`;
      }).join("");

      return `
        <div class="flex items-center justify-between gap-4">
          <div class="min-w-0">
            <div class="pill inline-flex items-center gap-2 px-3 py-1.5 text-xs font-extrabold tracking-wide" style="color: rgba(11,95,255,1);">
              <span class="chip px-3 py-1 text-[11px] font-extrabold">${escapeHtml(t("intro_badge"))}</span>
              <span class="muted">${escapeHtml(lang==="en" ? "Fast • Clear • WhatsApp" : "Rápido • Claro • WhatsApp")}</span>
            </div>
          </div>

          <div class="min-w-[170px]">
            <div class="flex items-center justify-end gap-2 mb-1">
              <div class="flex items-center gap-1.5">${dots}</div>
              <div class="text-xs muted text-right">${pct}%</div>
            </div>
            <div class="h-2 rounded-full overflow-hidden" style="background: rgba(11,95,255,.10);">
              <div class="h-2" style="width:${pct}%; background: linear-gradient(90deg, rgba(11,95,255,1), rgba(46,123,255,1));"></div>
            </div>
          </div>
        </div>
      `;
    }

    // -------------------- Intro --------------------
    function renderIntro(){
      view = "intro";
      saveState();

      setFade(`
        <div class="fade">
          <div class="card p-5 sm:p-6">
            ${renderTopProgress()}

            <div class="mt-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
              <div class="min-w-0">
                <h1 class="font-display text-2xl sm:text-3xl font-extrabold tracking-tight">
                  ${escapeHtml(t("intro_title"))}
                </h1>
                <p class="mt-2 text-sm sm:text-base muted max-w-2xl">
                  ${escapeHtml(t("intro_sub"))}
                </p>

                <div class="mt-4 flex flex-wrap gap-2">
                  <span class="pill px-3 py-1.5 text-xs">${escapeHtml(lang==="en" ? "3 offers" : "3 ofertas")}</span>
                  <span class="pill px-3 py-1.5 text-xs">${escapeHtml(lang==="en" ? "No surprises" : "Sem pegadinhas")}</span>
                  <span class="pill px-3 py-1.5 text-xs">${escapeHtml(lang==="en" ? "WhatsApp finish" : "Finaliza no WhatsApp")}</span>
                </div>
              </div>

              <div class="w-full md:w-[340px]">
                <div class="grid grid-cols-2 gap-2">
                  <button id="startBtn" data-autofocus class="btn btn-primary px-5 py-3 font-display font-extrabold">
                    ${escapeHtml(t("start"))}
                  </button>
                  <button id="resetBtn" class="btn btn-ghost px-5 py-3 font-display font-bold">
                    ${escapeHtml(t("restart"))}
                  </button>
                </div>

                <div class="mt-3 pill px-4 py-3 text-sm">
                  <div class="font-display font-extrabold" style="color: var(--text);">
                    ${escapeHtml(lang==="en" ? "Tip" : "Dica")}
                  </div>
                  <div class="muted mt-1">
                    ${escapeHtml(lang==="en"
                      ? "Use the arrow keys to navigate options. Press Enter to select."
                      : "Use as setas do teclado para navegar. Enter seleciona."
                    )}
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-5 text-xs muted">
              <span class="font-semibold" style="color: var(--text);">${escapeHtml(t("obs"))}:</span>
              ${escapeHtml(OBS)}
            </div>
          </div>
        </div>
      `);

      document.getElementById("startBtn").addEventListener("click", ()=>renderStep(0));
      document.getElementById("resetBtn").addEventListener("click", resetAll);
    }

    // -------------------- Step --------------------
    function renderStep(i){
      view = "quiz";
      stepIndex = i;
      const s = steps[i];
      const selected = answers[s.id];

      saveState();

      const hint = s.optional ? `
        <div class="pill px-4 py-3 text-sm mt-3">
          <div class="flex items-start gap-3">
            <div class="w-9 h-9 rounded-2xl flex items-center justify-center"
              style="background: var(--warnBg); border: 1px solid rgba(255,145,0,.18); color: var(--warn);">
              <svg class="i" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 8v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M12 17h.01" stroke="currentColor" stroke-width="3.2" stroke-linecap="round"/>
                <path d="M10.3 4.4h3.4a2 2 0 011.7 1l6.2 10.6a2 2 0 01-1.7 3H4.1a2 2 0 01-1.7-3l6.2-10.6a2 2 0 011.7-1Z" stroke="currentColor" stroke-width="1.6" opacity=".35"/>
              </svg>
            </div>
            <div class="min-w-0">
              <div class="font-display font-extrabold" style="color: var(--text);">${escapeHtml(t("optional"))}</div>
              <div class="muted mt-1">${escapeHtml(t(s.hintKey || ""))}</div>
            </div>
          </div>
        </div>
      ` : ``;

      const opts = s.options.map((o, idx)=>{
        const isSel = String(selected) === String(o.v);
        return `
          <button
            type="button"
            class="option btn text-left p-4 sm:p-5 w-full ${isSel ? "selected":""}"
            role="radio"
            aria-checked="${isSel ? "true":"false"}"
            data-value="${escapeHtml(o.v)}"
            data-idx="${idx}">
            <div class="flex items-start gap-3">
              <div class="pill w-10 h-10 flex items-center justify-center shrink-0" style="color: rgba(11,95,255,1);">
                <span class="check-dot" aria-hidden="true"></span>
              </div>
              <div class="min-w-0">
                <div class="font-display font-extrabold leading-snug">${escapeHtml(t(o.k))}</div>
                <div class="text-sm muted mt-1">
                  ${escapeHtml(lang==="en" ? "Select and continue." : "Selecione e continue.")}
                </div>
              </div>
            </div>
          </button>
        `;
      }).join("");

      const canNext = (typeof selected !== "undefined");
      const backDisabled = i===0;

      setFade(`
        <div class="fade">
          <div class="card p-5 sm:p-6">
            ${renderTopProgress()}

            <div class="mt-4 flex items-start justify-between gap-4">
              <div class="min-w-0">
                <div class="text-xs font-extrabold" style="color: rgba(11,95,255,1);">
                  ${escapeHtml(t("step"))} ${i+1} ${escapeHtml(t("of"))} ${steps.length}
                </div>
                <div class="font-display text-xl sm:text-2xl font-extrabold mt-1 tracking-tight">
                  ${escapeHtml(t(s.titleKey))}
                </div>
                <div class="text-sm muted mt-2">${escapeHtml(t("choose_one"))}</div>
              </div>
            </div>

            ${hint}

            <div class="mt-4 grid gap-3 sm:gap-4 sm:grid-cols-2" role="radiogroup" aria-label="${escapeHtml(t(s.titleKey))}" id="rg">
              ${opts}
            </div>

            <div class="actionbar mt-5 p-3">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div class="flex gap-2">
                  <button id="backBtn" class="btn btn-ghost px-4 py-2.5 font-display font-bold ${backDisabled ? "opacity-40 cursor-not-allowed" : ""}" ${backDisabled ? "disabled":""}>
                    ${escapeHtml(t("back"))}
                  </button>
                  ${s.optional ? `
                    <button id="skipBtn" class="btn btn-ghost px-4 py-2.5 font-display font-bold">
                      ${escapeHtml(t("skip"))}
                    </button>` : ``}
                </div>

                <div class="flex items-center gap-2">
                  <span class="pill px-3 py-1.5 text-xs">${escapeHtml("Comerc IAs")}</span>
                  <button id="nextBtn" class="btn btn-primary px-5 py-2.5 font-display font-extrabold ${canNext ? "" : "opacity-50 cursor-not-allowed"}" ${canNext ? "" : "disabled"}>
                    ${escapeHtml(t("next"))}
                  </button>
                </div>
              </div>
            </div>

          </div>
        </div>
      `);

      const rg = document.getElementById("rg");
      const optionButtons = Array.from(rg.querySelectorAll("[role='radio']"));

      function setSelected(rawVal){
        let v = rawVal;
        v = isNaN(Number(v)) ? v : Number(v);
        answers[s.id] = v;

        optionButtons.forEach(btn=>{
          const val = btn.getAttribute("data-value");
          const isSel = String(val) === String(rawVal);
          btn.classList.toggle("selected", isSel);
          btn.setAttribute("aria-checked", isSel ? "true":"false");
        });

        const next = document.getElementById("nextBtn");
        next.disabled = false;
        next.classList.remove("opacity-50","cursor-not-allowed");

        saveState();
      }

      optionButtons.forEach(btn=>{
        btn.addEventListener("click", ()=>setSelected(btn.getAttribute("data-value")));
      });

      // Keyboard navigation inside radiogroup
      rg.addEventListener("keydown", (e)=>{
        const keys = ["ArrowDown","ArrowRight","ArrowUp","ArrowLeft","Home","End","Enter"," "];
        if(!keys.includes(e.key)) return;

        const active = document.activeElement;
        let idx = optionButtons.indexOf(active);
        if(idx < 0) idx = 0;

        if(e.key==="ArrowDown" || e.key==="ArrowRight"){ e.preventDefault(); idx = Math.min(optionButtons.length-1, idx+1); optionButtons[idx].focus(); }
        if(e.key==="ArrowUp" || e.key==="ArrowLeft"){ e.preventDefault(); idx = Math.max(0, idx-1); optionButtons[idx].focus(); }
        if(e.key==="Home"){ e.preventDefault(); optionButtons[0].focus(); }
        if(e.key==="End"){ e.preventDefault(); optionButtons[optionButtons.length-1].focus(); }
        if(e.key==="Enter" || e.key===" "){
          e.preventDefault();
          const focused = document.activeElement;
          if(focused && focused.getAttribute("data-value") != null){
            setSelected(focused.getAttribute("data-value"));
          }
        }
      });

      // Focus first option by default (better for keyboard)
      if(optionButtons[0]) optionButtons[0].setAttribute("tabindex","0");
      optionButtons.forEach((b, j)=> b.setAttribute("tabindex", j===0 ? "0":"-1"));
      if(!selected && optionButtons[0]) optionButtons[0].focus({preventScroll:true});

      document.getElementById("backBtn").addEventListener("click", ()=> {
        if(i===0) return;
        renderStep(i-1);
      });

      document.getElementById("nextBtn").addEventListener("click", ()=>{
        if(typeof answers[s.id] === "undefined") return;
        if(i === steps.length - 1) return renderOffers();
        renderStep(i+1);
      });

      if(s.optional){
        document.getElementById("skipBtn").addEventListener("click", ()=>{
          answers[s.id] = null;
          saveState();
          if(i === steps.length - 1) return renderOffers();
          renderStep(i+1);
        });
      }
    }

    // -------------------- Offers --------------------
    function renderOffers(){
      view = "offers";
      offersCache = buildOffers();
      saveState();

      const offers = offersCache;

      const summary = `
        <div class="card p-5 sm:p-6">
          ${renderTopProgress()}

          <div class="mt-4 flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="text-xs font-extrabold" style="color: rgba(11,95,255,1);">${escapeHtml(t("offers_title"))}</div>
              <div class="font-display text-xl sm:text-2xl font-extrabold mt-1">${escapeHtml(t("offers_title"))}</div>
              <div class="text-sm muted mt-1">${escapeHtml(t("offers_sub"))}</div>
            </div>

            <div class="flex gap-2">
              <button id="changeAnswers" class="btn btn-ghost px-4 py-2.5 font-display font-bold">
                ${escapeHtml(t("change_answers"))}
              </button>
              <button id="resetAll" class="btn btn-danger px-4 py-2.5 font-display font-bold">
                ${escapeHtml(t("restart"))}
              </button>
            </div>
          </div>

          <div class="mt-4 grid sm:grid-cols-2 gap-3">
            <div class="pill p-4">
              <div class="text-xs muted">${escapeHtml(t("summary"))}</div>
              <div class="mt-2 text-sm leading-relaxed">
                <div><span class="font-semibold">${escapeHtml(t("q_goal"))}</span> <span class="muted">${escapeHtml(labelOf("goal", answers.goal))}</span></div>
                <div><span class="font-semibold">${escapeHtml(t("q_need"))}</span> <span class="muted">${escapeHtml(labelOf("need", answers.need))}</span></div>
                <div><span class="font-semibold">${escapeHtml(t("q_volume"))}</span> <span class="muted">${escapeHtml(labelOf("volume", answers.volume))}</span></div>
                <div><span class="font-semibold">${escapeHtml(t("q_invest"))}</span> <span class="muted">${escapeHtml(labelOf("invest", answers.invest))}</span></div>
                <div><span class="font-semibold">${escapeHtml(t("q_deadline"))}</span> <span class="muted">${escapeHtml(labelOf("deadline", answers.deadline))}</span></div>
              </div>
            </div>

            <div class="pill p-4">
              <div class="text-xs muted">${escapeHtml(t("obs"))}</div>
              <div class="mt-2 text-sm muted leading-relaxed">${escapeHtml(OBS)}</div>
            </div>
          </div>
        </div>
      `;

      const cards = offers.map(of=>{
        const best = of.tier==="value";
        const top3 = of.lines.slice(0,3).map(x=>{
          const label = isPlan(x.svc)
            ? `${x.svc.titulo_venda || x.svc.titulo} • ${money(x.monthly)} /mês`
            : `${x.svc.titulo_venda || x.svc.titulo}`;
          return `<li class="text-sm muted">${escapeHtml(label)}</li>`;
        }).join("");

        const saveLine = of.totalSave
          ? `<div class="text-xs muted mt-1">${escapeHtml(t("save"))}: <span class="font-semibold">${escapeHtml(money(of.totalSave))}</span>${of.discountPerc ? ` <span class="muted">(${of.discountPerc}%)</span>` : ""}</div>`
          : `<div class="text-xs muted mt-1">&nbsp;</div>`;

        return `
          <div class="card p-5 sm:p-6" style="${best ? "border-color: rgba(11,95,255,.34);" : ""}">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="flex items-center gap-2">
                  <div class="font-display font-extrabold">${escapeHtml(offerTitle(of.tier))}</div>
                  ${best ? `<span class="chip px-3 py-1 text-[11px] font-extrabold">${escapeHtml(t("best_seller"))}</span>` : ``}
                </div>
                <div class="text-sm muted mt-1">${escapeHtml(t("est_total"))}</div>
              </div>
              <div class="text-right">
                <div class="font-display text-3xl font-extrabold tracking-tight" style="color: rgba(11,95,255,1);">
                  ${escapeHtml(money(of.total))}
                </div>
                ${saveLine}
              </div>
            </div>

            <ul class="mt-4 space-y-2">${top3}</ul>

            <details class="mt-4">
              <summary class="cursor-pointer select-none text-sm font-extrabold flex items-center justify-between" style="color: rgba(11,95,255,1);">
                <span>${escapeHtml(t("details"))}</span>
                <svg class="i" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </summary>
              <div class="mt-3 pill p-4">
                <ul class="text-sm muted list-disc pl-5 space-y-1">
                  ${of.lines.map(x=>{
                    if(x.kind==="plan") return `<li>${escapeHtml((x.svc.titulo_venda||x.svc.titulo) + " — " + money(x.monthly) + " /mês (" + x.period + ")")}</li>`;
                    const hasDiscount = Number(x.original||0) > Number(x.price||0);
                    return `<li>${escapeHtml((x.svc.titulo_venda||x.svc.titulo) + " — " + money(x.price))}${hasDiscount ? ` <span class="strike">(${escapeHtml(money(x.original))})</span>` : ""}</li>`;
                  }).join("")}
                </ul>
              </div>
            </details>

            <button class="mt-5 btn ${best ? "btn-primary" : "btn-ghost"} w-full px-5 py-3 font-display font-extrabold" data-pick="${escapeHtml(of.tier)}">
              ${escapeHtml(t("choose"))}
            </button>
          </div>
        `;
      }).join("");

      setFade(`
        <div class="fade">
          ${summary}
          <div class="mt-4">
            <div class="grid gap-3 sm:gap-4 sm:grid-cols-2 lg:grid-cols-3">
              ${cards}
            </div>
          </div>
        </div>
      `);

      document.getElementById("changeAnswers").addEventListener("click", ()=>renderStep(Math.min(stepIndex, steps.length-1)));
      document.getElementById("resetAll").addEventListener("click", resetAll);

      app.querySelectorAll("[data-pick]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const tier = btn.getAttribute("data-pick");
          chosenOffer = offersCache.find(o=>o.tier===tier) || offersCache[1];
          initCustomizeState(chosenOffer);
          renderCustomize();
        });
      });
    }

    // -------------------- Customize --------------------
    function initCustomizeState(offer){
      const selectedIds = new Set(offer.items.map(s=>s.__id));
      const extraIds = new Set();
      const periodById = new Map();
      offer.items.forEach(s=>{
        if(isPlan(s)) periodById.set(s.__id, offer.periodById.get(s.__id) || "Mensal");
      });
      customState = {selectedIds, extraIds, periodById};
    }

    function extrasForCustomize(){
      const pool = [];
      const add = (venda)=>{
        const s = findByVenda(venda);
        if(!s) return;
        if(customState.selectedIds.has(s.__id)) return;
        if(pool.find(x=>x.__id===s.__id)) return;
        pool.push(s);
      };

      const g = answers.goal;
      const need = answers.need;

      if(g==="sales" || g==="launch"){
        add("Poster Promocional — Arte personalizada");
        add("Shooting Compact — 10 fotos + 2 vídeos");
        add("Pack Engajamento — 10 artes");
      }
      if(g==="brand"){
        add("Identidade Visual Básica — logomarca");
        add("Website Corporativo Básico");
      }
      if(g==="edu"){
        add("Voz Profissional (IA) — por bloco");
        add("Trilha Sonora Exclusiva por IA");
      }
      if(g==="intl"){
        add("Dublagem profissional por IA");
      }
      if(need==="mascot"){
        add("Starter Pack — 1x 30s + 3 poses");
        add("Brand Pack — 1x 1min + 3 poses");
      }

      return pool.slice(0,6);
    }

    function computeCustomizeTotals(){
      const items = [];
      customState.selectedIds.forEach(id=>{
        const s = services.find(x=>x.__id===id);
        if(s) items.push(s);
      });
      customState.extraIds.forEach(id=>{
        const s = services.find(x=>x.__id===id);
        if(s) items.push(s);
      });
      return calcTotals(items, chosenOffer.discountPerc || 0, customState.periodById);
    }

    function buildWhatsAppMessage(note){
      const totals = computeCustomizeTotals();
      const lines = [];

      lines.push(lang==="en" ? "Hi! I want a quote with Comerc IAs." : "Olá! Quero um orçamento com a Comerc IAs.");
      lines.push("");
      lines.push((lang==="en" ? "Chosen offer: " : "Oferta escolhida: ") + offerTitle(chosenOffer.tier));
      lines.push("");

      lines.push(lang==="en" ? "Quiz summary:" : "Resumo do quiz:");
      lines.push(`- ${t("q_goal")} ${labelOf("goal", answers.goal)}`);
      lines.push(`- ${t("q_need")} ${labelOf("need", answers.need)}`);
      lines.push(`- ${t("q_volume")} ${labelOf("volume", answers.volume)}`);
      lines.push(`- ${t("q_invest")} ${labelOf("invest", answers.invest)}`);
      lines.push(`- ${t("q_deadline")} ${labelOf("deadline", answers.deadline)}`);
      lines.push("");

      lines.push(lang==="en" ? "Included services:" : "Serviços incluídos:");
      totals.lines.forEach(x=>{
        const label = x.kind==="plan"
          ? `${x.svc.titulo_venda || x.svc.titulo} — ${money(x.monthly)}/mês (${x.period})`
          : `${x.svc.titulo_venda || x.svc.titulo} — ${money(x.price)}`;
        lines.push("- " + label);
      });

      lines.push("");
      lines.push((lang==="en" ? "Estimated total: " : "Total estimado: ") + money(totals.total));
      if(totals.totalSave){
        lines.push((lang==="en" ? "Estimated savings: " : "Economia estimada: ") + money(totals.totalSave));
      }
      if(totals.discount){
        lines.push((lang==="en" ? "Bundle discount: " : "Desconto de combo: ") + "-" + money(totals.discount) + ` (${chosenOffer.discountPerc}%)`);
      }

      if(note && note.trim()){
        lines.push("");
        lines.push(lang==="en" ? "Notes:" : "Observações:");
        lines.push(note.trim());
      }

      lines.push("");
      lines.push(lang==="en" ? "Can you confirm availability and next steps?" : "Pode me confirmar disponibilidade e próximos passos?");
      return lines.join("\n");
    }

    function openWhatsApp(){
      const note = document.getElementById("noteField")?.value || "";
      const msg = buildWhatsAppMessage(note);
      window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`, "_blank");
    }

    async function copyPreview(){
      const note = document.getElementById("noteField")?.value || "";
      const msg = buildWhatsAppMessage(note);
      try{
        await navigator.clipboard.writeText(msg);
        const b = document.getElementById("copyBtn");
        const old = b.textContent;
        b.textContent = t("copied");
        setTimeout(()=>b.textContent = old, 1200);
      }catch(e){
        // fallback
        const ta = document.getElementById("previewBox");
        ta.focus();
        ta.select();
        document.execCommand("copy");
      }
    }

    function updateCustomizeTotalsUI(){
      const totals = computeCustomizeTotals();
      const totalEl = document.getElementById("totalValue");
      const saveEl  = document.getElementById("saveValue");
      const preview = document.getElementById("previewBox");

      if(totalEl) totalEl.textContent = money(totals.total);
      if(saveEl) saveEl.textContent = totals.totalSave ? money(totals.totalSave) : "—";
      if(preview){
        const note = document.getElementById("noteField")?.value || "";
        preview.value = buildWhatsAppMessage(note);
      }
      saveState();
    }

    function renderCustomize(){
      view = "customize";
      saveState();

      const pct = progressPct();
      const extras = extrasForCustomize();
      const totals = computeCustomizeTotals();
      const best = chosenOffer.tier==="value";

      const includedCards = chosenOffer.items.map(s=>{
        const priceLine = isPlan(s)
          ? (()=>{ const p = getPlanPeriod(s, customState.periodById.get(s.__id) || "Mensal"); return `${money(p.monthly)}/mês (${p.periodo})`; })()
          : money(s.preco);

        const original = Number(s.preco_original||s.preco||0);
        const current  = Number(s.preco||0);
        const showStrike = (!isPlan(s) && original > current);

        return `
          <div class="pill p-4">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="font-display font-extrabold">${escapeHtml(s.titulo_venda || s.titulo)}</div>
                <div class="text-sm muted mt-1">${escapeHtml(s.descricao || "")}</div>
                <div class="mt-2 flex flex-wrap gap-2">
                  <span class="chip px-3 py-1 text-xs font-extrabold">${escapeHtml(s.__cat)}</span>
                  <span class="pill px-3 py-1 text-xs">${escapeHtml(s.prazo_entrega || "-")}</span>
                </div>
              </div>
              <div class="text-right shrink-0">
                <div class="font-display font-extrabold" style="color: rgba(11,95,255,1);">
                  ${escapeHtml(priceLine)}
                </div>
                ${showStrike ? `<div class="text-xs muted strike">${escapeHtml(money(original))}</div>` : `<div class="text-xs muted">&nbsp;</div>`}
              </div>
            </div>
          </div>
        `;
      }).join("");

      const extrasCards = extras.map(s=>{
        const checked = customState.extraIds.has(s.__id);
        const priceLine = isPlan(s)
          ? (()=>{ const p = getPlanPeriod(s, customState.periodById.get(s.__id) || "Mensal"); return `${money(p.monthly)}/mês (${p.periodo})`; })()
          : money(s.preco);

        const original = Number(s.preco_original||s.preco||0);
        const current  = Number(s.preco||0);
        const showStrike = (!isPlan(s) && original > current);

        return `
          <label class="pill p-4 block cursor-pointer">
            <div class="flex items-start gap-3">
              <input type="checkbox"
                class="mt-1 w-5 h-5 accent-[rgba(11,95,255,1)]"
                data-extra="${escapeHtml(s.__id)}" ${checked ? "checked":""} />
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <div class="font-display font-extrabold">${escapeHtml(s.titulo_venda || s.titulo)}</div>
                    <div class="text-sm muted mt-1">${escapeHtml(s.descricao || "")}</div>
                  </div>
                  <div class="text-right shrink-0">
                    <div class="font-display font-extrabold" style="color: rgba(11,95,255,1);">${escapeHtml(priceLine)}</div>
                    ${showStrike ? `<div class="text-xs muted strike">${escapeHtml(money(original))}</div>` : `<div class="text-xs muted">&nbsp;</div>`}
                  </div>
                </div>
                <div class="mt-2 flex flex-wrap gap-2">
                  <span class="chip px-3 py-1 text-xs font-extrabold">${escapeHtml(s.__cat)}</span>
                  <span class="pill px-3 py-1 text-xs">${escapeHtml(s.prazo_entrega || "-")}</span>
                </div>
              </div>
            </div>
          </label>
        `;
      }).join("");

      setFade(`
        <div class="fade">
          <div class="card p-5 sm:p-6">
            ${renderTopProgress()}

            <div class="mt-4 flex items-start justify-between gap-4">
              <div class="min-w-0">
                <div class="flex items-center gap-2">
                  <div class="chip px-3 py-1 text-[11px] font-extrabold">${escapeHtml(offerTitle(chosenOffer.tier))}</div>
                  ${best ? `<div class="chip px-3 py-1 text-[11px] font-extrabold">${escapeHtml(t("best_seller"))}</div>` : ``}
                </div>
                <div class="font-display text-xl sm:text-2xl font-extrabold mt-2">${escapeHtml(t("customize_title"))}</div>
                <div class="text-sm muted mt-1">${escapeHtml(t("customize_sub"))}</div>
              </div>

              <div class="min-w-[190px] text-right">
                <div class="text-xs muted">${escapeHtml(t("est_total"))}</div>
                <div id="totalValue" class="font-display text-3xl font-extrabold tracking-tight" style="color: rgba(11,95,255,1);">${escapeHtml(money(totals.total))}</div>
                <div class="text-xs muted mt-1">${escapeHtml(t("save"))}: <span class="font-semibold" id="saveValue">${totals.totalSave ? escapeHtml(money(totals.totalSave)) : "—"}</span></div>

                <div class="mt-2">
                  <div class="text-xs muted text-right">${pct}%</div>
                  <div class="h-2 rounded-full overflow-hidden" style="background: rgba(11,95,255,.10);">
                    <div class="h-2" style="width:${pct}%; background: linear-gradient(90deg, rgba(11,95,255,1), rgba(46,123,255,1));"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-4 grid gap-4 lg:grid-cols-12">
            <div class="lg:col-span-5 space-y-4">
              <div class="card p-5">
                <div class="font-display font-extrabold">${escapeHtml(t("summary"))}</div>
                <div class="mt-3 text-sm leading-relaxed">
                  <div><span class="font-semibold">${escapeHtml(t("q_goal"))}</span> <span class="muted">${escapeHtml(labelOf("goal", answers.goal))}</span></div>
                  <div><span class="font-semibold">${escapeHtml(t("q_need"))}</span> <span class="muted">${escapeHtml(labelOf("need", answers.need))}</span></div>
                  <div><span class="font-semibold">${escapeHtml(t("q_volume"))}</span> <span class="muted">${escapeHtml(labelOf("volume", answers.volume))}</span></div>
                  <div><span class="font-semibold">${escapeHtml(t("q_invest"))}</span> <span class="muted">${escapeHtml(labelOf("invest", answers.invest))}</span></div>
                  <div><span class="font-semibold">${escapeHtml(t("q_deadline"))}</span> <span class="muted">${escapeHtml(labelOf("deadline", answers.deadline))}</span></div>
                </div>
              </div>

              <div class="card p-5">
                <div class="font-display font-extrabold">${escapeHtml(t("note"))}</div>
                <textarea id="noteField"
                  class="mt-2 w-full rounded-2xl border px-4 py-3 text-sm min-h-[110px] scrollbar"
                  style="border-color: var(--btnGhostStroke); background: var(--btnGhostBg); color: var(--text);"
                  placeholder="${escapeHtml(t("note_ph"))}"></textarea>

                <div class="mt-3 grid grid-cols-2 gap-2">
                  <button id="sendWA" class="btn btn-primary w-full px-5 py-3 font-display font-extrabold">
                    ${escapeHtml(t("send_wa"))}
                  </button>
                  <button id="copyBtn" class="btn btn-ghost w-full px-5 py-3 font-display font-extrabold">
                    ${escapeHtml(t("copy_msg"))}
                  </button>
                </div>

                <div class="mt-3 pill p-4">
                  <div class="font-display font-extrabold">${escapeHtml(t("preview"))}</div>
                  <textarea id="previewBox" class="mt-2 w-full rounded-2xl border px-4 py-3 text-xs min-h-[140px] scrollbar"
                    style="border-color: var(--btnGhostStroke); background: rgba(255,255,255,.55); color: var(--text);" readonly></textarea>
                </div>

                <div class="mt-3 text-xs muted">
                  <span class="font-semibold" style="color: var(--text);">${escapeHtml(t("obs"))}:</span> ${escapeHtml(OBS)}
                </div>

                <div class="mt-3 flex gap-2">
                  <button id="backToOffers" class="btn btn-ghost px-4 py-2.5 font-display font-bold">${escapeHtml(t("back"))}</button>
                  <button id="resetAll2" class="btn btn-danger px-4 py-2.5 font-display font-bold">${escapeHtml(t("restart"))}</button>
                </div>
              </div>
            </div>

            <div class="lg:col-span-7 space-y-4">
              <div class="card p-5">
                <div class="font-display font-extrabold">${escapeHtml(t("included"))}</div>
                <div class="mt-3 grid gap-3">
                  ${includedCards}
                </div>
              </div>

              <div class="card p-5">
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <div class="font-display font-extrabold">${escapeHtml(t("extras"))}</div>
                    <div class="text-sm muted mt-1">${escapeHtml(t("customize_sub"))}</div>
                  </div>
                  <span class="chip px-3 py-1 text-[11px] font-extrabold">${escapeHtml(lang==="en" ? "Optional" : "Opcional")}</span>
                </div>
                <div class="mt-3 grid gap-3">
                  ${extrasCards || `<div class="pill p-4 text-sm muted">${escapeHtml(lang==="en" ? "No suggested add-ons." : "Sem extras sugeridos.")}</div>`}
                </div>
              </div>
            </div>
          </div>
        </div>
      `);

      // set initial preview
      updateCustomizeTotalsUI();

      document.getElementById("sendWA").addEventListener("click", openWhatsApp);
      document.getElementById("copyBtn").addEventListener("click", copyPreview);
      document.getElementById("backToOffers").addEventListener("click", renderOffers);
      document.getElementById("resetAll2").addEventListener("click", resetAll);

      document.getElementById("noteField").addEventListener("input", ()=>{
        updateCustomizeTotalsUI();
      });

      app.querySelectorAll("[data-extra]").forEach(ch=>{
        ch.addEventListener("change", ()=>{
          const id = ch.getAttribute("data-extra");
          if(ch.checked) customState.extraIds.add(id);
          else customState.extraIds.delete(id);
          updateCustomizeTotalsUI();
        });
      });
    }

    // -------------------- Reset --------------------
    function resetAll(){
      answers = {};
      stepIndex = 0;
      view = "intro";
      chosenOffer = null;
      customState = null;
      offersCache = null;
      clearState();
      renderIntro();
    }

    // -------------------- Lang buttons --------------------
    document.getElementById("langPT").addEventListener("click", ()=>{
      lang = "pt";
      applyLangUI();
      rerenderCurrent();
    });
    document.getElementById("langEN").addEventListener("click", ()=>{
      lang = "en";
      applyLangUI();
      rerenderCurrent();
    });

    function rerenderCurrent(){
      if(view==="intro") renderIntro();
      else if(view==="quiz") renderStep(stepIndex);
      else if(view==="offers") renderOffers();
      else if(view==="customize") renderCustomize();
    }

    // -------------------- Theme button --------------------
    document.getElementById("themeBtn").addEventListener("click", ()=>{
      const cur = root.getAttribute("data-theme") || "light";
      setTheme(cur === "dark" ? "light" : "dark");
      rerenderCurrent();
    });

    // -------------------- Init --------------------
    const initialTheme = getSavedTheme() || (prefersDark() ? "dark" : "light");
    root.setAttribute("data-theme", initialTheme);

    applyLangUI();

    // restore state if exists
    const st = loadState();
    if(st && st.view){
      try{
        answers = st.answers || {};
        stepIndex = Number(st.stepIndex || 0);
        view = st.view || "intro";

        if(st.chosenTier){
          offersCache = buildOffers();
          chosenOffer = offersCache.find(o=>o.tier===st.chosenTier) || null;
        }

        if(st.custom && chosenOffer){
          const selectedIds = new Set(st.custom.selectedIds || []);
          const extraIds = new Set(st.custom.extraIds || []);
          const periodById = new Map(st.custom.periodById || []);
          customState = {selectedIds, extraIds, periodById};
        }

        rerenderCurrent();
      }catch(e){
        renderIntro();
      }
    }else{
      renderIntro();
    }
  })();
  </script>
</body>
</html>
