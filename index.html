<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Service Finder • Comercias</title>

  <!-- Premium font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          boxShadow: {
            soft: '0 14px 55px rgba(0,0,0,.18)',
            glow: '0 0 0 1px rgba(255,255,255,.08), 0 25px 80px rgba(0,0,0,.30)'
          }
        }
      }
    }
  </script>

  <style>
    :root { color-scheme: light; }
    .fade { opacity: 0; transform: translateY(10px) scale(.995); transition: all .28s ease; }
    .fade.show { opacity: 1; transform: translateY(0) scale(1); }
    .modal-anim { opacity: 0; transform: translateY(8px) scale(.985); transition: all .22s ease; }
    .modal-anim.show { opacity: 1; transform: translateY(0) scale(1); }
    .noise {
      background-image:
        radial-gradient(1200px 600px at 10% 10%, rgba(99,102,241,.35), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(14,165,233,.25), transparent 60%),
        radial-gradient(900px 500px at 40% 90%, rgba(168,85,247,.18), transparent 60%),
        linear-gradient(180deg, rgba(2,6,23,1), rgba(2,6,23,.92));
      position: relative;
      overflow: hidden;
    }
    .noise:before{
      content:"";
      position:absolute; inset:-10%;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='260'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='260' height='260' filter='url(%23n)' opacity='.10'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.45;
      pointer-events:none;
      transform: rotate(2deg);
    }
    .ring-focus:focus { outline: none; box-shadow: 0 0 0 4px rgba(99,102,241,.25); }
    .seg-btn { transition: all .18s ease; }
    .seg-btn.active { background: rgba(255,255,255,.12); border-color: rgba(255,255,255,.22); }
  </style>
</head>

<body class="noise min-h-screen flex items-center justify-center p-5 md:p-8 font-sans">

  <!-- Page shell -->
  <main class="w-full max-w-4xl">
    <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-glow overflow-hidden">
      <div class="px-6 md:px-10 py-10 md:py-12">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-white/10 bg-white/5 text-white/80 text-xs">
              <span class="inline-block w-2 h-2 rounded-full bg-emerald-400"></span>
              <span id="topBadge">Quiz inteligente • Combos • Descontos</span>
            </div>
            <h1 id="topTitle" class="mt-4 text-3xl md:text-4xl font-extrabold tracking-tight text-white">
              Encontre o serviço ideal
            </h1>
            <p id="topSub" class="mt-3 text-white/75 text-base md:text-lg max-w-2xl">
              Responda em ~2 minutos. No final, você escolhe os serviços e vai para o orçamento já preenchido.
            </p>
          </div>

          <!-- Language switch (outside modal too) -->
          <div class="shrink-0">
            <div class="inline-flex items-center gap-1 p-1 rounded-2xl border border-white/10 bg-white/5">
              <button id="langPTTop" class="seg-btn active px-3 py-1.5 rounded-xl border border-transparent text-white/90 text-sm ring-focus">PT</button>
              <button id="langENTop" class="seg-btn px-3 py-1.5 rounded-xl border border-transparent text-white/75 text-sm ring-focus">EN</button>
            </div>
          </div>
        </div>

        <div class="mt-8 grid md:grid-cols-3 gap-4">
          <div class="rounded-2xl border border-white/10 bg-white/5 p-5">
            <div class="text-white font-semibold" id="card1Title">Recomendação automática</div>
            <div class="mt-1 text-white/70 text-sm" id="card1Sub">O quiz sugere serviços e pacotes com base no seu objetivo.</div>
          </div>
          <div class="rounded-2xl border border-white/10 bg-white/5 p-5">
            <div class="text-white font-semibold" id="card2Title">Combos com economia</div>
            <div class="mt-1 text-white/70 text-sm" id="card2Sub">Veja simulações de desconto ao juntar serviços.</div>
          </div>
          <div class="rounded-2xl border border-white/10 bg-white/5 p-5">
            <div class="text-white font-semibold" id="card3Title">Finaliza com 1 clique</div>
            <div class="mt-1 text-white/70 text-sm" id="card3Sub">Você vai para a página de orçamento com o formulário pronto.</div>
          </div>
        </div>

        <div class="mt-8 flex flex-col sm:flex-row gap-3 sm:items-center">
          <button id="openModal"
            class="ring-focus inline-flex items-center justify-center gap-2 px-6 py-3 rounded-2xl bg-gradient-to-r from-indigo-500 to-sky-500 text-white font-semibold shadow-soft hover:opacity-[.95] active:opacity-90">
            <span id="startBtnText">Começar quiz</span>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="opacity-90">
              <path d="M8 5l8 7-8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>

          <div class="text-white/60 text-sm" id="hintText">
            Para carregar <code class="px-1.5 py-0.5 rounded bg-white/10 border border-white/10">precos.json</code>, rode via servidor (ex.: Live Server).
          </div>
        </div>
      </div>

      <div class="px-6 md:px-10 py-5 border-t border-white/10 bg-black/10 text-white/60 text-xs">
        <span id="footerNote">*Descontos de combo são simulados. Planos já incluem desconto por período.</span>
      </div>
    </div>
  </main>

  <!-- MODAL -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center p-4 md:p-8">
    <div id="backdrop" class="absolute inset-0 bg-black/60"></div>

    <div id="modalPanel" class="modal-anim relative w-[min(1040px,98vw)] rounded-3xl overflow-hidden shadow-glow border border-white/10 bg-white/10 backdrop-blur-2xl">
      <!-- Header -->
      <div class="flex items-center justify-between px-5 md:px-7 py-4 border-b border-white/10 bg-black/10">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-2xl bg-white/10 border border-white/10 flex items-center justify-center">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-white/85">
              <path d="M12 2v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 18v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M4.93 4.93l2.83 2.83" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M16.24 16.24l2.83 2.83" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M2 12h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M18 12h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M4.93 19.07l2.83-2.83" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M16.24 7.76l2.83-2.83" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <div id="modalTitle" class="text-white font-bold tracking-tight">Quiz inteligente</div>
            <div id="modalSub" class="text-white/60 text-xs">Recomenda pacotes • Simula descontos • Pré-preenche o orçamento</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <!-- language segmented -->
          <div class="inline-flex items-center gap-1 p-1 rounded-2xl border border-white/10 bg-white/5">
            <button id="langPT" class="seg-btn active px-3 py-1.5 rounded-xl border border-transparent text-white/90 text-sm ring-focus">PT</button>
            <button id="langEN" class="seg-btn px-3 py-1.5 rounded-xl border border-transparent text-white/75 text-sm ring-focus">EN</button>
          </div>
          <button id="closeModal" class="ring-focus p-2 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-white/80" aria-label="Close">
            ✕
          </button>
        </div>
      </div>

      <!-- Content -->
      <div class="grid md:grid-cols-[1.35fr_.65fr]">
        <!-- Main -->
        <div class="p-5 md:p-7">
          <div id="app">
            <div class="text-center text-white/70">Loading…</div>
          </div>
        </div>

        <!-- Side -->
        <aside class="p-5 md:p-7 border-t md:border-t-0 md:border-l border-white/10 bg-black/10">
          <div class="flex items-center justify-between mb-2">
            <h3 id="sideTitle" class="font-semibold text-white/90">Seu resumo</h3>
            <span id="progressText" class="text-xs text-white/55">0%</span>
          </div>

          <div class="w-full bg-white/10 rounded-full h-2 mb-4 overflow-hidden">
            <div id="progressBar" class="bg-gradient-to-r from-indigo-400 to-sky-400 h-2 rounded-full" style="width:0%"></div>
          </div>

          <div id="sideSummary" class="text-sm text-white/80 space-y-2">
            <div class="text-white/55" id="sideEmpty">Responda o quiz para ver recomendações.</div>
          </div>

          <div class="mt-5 p-4 rounded-2xl border border-white/10 bg-white/5">
            <div id="sideTotalsTitle" class="text-sm font-semibold text-white/90 mb-2">Simulação</div>
            <div id="sideTotals" class="text-sm text-white/80 space-y-1">
              <div class="flex justify-between"><span id="lblSub">Subtotal</span><span>—</span></div>
              <div class="flex justify-between"><span id="lblDisc">Desconto</span><span>—</span></div>
              <div class="flex justify-between font-bold"><span id="lblTotal">Total</span><span>—</span></div>
            </div>
            <div id="sideNote" class="mt-2 text-xs text-white/55">
              *Combos: 2=5%, 3=8%, 4+=12% (simulado).
            </div>
          </div>

          <div class="mt-4 text-xs text-white/50" id="sideStrategy">
            Estratégia: mostramos o essencial e elevamos o impacto com recomendações.
          </div>
        </aside>
      </div>

      <!-- Footer nav -->
      <div class="flex items-center justify-between px-5 md:px-7 py-4 border-t border-white/10 bg-black/10">
        <button id="backBtn"
          class="hidden ring-focus bg-white/10 hover:bg-white/15 text-white/90 py-2.5 px-4 rounded-2xl border border-white/10">
          Voltar
        </button>

        <div id="stepCounter" class="text-xs text-white/55">—</div>

        <button id="nextBtn"
          class="hidden ring-focus bg-gradient-to-r from-indigo-500 to-sky-500 hover:opacity-[.95] text-white py-2.5 px-4 rounded-2xl font-semibold">
          Continuar
        </button>
      </div>
    </div>
  </div>

<script>
(async function(){
  // ---------- DOM ----------
  const modal = document.getElementById('modal');
  const modalPanel = document.getElementById('modalPanel');
  const openModalBtn = document.getElementById('openModal');
  const closeModalBtn = document.getElementById('closeModal');
  const backdrop = document.getElementById('backdrop');

  const app = document.getElementById('app');
  const sideSummary = document.getElementById('sideSummary');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const stepCounter = document.getElementById('stepCounter');
  const backBtn = document.getElementById('backBtn');
  const nextBtn = document.getElementById('nextBtn');
  const sideTotals = document.getElementById('sideTotals');

  // top lang buttons
  const langPTTop = document.getElementById('langPTTop');
  const langENTop = document.getElementById('langENTop');
  const langPT = document.getElementById('langPT');
  const langEN = document.getElementById('langEN');

  // ---------- utils ----------
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function formatPrice(n){
    const num = Number(n);
    if(!isFinite(num)) return String(n);
    return new Intl.NumberFormat(currentLang === 'en' ? 'en-US' : 'pt-BR', {style:'currency', currency:'BRL'}).format(num);
  }
  function setFade(html){
    app.innerHTML = html;
    const el = app.querySelector('.fade');
    if(el) setTimeout(()=>el.classList.add('show'), 10);
  }
  function showModal(){
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setTimeout(()=>modalPanel.classList.add('show'), 10);
  }
  function hideModal(){
    modalPanel.classList.remove('show');
    setTimeout(()=>{
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }, 160);
  }

  // ---------- i18n ----------
  const i18n = {
    pt: {
      topBadge: "Quiz inteligente • Combos • Descontos",
      topTitle: "Encontre o serviço ideal",
      topSub: "Responda em ~2 minutos. No final, você escolhe os serviços e vai para o orçamento já preenchido.",
      card1Title: "Recomendação automática",
      card1Sub: "O quiz sugere serviços e pacotes com base no seu objetivo.",
      card2Title: "Combos com economia",
      card2Sub: "Veja simulações de desconto ao juntar serviços.",
      card3Title: "Finaliza com 1 clique",
      card3Sub: "Você vai para a página de orçamento com o formulário pronto.",
      startBtnText: "Começar quiz",
      hintText: "Para carregar precos.json, rode via servidor (ex.: Live Server).",
      footerNote: "*Descontos de combo são simulados. Planos já incluem desconto por período.",

      modalTitle: "Quiz inteligente",
      modalSub: "Recomenda pacotes • Simula descontos • Pré-preenche o orçamento",
      sideTitle: "Seu resumo",
      sideEmpty: "Responda o quiz para ver recomendações.",
      sideTotalsTitle: "Simulação",
      lblSub: "Subtotal",
      lblDisc: "Desconto",
      lblTotal: "Total",
      sideNote: "*Combos: 2=5%, 3=8%, 4+=12% (simulado).",
      sideStrategy: "Estratégia: mostramos o essencial e elevamos o impacto com recomendações.",

      back: "Voltar",
      next: "Continuar",

      startTitle: "Monte seu orçamento em 2 minutos",
      startSubtitle: "Responda algumas perguntas e receba pacotes recomendados + simulação de desconto.",
      startCTA: "Começar",

      q_objective: "1) Qual o objetivo principal?",
      o_sales: "Gerar vendas / conversão (promoção, campanhas, anúncios)",
      o_social: "Conteúdo contínuo para redes sociais (semanal/mensal)",
      o_branding: "Fortalecer marca / branding (visual profissional)",
      o_edu: "Educar / conteúdo técnico (explicar, ensinar, tutorial)",

      q_channels: "2) Onde você vai publicar?",
      ch_instagram: "Instagram (Feed/Stories/Reels)",
      ch_tiktok: "TikTok",
      ch_shorts: "YouTube Shorts",
      ch_whatsapp: "WhatsApp",
      ch_site: "Site",
      ch_multi: "Vários canais",

      q_freq: "3) Frequência desejada",
      f_one: "Pontual (uma campanha ou entrega única)",
      f_week: "Semanal (consistência)",
      f_month: "Mensal (conteúdo contínuo)",

      q_type: "4) Você já sabe qual tipo de serviço procura?",
      type_auto: "Não tenho certeza (quero recomendação)",

      q_assets: "5) Você já tem materiais prontos?",
      a_logo: "Tenho logo/identidade visual",
      a_photos: "Tenho fotos do produto/serviço",
      a_videos: "Tenho vídeos gravados",
      a_text: "Tenho roteiro/textos",
      a_none: "Não tenho nada ainda",

      q_volume: "6) Volume aproximado",
      v_low: "Pequeno (1–5 artes / vídeo curto)",
      v_mid: "Médio (6–15 artes / 30s)",
      v_high: "Alto (>15 artes / vídeo premium)",

      q_style: "7) Estilo preferido",
      s_clean: "Minimalista / clean",
      s_promo: "Impactante / promocional",
      s_premium: "Premium / institucional",
      s_fun: "Criativo / divertido",

      q_preference: "8) Prefere pacote completo ou serviço avulso?",
      p_combo: "Pacote (combos com economia)",
      p_single: "Avulso (apenas 1 serviço)",
      p_any: "Indiferente",

      q_budget: "9) Faixa de orçamento (aproximada)",
      b_100: "Até R$100",
      b_300: "Até R$300",
      b_800: "Até R$800",
      b_more: "Acima de R$800",

      q_deadline: "10) Prazo desejado (opcional)",
      d_3: "Até 3 dias",
      d_7: "Até 7 dias",
      d_more: "Mais que 7 dias",
      d_skip: "Não sei / sem pressa",

      clickToAdvance: "Clique em uma opção para avançar.",
      selectAndContinue: "Selecione opção(ões) e clique em Continuar.",
      continueBtn: "Continuar",

      resultsTitle: "Resultado do quiz",
      resultsSub: "Escolha um pacote pronto (recomendado) ou personalize marcando os serviços.",
      redo: "Refazer",
      customizeTitle: "Serviços sugeridos (personalize)",
      customizeHint: "Dica: 2+ serviços liberam desconto de combo.",
      summaryAuto: "Resumo automático (vai no orçamento)",
      finalize: "Finalizar e ir para o orçamento (pré-preenchido)",
      copy: "Copiar resumo",
      copied: "Copiado!",
      obs: "Observações",

      tier_essential: "Essencial",
      tier_recommended: "Recomendado",
      tier_aggressive: "Agressivo",
      badge_essential: "Começar rápido",
      badge_recommended: "Melhor custo-benefício",
      badge_aggressive: "Máximo impacto",
      apply: "Aplicar",
      estimatedTotal: "Total estimado",
      simulated: "*Simulação automática. Você pode adicionar/remover itens abaixo.",

      planPeriod: "Período do plano",
      period_monthly: "Mensal",
      period_quarterly: "Trimestral",
      period_semi: "Semestral",
      period_yearly: "Anual",
      saves: "economiza",

      subtotalAvulso: "Subtotal (avulsos)",
      comboDiscount: "Desconto combo",
      plans: "Planos"
    },

    en: {
      topBadge: "Smart quiz • Bundles • Discounts",
      topTitle: "Find the perfect service",
      topSub: "Answer in ~2 minutes. At the end, choose services and go to a pre-filled quote form.",
      card1Title: "Auto recommendations",
      card1Sub: "The quiz suggests services and bundles based on your goal.",
      card2Title: "Bundles with savings",
      card2Sub: "See discount simulations when combining services.",
      card3Title: "Finish in 1 click",
      card3Sub: "You’ll land on the quote page with the form already filled.",
      startBtnText: "Start quiz",
      hintText: "To load precos.json, run via a local server (e.g., Live Server).",
      footerNote: "*Bundle discounts are simulated. Plans already include period discounts.",

      modalTitle: "Smart quiz",
      modalSub: "Suggests bundles • Simulates discounts • Pre-fills your quote",
      sideTitle: "Your summary",
      sideEmpty: "Answer the quiz to see recommendations.",
      sideTotalsTitle: "Simulation",
      lblSub: "Subtotal",
      lblDisc: "Discount",
      lblTotal: "Total",
      sideNote: "*Bundles: 2=5%, 3=8%, 4+=12% (simulated).",
      sideStrategy: "Strategy: we show the essentials first, then boost impact with recommendations.",

      back: "Back",
      next: "Continue",

      startTitle: "Build your quote in 2 minutes",
      startSubtitle: "Answer a few questions and get recommended bundles + discount simulation.",
      startCTA: "Start",

      q_objective: "1) What’s your main goal?",
      o_sales: "Drive sales / conversions (promo, campaigns, ads)",
      o_social: "Ongoing social media content (weekly/monthly)",
      o_branding: "Strengthen brand / branding (professional visuals)",
      o_edu: "Educate / technical content (explain, teach, tutorials)",

      q_channels: "2) Where will you publish?",
      ch_instagram: "Instagram (Feed/Stories/Reels)",
      ch_tiktok: "TikTok",
      ch_shorts: "YouTube Shorts",
      ch_whatsapp: "WhatsApp",
      ch_site: "Website",
      ch_multi: "Multiple channels",

      q_freq: "3) Desired frequency",
      f_one: "One-off (single campaign or delivery)",
      f_week: "Weekly (consistency)",
      f_month: "Monthly (ongoing content)",

      q_type: "4) Do you already know what type of service you want?",
      type_auto: "Not sure (recommend for me)",

      q_assets: "5) Do you have materials ready?",
      a_logo: "I have a logo/visual identity",
      a_photos: "I have product/service photos",
      a_videos: "I have recorded videos",
      a_text: "I have scripts/texts",
      a_none: "I have nothing yet",

      q_volume: "6) Estimated volume",
      v_low: "Small (1–5 designs / short video)",
      v_mid: "Medium (6–15 designs / 30s)",
      v_high: "High (>15 designs / premium video)",

      q_style: "7) Preferred style",
      s_clean: "Minimal / clean",
      s_promo: "Bold / promotional",
      s_premium: "Premium / corporate",
      s_fun: "Creative / fun",

      q_preference: "8) Prefer a bundle or a single service?",
      p_combo: "Bundle (with savings)",
      p_single: "Single service",
      p_any: "No preference",

      q_budget: "9) Budget range (approx.)",
      b_100: "Up to R$100",
      b_300: "Up to R$300",
      b_800: "Up to R$800",
      b_more: "Above R$800",

      q_deadline: "10) Desired deadline (optional)",
      d_3: "Up to 3 days",
      d_7: "Up to 7 days",
      d_more: "More than 7 days",
      d_skip: "Not sure / no rush",

      clickToAdvance: "Click an option to continue.",
      selectAndContinue: "Select option(s) and click Continue.",
      continueBtn: "Continue",

      resultsTitle: "Your quiz results",
      resultsSub: "Pick a ready bundle (recommended) or customize by selecting services.",
      redo: "Restart",
      customizeTitle: "Suggested services (customize)",
      customizeHint: "Tip: 2+ services unlock bundle discount.",
      summaryAuto: "Auto summary (goes to quote)",
      finalize: "Finish and go to quote (pre-filled)",
      copy: "Copy summary",
      copied: "Copied!",
      obs: "Notes",

      tier_essential: "Essential",
      tier_recommended: "Recommended",
      tier_aggressive: "Aggressive",
      badge_essential: "Start fast",
      badge_recommended: "Best value",
      badge_aggressive: "Max impact",
      apply: "Apply",
      estimatedTotal: "Estimated total",
      simulated: "*Automatic simulation. You can add/remove items below.",

      planPeriod: "Plan period",
      period_monthly: "Monthly",
      period_quarterly: "Quarterly",
      period_semi: "Semiannual",
      period_yearly: "Annual",
      saves: "save",

      subtotalAvulso: "Subtotal (one-offs)",
      comboDiscount: "Bundle discount",
      plans: "Plans"
    }
  };

  let currentLang = (localStorage.getItem('comercias_lang') || '').toLowerCase();
  if(currentLang !== 'pt' && currentLang !== 'en'){
    const nav = (navigator.language || 'pt').toLowerCase();
    currentLang = nav.startsWith('en') ? 'en' : 'pt';
  }

  function t(key){ return (i18n[currentLang] && i18n[currentLang][key]) ? i18n[currentLang][key] : key; }

  function syncLangButtons(){
    [langPT, langPTTop].forEach(b=>b.classList.toggle('active', currentLang==='pt'));
    [langEN, langENTop].forEach(b=>b.classList.toggle('active', currentLang==='en'));
    [langPT, langPTTop].forEach(b=>b.classList.toggle('text-white/90', currentLang==='pt'));
    [langEN, langENTop].forEach(b=>b.classList.toggle('text-white/90', currentLang==='en'));
    [langPT, langPTTop].forEach(b=>b.classList.toggle('text-white/75', currentLang!=='pt'));
    [langEN, langENTop].forEach(b=>b.classList.toggle('text-white/75', currentLang!=='en'));
  }

  function applyTopCopy(){
    document.getElementById('topBadge').textContent = t('topBadge');
    document.getElementById('topTitle').textContent = t('topTitle');
    document.getElementById('topSub').textContent = t('topSub');
    document.getElementById('card1Title').textContent = t('card1Title');
    document.getElementById('card1Sub').textContent = t('card1Sub');
    document.getElementById('card2Title').textContent = t('card2Title');
    document.getElementById('card2Sub').textContent = t('card2Sub');
    document.getElementById('card3Title').textContent = t('card3Title');
    document.getElementById('card3Sub').textContent = t('card3Sub');
    document.getElementById('startBtnText').textContent = t('startBtnText');
    document.getElementById('hintText').innerHTML = t('hintText')
      .replace('precos.json', `<code class="px-1.5 py-0.5 rounded bg-white/10 border border-white/10">precos.json</code>`);
    document.getElementById('footerNote').textContent = t('footerNote');

    document.getElementById('modalTitle').textContent = t('modalTitle');
    document.getElementById('modalSub').textContent = t('modalSub');
    document.getElementById('sideTitle').textContent = t('sideTitle');
    document.getElementById('sideEmpty').textContent = t('sideEmpty');
    document.getElementById('sideTotalsTitle').textContent = t('sideTotalsTitle');
    document.getElementById('lblSub').textContent = t('lblSub');
    document.getElementById('lblDisc').textContent = t('lblDisc');
    document.getElementById('lblTotal').textContent = t('lblTotal');
    document.getElementById('sideNote').textContent = t('sideNote');
    document.getElementById('sideStrategy').textContent = t('sideStrategy');

    backBtn.textContent = t('back');
    nextBtn.textContent = t('next');
  }

  function setLang(lang){
    currentLang = lang;
    localStorage.setItem('comercias_lang', lang);
    syncLangButtons();
    applyTopCopy();
    // rerender current screen
    if(state.index >= questions.length){
      renderResults(true);
    } else {
      renderQuestion(state.index, true);
    }
  }

  langPTTop.addEventListener('click', ()=>setLang('pt'));
  langENTop.addEventListener('click', ()=>setLang('en'));
  langPT.addEventListener('click', ()=>setLang('pt'));
  langEN.addEventListener('click', ()=>setLang('en'));

  syncLangButtons();
  applyTopCopy();

  // ---------- modal events ----------
  openModalBtn.addEventListener('click', showModal);
  closeModalBtn.addEventListener('click', hideModal);
  backdrop.addEventListener('click', hideModal);
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && !modal.classList.contains('hidden')) hideModal();
  });

  // ---------- load JSON ----------
  let dadosJSON;
  try {
    const res = await fetch('precos.json');
    if(!res.ok) throw new Error('Failed to load precos.json — run via a local server or place the file in the same folder.');
    dadosJSON = await res.json();
  } catch(err) {
    setFade(`<div class="fade">
      <div class="rounded-2xl border border-red-500/30 bg-red-500/10 p-4">
        <div class="text-white font-semibold mb-1">${currentLang==='en'?'Could not load precos.json':'Erro ao carregar precos.json'}</div>
        <div class="text-white/70 text-sm">${escapeHtml(err.message)}</div>
      </div>
    </div>`);
    console.error(err);
    return;
  }

  const categorias = (dadosJSON.orcamento && Array.isArray(dadosJSON.orcamento.categorias)) ? dadosJSON.orcamento.categorias : [];
  const observacoes = (dadosJSON.orcamento && dadosJSON.orcamento.observacoes) ? dadosJSON.orcamento.observacoes : '';

  if(!categorias.length){
    setFade(`<div class="fade">
      <div class="rounded-2xl border border-red-500/30 bg-red-500/10 p-4 text-white">
        JSON loaded but no categories found in <code>orcamento.categorias</code>.
      </div>
    </div>`);
    return;
  }

  // ---------- normalize services ----------
  const allServices = [];
  function toArrayText(arr){ return Array.isArray(arr) ? arr.join(' ') : ''; }

  categorias.forEach(cat=>{
    if(Array.isArray(cat.servicos)){
      cat.servicos.forEach((s, idx)=>{
        const isPlan = Array.isArray(s.precos_por_periodo) && s.precos_por_periodo.length;
        const displayTitle = s.titulo_venda || s.titulo || 'Serviço';

        const fullText = [
          displayTitle,
          s.titulo || '',
          s.descricao || '',
          s.extras || '',
          toArrayText(s.inclui),
          toArrayText(s.beneficios)
        ].join(' ').toLowerCase();

        let priceMin = null;
        if(isPlan){
          const mensal = s.precos_por_periodo.find(p => String(p.periodo).toLowerCase().includes('mensal')) || s.precos_por_periodo[0];
          priceMin = mensal ? Number(mensal.preco_total_com_desc) : null;
        } else if(typeof s.preco === 'number'){
          priceMin = Number(s.preco);
        }

        allServices.push(Object.assign({}, s, {
          __id: `${cat.nome}::${displayTitle}::${idx}`,
          __categoria: cat.nome,
          __displayTitle: displayTitle,
          __isPlan: isPlan,
          __priceMin: priceMin,
          __fullText: fullText
        }));
      });
    }
  });

  // ---------- questions ----------
  const questions = [
    {
      id: 'start',
      type: 'screen'
    },
    {
      id: 'objetivo',
      type: 'single',
      textKey: 'q_objective',
      options: [
        { value: 'vendas', labelKey: 'o_sales' },
        { value: 'social', labelKey: 'o_social' },
        { value: 'branding', labelKey: 'o_branding' },
        { value: 'educativo', labelKey: 'o_edu' }
      ]
    },
    {
      id: 'canais',
      type: 'multi',
      textKey: 'q_channels',
      min: 1,
      options: [
        { value: 'instagram', labelKey: 'ch_instagram' },
        { value: 'tiktok', labelKey: 'ch_tiktok' },
        { value: 'shorts', labelKey: 'ch_shorts' },
        { value: 'whatsapp', labelKey: 'ch_whatsapp' },
        { value: 'site', labelKey: 'ch_site' },
        { value: 'multi', labelKey: 'ch_multi' }
      ]
    },
    {
      id: 'frequencia',
      type: 'single',
      textKey: 'q_freq',
      options: [
        { value: 'pontual', labelKey: 'f_one' },
        { value: 'semanal', labelKey: 'f_week' },
        { value: 'mensal', labelKey: 'f_month' }
      ]
    },
    {
      id: 'tipo',
      type: 'single',
      textKey: 'q_type',
      options: [
        { value: '__AUTO__', labelKey: 'type_auto' },
        ...categorias.map(c => ({ value: c.nome, label: c.nome }))
      ]
    },
    {
      id: 'materiais',
      type: 'multi',
      textKey: 'q_assets',
      min: 1,
      options: [
        { value: 'tem_logo', labelKey: 'a_logo' },
        { value: 'tem_fotos', labelKey: 'a_photos' },
        { value: 'tem_videos', labelKey: 'a_videos' },
        { value: 'tem_texto', labelKey: 'a_text' },
        { value: 'nada', labelKey: 'a_none' }
      ]
    },
    {
      id: 'volume',
      type: 'single',
      textKey: 'q_volume',
      options: [
        { value: 'baixo', labelKey: 'v_low' },
        { value: 'medio', labelKey: 'v_mid' },
        { value: 'alto', labelKey: 'v_high' }
      ]
    },
    {
      id: 'estilo',
      type: 'single',
      textKey: 'q_style',
      options: [
        { value: 'clean', labelKey: 's_clean' },
        { value: 'promo', labelKey: 's_promo' },
        { value: 'premium', labelKey: 's_premium' },
        { value: 'criativo', labelKey: 's_fun' }
      ]
    },
    {
      id: 'formato',
      type: 'single',
      textKey: 'q_preference',
      options: [
        { value: 'pacote', labelKey: 'p_combo' },
        { value: 'avulso', labelKey: 'p_single' },
        { value: 'indiferente', labelKey: 'p_any' }
      ]
    },
    {
      id: 'orcamento',
      type: 'single',
      textKey: 'q_budget',
      options: [
        { value: 100, labelKey: 'b_100' },
        { value: 300, labelKey: 'b_300' },
        { value: 800, labelKey: 'b_800' },
        { value: 999999, labelKey: 'b_more' }
      ]
    },
    {
      id: 'prazo',
      type: 'single',
      textKey: 'q_deadline',
      options: [
        { value: '3d', labelKey: 'd_3' },
        { value: '7d', labelKey: 'd_7' },
        { value: 'maior', labelKey: 'd_more' },
        { value: '__SKIP__', labelKey: 'd_skip' }
      ]
    }
  ];

  // ---------- state ----------
  const state = {
    answers: {},
    index: 0
  };

  // ---------- scoring ----------
  function textForService(s){ return s.__fullText || ''; }

  function scoreService(s, a){
    let score = 0;

    // category
    if(a.tipo && a.tipo !== '__AUTO__' && s.__categoria === a.tipo) score += 6;

    // budget
    const budget = Number(a.orcamento) || Infinity;
    if(typeof s.__priceMin === 'number'){
      if(budget === 999999) score += 1;
      else {
        if(s.__priceMin <= budget) score += 4;
        else score -= 6;
        if(s.__priceMin <= budget/2) score += 1;
      }
    }

    const txt = textForService(s);
    if(a.objetivo === 'vendas'){
      if(/\bvenda|vendas|convers|promo|campanh|ads|an[uú]ncio|cta|oferta|reserv/ig.test(txt)) score += 5;
      if(/\bshort|storytelling|reels|tiktok|impact/ig.test(txt)) score += 2;
    }
    if(a.objetivo === 'social'){
      if(s.__isPlan) score += (a.frequencia === 'mensal' ? 10 : 6);
      if(/\binstagram|tiktok|reels|shorts|stories|conte[uú]do|feed/ig.test(txt)) score += 4;
      if(/\bimagem|artes?|pack\b|v[ií]deo/ig.test(txt)) score += 2;
    }
    if(a.objetivo === 'branding'){
      if(/\blogo|identidade|brand|marca|website|site|manual|mascote|personagem/ig.test(txt)) score += 6;
      if(/\bpremium|institucional|corporativo/ig.test(txt)) score += 2;
    }
    if(a.objetivo === 'educativo'){
      if(/\btutorial|trein|curso|explic|ensaio|podcast|roteiro/ig.test(txt)) score += 5;
      if(/\bv[ií]deo|narra|dublag/ig.test(txt)) score += 2;
    }

    const canais = Array.isArray(a.canais) ? a.canais : [];
    if(canais.includes('instagram') || canais.includes('tiktok') || canais.includes('shorts')){
      if(/\breels|tiktok|shorts|stories|vertical|15s|30s/ig.test(txt)) score += 2;
    }
    if(canais.includes('site')){
      if(/\bwebsite|site|landing|corporativo/ig.test(txt)) score += 3;
    }
    if(canais.includes('whatsapp')){
      if(/\bpack|imagem|arte|card|story|stories|banner/ig.test(txt)) score += 2;
    }

    const mats = Array.isArray(a.materiais) ? a.materiais : [];
    if(mats.includes('nada') && /\bidentidade|logo/ig.test(txt)) score += 4;

    if(a.volume){
      if(/imagens/i.test((s.__categoria||'').toLowerCase())){
        if(a.volume === 'baixo' && /\b5\b|5 artes|5 imagens|visual r[aá]pido/ig.test(txt)) score += 3;
        if(a.volume === 'medio' && /\b10\b|engajamento|10 artes|10 imagens/ig.test(txt)) score += 3;
        if(a.volume === 'alto' && /\b15\b|crescimento|15 artes|15 imagens/ig.test(txt)) score += 3;
      }
      if(/v[ií]deos/i.test((s.__categoria||'').toLowerCase())){
        if(a.volume === 'baixo' && /\b15\b|short/ig.test(txt)) score += 3;
        if(a.volume === 'medio' && /\b30\b|storytelling/ig.test(txt)) score += 3;
        if(a.volume === 'alto' && /\b60\b|premium/ig.test(txt)) score += 3;
      }
    }

    if(a.prazo === '3d' && /\br[aá]pid|express|1 dia|prazo acelerado/ig.test(txt)) score += 2;

    if(a.estilo === 'premium' && /\bpremium|corporativo|institucional/ig.test(txt)) score += 1;
    if(a.estilo === 'promo' && /\bpromo|oferta|impact/ig.test(txt)) score += 1;
    if(a.estilo === 'clean' && /\bminimal|clean|simples/ig.test(txt)) score += 1;
    if(a.estilo === 'criativo' && /\bcriativ|divertid|mascote|personagem/ig.test(txt)) score += 1;

    return score;
  }

  function comboDiscountPerc(qtd){
    if(qtd >= 4) return 12;
    if(qtd === 3) return 8;
    if(qtd === 2) return 5;
    return 0;
  }

  function pickTopServices(a, limit){
    const budget = Number(a.orcamento) || Infinity;
    const scored = allServices.map(s => ({ s, score: scoreService(s, a) }));

    const filtered = scored.filter(x=>{
      if(budget === 999999) return true;
      if(typeof x.s.__priceMin !== 'number') return true;
      return x.s.__priceMin <= budget;
    });

    filtered.sort((A,B)=>{
      if(B.score !== A.score) return B.score - A.score;
      const pa = A.s.__priceMin ?? 999999;
      const pb = B.s.__priceMin ?? 999999;
      return pa - pb;
    });

    const top = filtered.filter(x=>x.score > 0).slice(0, limit).map(x=>x.s);
    return top.length ? top : filtered.slice(0, limit).map(x=>x.s);
  }

  function getServiceById(id){ return allServices.find(s=>s.__id===id); }

  function findServiceByRegex(re, preferCategory){
    const list = preferCategory ? allServices.filter(s=>s.__categoria===preferCategory) : allServices;
    return list.find(s => re.test((s.__displayTitle||'')+' '+(s.titulo||'')+' '+(s.descricao||'')));
  }

  function buildPackages(a, topList){
    const budget = Number(a.orcamento) || Infinity;

    const bestImages = topList.find(s => /imagens/i.test(s.__categoria));
    const bestVideo  = topList.find(s => /v[ií]deos/i.test(s.__categoria));
    const bestPlan   = topList.find(s => s.__isPlan);

    const identity   = findServiceByRegex(/\bidentidade|logo\b/i, 'Serviços Avulsos') || findServiceByRegex(/\bidentidade|logo\b/i);
    const website    = findServiceByRegex(/\bwebsite|site\b/i, 'Serviços Avulsos') || findServiceByRegex(/\bwebsite|site\b/i);
    const narra      = findServiceByRegex(/\bnarra/ig, 'Serviços Avulsos') || findServiceByRegex(/\bnarra/ig);
    const trilha     = findServiceByRegex(/\btrilha/ig, 'Serviços Avulsos') || findServiceByRegex(/\btrilha/ig);

    function withinBudget(s){
      if(!s) return false;
      if(budget === 999999) return true;
      if(typeof s.__priceMin !== 'number') return true;
      return s.__priceMin <= budget;
    }

    const mats = Array.isArray(a.materiais) ? a.materiais : [];
    const needsIdentity = mats.includes('nada') || !mats.includes('tem_logo');

    const essential = [];
    if(a.objetivo === 'social' && (a.frequencia === 'mensal' || a.frequencia === 'semanal') && bestPlan && withinBudget(bestPlan)){
      essential.push({id: bestPlan.__id, kind:'plan', period:'Mensal'});
    } else {
      if(bestImages && withinBudget(bestImages)) essential.push({id: bestImages.__id, kind:'service'});
      if(bestVideo && withinBudget(bestVideo) && (a.objetivo==='vendas' || a.objetivo==='educativo')) essential.push({id: bestVideo.__id, kind:'service'});
      if(!essential.length && topList[0]) essential.push({id: topList[0].__id, kind:'service'});
    }

    const recommended = essential.slice();
    if(needsIdentity && identity && withinBudget(identity)) recommended.unshift({id: identity.__id, kind:'service'});
    if(narra && withinBudget(narra) && !recommended.find(x=>x.id===narra.__id) && (a.objetivo==='vendas' || a.objetivo==='educativo' || a.objetivo==='social')) recommended.push({id: narra.__id, kind:'service'});
    if(trilha && withinBudget(trilha) && !recommended.find(x=>x.id===trilha.__id) && (a.objetivo==='vendas' || a.objetivo==='social')) recommended.push({id: trilha.__id, kind:'service'});
    if(a.objetivo === 'social' && bestPlan && withinBudget(bestPlan) && !recommended.find(x=>x.id===bestPlan.__id)){
      recommended.unshift({id: bestPlan.__id, kind:'plan', period:'Mensal'});
    }

    const aggressive = recommended.slice();
    if(a.objetivo === 'branding' && website && withinBudget(website) && !aggressive.find(x=>x.id===website.__id)) aggressive.push({id: website.__id, kind:'service'});

    topList.slice(0,6).forEach(s=>{
      if(aggressive.length >= 6) return;
      if(!aggressive.find(x=>x.id===s.__id) && withinBudget(s)){
        aggressive.push({id: s.__id, kind: s.__isPlan ? 'plan' : 'service', period: s.__isPlan ? 'Mensal' : undefined});
      }
    });

    return [
      {tierKey:'tier_essential', badgeKey:'badge_essential', items: essential},
      {tierKey:'tier_recommended', badgeKey:'badge_recommended', items: recommended},
      {tierKey:'tier_aggressive', badgeKey:'badge_aggressive', items: aggressive}
    ];
  }

  function getPeriodLabel(value){
    const v = String(value || '').toLowerCase();
    if(v.includes('mensal')) return t('period_monthly');
    if(v.includes('trimestral')) return t('period_quarterly');
    if(v.includes('semestral')) return t('period_semi');
    if(v.includes('anual')) return t('period_yearly');
    return value;
  }

  function computeTotals(selected){
    let avulsoSubtotal = 0;
    let planTotal = 0;
    let planSavings = 0;

    const avulsos = [];
    const plans = [];

    selected.forEach(it=>{
      const s = getServiceById(it.id);
      if(!s) return;
      if(s.__isPlan) plans.push({ s, period: it.period || 'Mensal' });
      else avulsos.push(s);
    });

    avulsos.forEach(s=>{
      const p = Number(s.preco ?? s.__priceMin ?? 0);
      avulsoSubtotal += (isFinite(p) ? p : 0);
    });

    const comboPerc = comboDiscountPerc(avulsos.length);
    const comboDiscount = Math.round((avulsoSubtotal * comboPerc) * 100) / 100;
    const avulsoTotal = avulsoSubtotal - comboDiscount;

    plans.forEach(({s, period})=>{
      const opt = Array.isArray(s.precos_por_periodo)
        ? (s.precos_por_periodo.find(p => String(p.periodo).toLowerCase() === String(period).toLowerCase())
           || s.precos_por_periodo.find(p => String(p.periodo).toLowerCase().includes(String(period).toLowerCase()))
           || s.precos_por_periodo[0])
        : null;

      if(opt){
        planTotal += Number(opt.preco_total_com_desc || 0);
        const sem = Number(opt.preco_total_sem_desc || 0);
        const com = Number(opt.preco_total_com_desc || 0);
        planSavings += Math.max(0, sem - com);
      } else {
        planTotal += Number(s.__priceMin || 0);
      }
    });

    const total = avulsoTotal + planTotal;

    return { avulsoSubtotal, comboPerc, comboDiscount, avulsoTotal, planTotal, planSavings, total };
  }

  function renderTotalsBox(tot){
    const discLabel = tot.comboPerc ? `-${tot.comboPerc}%` : '—';
    sideTotals.innerHTML = `
      <div class="flex justify-between"><span>${escapeHtml(t('subtotalAvulso'))}</span><span>${formatPrice(tot.avulsoSubtotal)}</span></div>
      <div class="flex justify-between"><span>${escapeHtml(t('comboDiscount'))} ${escapeHtml(discLabel)}</span><span>${tot.comboDiscount ? '-'+formatPrice(tot.comboDiscount) : '—'}</span></div>
      <div class="flex justify-between"><span>${escapeHtml(t('plans'))}</span><span>${tot.planTotal ? formatPrice(tot.planTotal) : '—'}</span></div>
      <div class="flex justify-between font-bold"><span>${escapeHtml(t('lblTotal'))}</span><span>${formatPrice(tot.total)}</span></div>
    `;
  }

  // ---------- progress + sidebar ----------
  function updateProgress(){
    const visible = questions.filter(q=>q.type!=='screen').length;
    const currentVisible = Math.max(0, questions.slice(0, state.index).filter(q=>q.type!=='screen').length);
    const pct = Math.round((currentVisible / visible) * 100);
    progressBar.style.width = `${Math.min(100, Math.max(0, pct))}%`;
    progressText.textContent = `${Math.min(100, Math.max(0, pct))}%`;
    stepCounter.textContent = (state.index === 0) ? '—' : `${currentVisible} / ${visible}`;
  }

  function renderSideSummary(){
    const labels = {
      objetivo: currentLang==='en' ? 'Goal' : 'Objetivo',
      canais: currentLang==='en' ? 'Channels' : 'Canais',
      frequencia: currentLang==='en' ? 'Frequency' : 'Frequência',
      tipo: currentLang==='en' ? 'Type' : 'Tipo',
      materiais: currentLang==='en' ? 'Assets' : 'Materiais',
      volume: currentLang==='en' ? 'Volume' : 'Volume',
      estilo: currentLang==='en' ? 'Style' : 'Estilo',
      formato: currentLang==='en' ? 'Preference' : 'Preferência',
      orcamento: currentLang==='en' ? 'Budget' : 'Orçamento',
      prazo: currentLang==='en' ? 'Deadline' : 'Prazo'
    };

    const lines = [];
    Object.keys(labels).forEach(k=>{
      if(typeof state.answers[k] === 'undefined') return;
      let v = state.answers[k];
      if(Array.isArray(v)) v = v.join(', ');
      if(k === 'orcamento') v = `R$${state.answers[k]}`;
      if(k === 'tipo' && v === '__AUTO__') v = t('type_auto');
      if(k === 'prazo' && v === '__SKIP__') v = t('d_skip');
      lines.push(`
        <div class="flex justify-between gap-3">
          <span class="text-white/55">${escapeHtml(labels[k])}</span>
          <span class="font-semibold text-white/90 text-right">${escapeHtml(String(v))}</span>
        </div>
      `);
    });

    sideSummary.innerHTML = lines.length
      ? `<div class="space-y-2">${lines.join('')}</div>`
      : `<div class="text-white/55">${escapeHtml(t('sideEmpty'))}</div>`;
  }

  function showNavButtons(showBack, showNext){
    backBtn.classList.toggle('hidden', !showBack);
    nextBtn.classList.toggle('hidden', !showNext);
    backBtn.textContent = t('back');
    nextBtn.textContent = t('next');
  }

  // ---------- render questions ----------
  function renderQuestion(index, silent){
    state.index = index;
    updateProgress();
    renderSideSummary();

    // finish
    if(index >= questions.length){
      renderResults(silent);
      return;
    }

    const q = questions[index];
    showNavButtons(index > 0, false);

    // START
    if(q.type === 'screen'){
      setFade(`
        <div class="fade">
          <div class="rounded-3xl border border-white/10 bg-white/5 p-5 md:p-6">
            <div class="text-white font-extrabold text-2xl md:text-3xl tracking-tight">
              ${escapeHtml(t('startTitle'))}
            </div>
            <div class="mt-2 text-white/70">
              ${escapeHtml(t('startSubtitle'))}
            </div>

            <div class="mt-5 grid sm:grid-cols-3 gap-3">
              <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                <div class="text-white font-semibold">${escapeHtml(t('card1Title'))}</div>
                <div class="text-sm text-white/65 mt-1">${escapeHtml(t('card1Sub'))}</div>
              </div>
              <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                <div class="text-white font-semibold">${escapeHtml(t('card2Title'))}</div>
                <div class="text-sm text-white/65 mt-1">${escapeHtml(t('card2Sub'))}</div>
              </div>
              <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                <div class="text-white font-semibold">${escapeHtml(t('card3Title'))}</div>
                <div class="text-sm text-white/65 mt-1">${escapeHtml(t('card3Sub'))}</div>
              </div>
            </div>

            <button id="startQuiz"
              class="mt-6 w-full ring-focus inline-flex items-center justify-center gap-2 px-6 py-3 rounded-2xl bg-gradient-to-r from-indigo-500 to-sky-500 text-white font-semibold shadow-soft hover:opacity-[.96]">
              ${escapeHtml(t('startCTA'))}
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="opacity-90">
                <path d="M8 5l8 7-8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>
      `);
      document.getElementById('startQuiz').addEventListener('click', ()=>renderQuestion(index+1));
      return;
    }

    // SINGLE
    if(q.type === 'single'){
      const opts = q.options.map(o=>{
        const label = o.labelKey ? t(o.labelKey) : (o.label || String(o.value));
        return `
          <button class="option-btn ring-focus w-full text-left px-4 py-3.5 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-white/90 transition-all"
            data-val="${escapeHtml(o.value)}">
            <div class="flex items-center justify-between gap-3">
              <span class="font-semibold">${escapeHtml(label)}</span>
              <span class="text-white/35">→</span>
            </div>
          </button>
        `;
      }).join('');

      setFade(`
        <div class="fade">
          <div class="mb-4">
            <div class="text-white font-bold text-lg">${escapeHtml(t(q.textKey))}</div>
            <div class="text-white/55 text-sm mt-1">${escapeHtml(t('clickToAdvance'))}</div>
          </div>
          <div class="grid gap-3">${opts}</div>
        </div>
      `);

      app.querySelectorAll('.option-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const v = btn.dataset.val;
          state.answers[q.id] = (isNaN(Number(v)) ? v : Number(v));
          renderQuestion(index+1);
        });
      });

      backBtn.onclick = ()=>renderQuestion(index-1);
      showNavButtons(index>0, false);
      return;
    }

    // MULTI
    if(q.type === 'multi'){
      const current = Array.isArray(state.answers[q.id]) ? state.answers[q.id] : [];
      const chips = q.options.map(o=>{
        const label = o.labelKey ? t(o.labelKey) : (o.label || String(o.value));
        const active = current.includes(o.value);
        return `
          <button type="button"
            class="chip ring-focus px-3.5 py-2.5 rounded-2xl border text-sm transition-all
              ${active ? 'bg-white text-slate-900 border-white' : 'bg-white/5 hover:bg-white/10 text-white/90 border-white/10'}"
            data-val="${escapeHtml(o.value)}">
            ${escapeHtml(label)}
          </button>
        `;
      }).join('');

      const min = q.min || 1;
      const canContinue = current.length >= min;

      setFade(`
        <div class="fade">
          <div class="mb-4">
            <div class="text-white font-bold text-lg">${escapeHtml(t(q.textKey))}</div>
            <div class="text-white/55 text-sm mt-1">${escapeHtml(t('selectAndContinue'))}</div>
          </div>

          <div class="flex flex-wrap gap-2.5 mb-4">${chips}</div>

          <div class="flex items-center justify-between gap-3">
            <div class="text-xs text-white/55">${escapeHtml(currentLang==='en' ? `Selected: ${current.length}` : `Selecionados: ${current.length}`)}</div>
            <button id="multiNext"
              class="ring-focus px-4 py-2.5 rounded-2xl font-semibold
                ${canContinue ? 'bg-gradient-to-r from-indigo-500 to-sky-500 text-white' : 'bg-white/10 text-white/45 cursor-not-allowed'}"
              ${canContinue ? '' : 'disabled'}>
              ${escapeHtml(t('continueBtn'))}
            </button>
          </div>
        </div>
      `);

      app.querySelectorAll('.chip').forEach(ch=>{
        ch.addEventListener('click', ()=>{
          const val = ch.dataset.val;
          let cur = Array.isArray(state.answers[q.id]) ? state.answers[q.id].slice() : [];
          if(cur.includes(val)) cur = cur.filter(x=>x!==val);
          else cur.push(val);
          state.answers[q.id] = cur;
          renderQuestion(index); // re-render to update active states
        });
      });

      document.getElementById('multiNext').addEventListener('click', ()=>{
        const cur = Array.isArray(state.answers[q.id]) ? state.answers[q.id] : [];
        if(cur.length < min) return;
        renderQuestion(index+1);
      });

      backBtn.onclick = ()=>renderQuestion(index-1);
      showNavButtons(index>0, false);
      return;
    }

    // fallback
    renderQuestion(index+1);
  }

  // ---------- results ----------
  let selectedMap = new Map(); // id -> {id,kind,period?}

  function servicesForChecklist(topList){
    const already = new Set();
    const list = [];

    const byCat = {};
    topList.forEach(s=>{
      byCat[s.__categoria] = byCat[s.__categoria] || [];
      byCat[s.__categoria].push(s);
    });

    Object.keys(byCat).forEach(cat=>{
      byCat[cat].slice(0,2).forEach(s=>{
        if(!already.has(s.__id)){ list.push(s); already.add(s.__id); }
      });
    });

    topList.forEach(s=>{
      if(list.length >= 12) return;
      if(!already.has(s.__id)){ list.push(s); already.add(s.__id); }
    });

    return list.slice(0,12);
  }

  function buildSummaryText(){
    const a = state.answers;
    const canais = Array.isArray(a.canais) ? a.canais.join(', ') : String(a.canais || '');
    const mats = Array.isArray(a.materiais) ? a.materiais.join(', ') : String(a.materiais || '');
    const tipo = (a.tipo === '__AUTO__') ? t('type_auto') : a.tipo;

    if(currentLang === 'en'){
      return [
        `- Goal: ${a.objetivo}`,
        `- Channels: ${canais}`,
        `- Frequency: ${a.frequencia}`,
        `- Type: ${tipo}`,
        `- Assets: ${mats}`,
        `- Volume: ${a.volume}`,
        `- Style: ${a.estilo}`,
        `- Preference: ${a.formato}`,
        `- Budget: R$${a.orcamento}`,
        `- Deadline: ${(a.prazo === '__SKIP__') ? t('d_skip') : (a.prazo || '—')}`
      ].join('\n');
    }

    return [
      `- Objetivo: ${a.objetivo}`,
      `- Canais: ${canais}`,
      `- Frequência: ${a.frequencia}`,
      `- Tipo: ${tipo}`,
      `- Materiais: ${mats}`,
      `- Volume: ${a.volume}`,
      `- Estilo: ${a.estilo}`,
      `- Preferência: ${a.formato}`,
      `- Orçamento: R$${a.orcamento}`,
      `- Prazo: ${(a.prazo === '__SKIP__') ? t('d_skip') : (a.prazo || '—')}`
    ].join('\n');
  }

  function applyPackage(pkg){
    selectedMap.clear();
    pkg.items.forEach(it=>{
      selectedMap.set(it.id, { id: it.id, kind: it.kind, period: it.period });
    });
  }

  function toggleService(id){
    if(selectedMap.has(id)) selectedMap.delete(id);
    else {
      const s = getServiceById(id);
      if(!s) return;
      selectedMap.set(id, { id, kind: s.__isPlan ? 'plan' : 'service', period: s.__isPlan ? 'Mensal' : undefined });
    }
  }

  function updatePlanPeriod(id, period){
    const it = selectedMap.get(id);
    if(it){
      it.period = period;
      selectedMap.set(id, it);
    }
  }

  function renderResults(silent){
    updateProgress();
    renderSideSummary();
    showNavButtons(false, false);

    // validate required answers
    const required = ['objetivo','canais','frequencia','tipo','materiais','volume','estilo','formato','orcamento','prazo'];
    for(const r of required){
      if(typeof state.answers[r] === 'undefined'){
        const idx = questions.findIndex(q=>q.id===r);
        return renderQuestion(idx >= 0 ? idx : 0);
      }
    }

    const topList = pickTopServices(state.answers, 14);
    const packages = buildPackages(state.answers, topList);

    // always start with Recommended selected (best conversion)
    const recommendedPkg = packages[1] || packages[0];
    if(selectedMap.size === 0) applyPackage(recommendedPkg);

    function computePayload(){
      const selectedArr = Array.from(selectedMap.values());
      const totals = computeTotals(selectedArr);

      const selectedDetail = selectedArr.map(it=>{
        const s = getServiceById(it.id);
        if(!s) return null;

        let price = s.__priceMin ?? s.preco ?? 0;
        if(s.__isPlan && Array.isArray(s.precos_por_periodo)){
          const opt = s.precos_por_periodo.find(p => String(p.periodo).toLowerCase() === String(it.period||'Mensal').toLowerCase())
                   || s.precos_por_periodo.find(p => String(p.periodo).toLowerCase().includes(String(it.period||'Mensal').toLowerCase()))
                   || s.precos_por_periodo[0];
          if(opt) price = Number(opt.preco_total_com_desc || price);
        }

        return {
          category: s.__categoria,
          title: s.__displayTitle,
          kind: s.__isPlan ? 'plan' : 'one_off',
          period: s.__isPlan ? (it.period || 'Mensal') : undefined,
          price
        };
      }).filter(Boolean);

      const totalsPayload = {
        avulsoSubtotal: totals.avulsoSubtotal,
        comboPerc: totals.comboPerc,
        comboDiscount: totals.comboDiscount,
        planTotal: totals.planTotal,
        planSavings: totals.planSavings,
        total: totals.total
      };

      return { totals, selectedDetail, totalsPayload };
    }

    function renderAll(){
      const { totals, selectedDetail, totalsPayload } = computePayload();
      renderTotalsBox(totals);

      const pkgHtml = packages.map((pkg, idx)=>{
        const tier = t(pkg.tierKey);
        const badge = t(pkg.badgeKey);

        const itemsList = pkg.items.map(it=>{
          const s = getServiceById(it.id);
          if(!s) return '';
          return `<li class="text-sm text-white/80">
            ${escapeHtml(s.__displayTitle)}
            ${s.__isPlan ? `<span class="text-xs text-white/50">(${escapeHtml(getPeriodLabel(it.period||'Mensal'))})</span>` : ''}
          </li>`;
        }).join('');

        const simulated = computeTotals(pkg.items);
        const savingBits = [];
        if(simulated.comboDiscount > 0) savingBits.push(`combo: -${formatPrice(simulated.comboDiscount)}`);
        if(simulated.planSavings > 0) savingBits.push(`plan: -${formatPrice(simulated.planSavings)}`);

        const isHighlight = (idx === 1); // Recommended highlight
        return `
          <div class="rounded-3xl border ${isHighlight ? 'border-white/25 bg-white/10' : 'border-white/10 bg-white/5'} p-4 md:p-5">
            <div class="flex items-center justify-between gap-3">
              <div class="text-white font-extrabold text-lg">${escapeHtml(tier)}</div>
              <span class="text-xs px-2 py-1 rounded-full border border-white/10 bg-white/5 text-white/80 font-semibold">
                ${escapeHtml(badge)}
              </span>
            </div>

            <div class="mt-2 text-sm text-white/60">${escapeHtml(currentLang==='en'?'Suggested bundle based on your answers.':'Pacote sugerido com base nas suas respostas.')}</div>
            <ul class="mt-3 list-disc list-inside space-y-1">${itemsList}</ul>

            <div class="mt-4 flex items-end justify-between gap-3">
              <div>
                <div class="text-xs text-white/55">${escapeHtml(t('estimatedTotal'))}</div>
                <div class="text-xl font-extrabold text-emerald-300">${formatPrice(simulated.total)}</div>
                <div class="text-xs text-white/55">${savingBits.length ? `(${savingBits.join(' + ')})` : '—'}</div>
              </div>
              <button class="applyPkg ring-focus px-4 py-2.5 rounded-2xl font-semibold
                ${isHighlight ? 'bg-gradient-to-r from-indigo-500 to-sky-500 text-white' : 'bg-white text-slate-900'}
              " data-idx="${idx}">
                ${escapeHtml(t('apply'))} ${escapeHtml(tier)}
              </button>
            </div>

            <div class="mt-3 text-xs text-white/50">${escapeHtml(t('simulated'))}</div>
          </div>
        `;
      }).join('');

      const checklistItems = servicesForChecklist(topList).map(s=>{
        const checked = selectedMap.has(s.__id) ? 'checked' : '';
        const priceLabel = s.__isPlan
          ? (s.precos_por_periodo?.[0]?.preco_total_com_desc ? `${formatPrice(s.precos_por_periodo[0].preco_total_com_desc)}` : '—')
          : formatPrice(s.__priceMin ?? s.preco ?? 0);

        // plan period select (only when selected)
        let planSelect = '';
        if(s.__isPlan && selectedMap.has(s.__id)){
          const it = selectedMap.get(s.__id);
          const opts = (Array.isArray(s.precos_por_periodo) ? s.precos_por_periodo : []).map(p=>{
            const selected = (String(it.period||'Mensal').toLowerCase() === String(p.periodo).toLowerCase()) ? 'selected' : '';
            const econ = (Number(p.preco_total_sem_desc||0) - Number(p.preco_total_com_desc||0));
            const econTxt = econ > 0 ? ` • ${t('saves')} ${formatPrice(econ)}` : '';
            return `<option value="${escapeHtml(p.periodo)}" ${selected}>
              ${escapeHtml(getPeriodLabel(p.periodo))} — ${formatPrice(p.preco_total_com_desc)}${econTxt}
            </option>`;
          }).join('');

          planSelect = `
            <div class="mt-3">
              <label class="text-xs text-white/55">${escapeHtml(t('planPeriod'))}</label>
              <select class="planPeriod ring-focus mt-1 w-full border border-white/10 bg-white/5 rounded-2xl px-3 py-2.5 text-sm text-white"
                data-id="${escapeHtml(s.__id)}">
                ${opts}
              </select>
            </div>
          `;
        }

        return `
          <label class="rounded-3xl border border-white/10 bg-white/5 hover:bg-white/10 transition-all p-4 flex gap-3">
            <input type="checkbox" class="svcCheck mt-1.5 h-4 w-4 accent-indigo-400" data-id="${escapeHtml(s.__id)}" ${checked}>
            <div class="flex-1">
              <div class="flex items-start justify-between gap-3">
                <div class="text-white font-semibold">
                  ${escapeHtml(s.__displayTitle)}
                  <div class="text-xs text-white/50 mt-0.5">${escapeHtml(s.__categoria)}</div>
                </div>
                <div class="text-emerald-300 font-extrabold">
                  ${escapeHtml(priceLabel)}
                </div>
              </div>
              <div class="mt-2 text-sm text-white/70">
                ${escapeHtml((s.descricao||'').slice(0,160))}${(s.descricao||'').length>160?'…':''}
              </div>
              ${planSelect}
            </div>
          </label>
        `;
      }).join('');

      const summaryText = buildSummaryText();

      setFade(`
        <div class="fade">
          <div class="flex items-start justify-between gap-3 mb-5">
            <div>
              <div class="text-white font-extrabold text-2xl tracking-tight">${escapeHtml(t('resultsTitle'))}</div>
              <div class="text-white/60 text-sm mt-1">${escapeHtml(t('resultsSub'))}</div>
            </div>
            <button id="redo"
              class="ring-focus px-4 py-2.5 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-white/90">
              ${escapeHtml(t('redo'))}
            </button>
          </div>

          <div class="grid md:grid-cols-3 gap-3 mb-6">
            ${pkgHtml}
          </div>

          <div class="flex items-center justify-between gap-3 mb-2">
            <div class="text-white font-bold text-lg">${escapeHtml(t('customizeTitle'))}</div>
            <div class="text-xs text-white/55">${escapeHtml(t('customizeHint'))}</div>
          </div>

          <div class="grid gap-3 mb-6">
            ${checklistItems}
          </div>

          <div class="rounded-3xl border border-white/10 bg-white/5 p-4 md:p-5 mb-5">
            <div class="text-white font-semibold mb-2">${escapeHtml(t('summaryAuto'))}</div>
            <pre class="whitespace-pre-wrap text-sm text-white/80">${escapeHtml(summaryText)}</pre>
          </div>

          <div class="flex flex-col sm:flex-row gap-3">
            <button id="finalize"
              class="ring-focus flex-1 inline-flex items-center justify-center gap-2 px-6 py-3 rounded-2xl bg-gradient-to-r from-indigo-500 to-sky-500 text-white font-semibold shadow-soft hover:opacity-[.96]">
              ${escapeHtml(t('finalize'))}
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="opacity-90">
                <path d="M8 5l8 7-8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <button id="copy"
              class="ring-focus px-6 py-3 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 text-white font-semibold">
              ${escapeHtml(t('copy'))}
            </button>
          </div>

          <div class="mt-4 text-xs text-white/55">
            ${escapeHtml(t('obs'))}: ${escapeHtml(observacoes || '—')}
          </div>

          <textarea id="payloadServices" class="hidden">${escapeHtml(JSON.stringify(selectedDetail))}</textarea>
          <textarea id="payloadTotals" class="hidden">${escapeHtml(JSON.stringify(totalsPayload))}</textarea>
        </div>
      `);

      // bind package apply
      document.querySelectorAll('.applyPkg').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const idx = Number(btn.dataset.idx);
          const pkg = packages[idx];
          if(pkg){
            applyPackage(pkg);
            renderAll();
          }
        });
      });

      // bind checks
      document.querySelectorAll('.svcCheck').forEach(ch=>{
        ch.addEventListener('change', ()=>{
          toggleService(ch.dataset.id);
          const { totals } = computePayload();
          renderTotalsBox(totals);
          renderAll();
        });
      });

      // bind plan periods
      document.querySelectorAll('.planPeriod').forEach(sel=>{
        sel.addEventListener('change', ()=>{
          updatePlanPeriod(sel.dataset.id, sel.value);
          const { totals } = computePayload();
          renderTotalsBox(totals);
          renderAll();
        });
      });

      // actions
      document.getElementById('redo').addEventListener('click', ()=>{
        state.answers = {};
        state.index = 0;
        selectedMap.clear();
        renderTotalsBox({avulsoSubtotal:0,comboPerc:0,comboDiscount:0,planTotal:0,planSavings:0,total:0});
        renderQuestion(0);
      });

      document.getElementById('copy').addEventListener('click', async ()=>{
        try{
          await navigator.clipboard.writeText(summaryText);
          const btn = document.getElementById('copy');
          btn.textContent = t('copied');
          setTimeout(()=>btn.textContent = t('copy'), 1200);
        } catch(e){
          alert(currentLang==='en' ? 'Could not copy automatically. Please select and copy manually.' : 'Não foi possível copiar automaticamente. Selecione e copie manualmente.');
        }
      });

      document.getElementById('finalize').addEventListener('click', ()=>{
        const resumo = buildSummaryText();
        const encodedResumo = encodeURIComponent(resumo);

        const encodedServices = encodeURIComponent(JSON.stringify(selectedDetail));
        const encodedTotals = encodeURIComponent(JSON.stringify(totalsPayload));

        // language-based target links (as requested)
        const base = (currentLang === 'en')
          ? 'https://www.comercias.com.br/en/orcamento'
          : 'https://www.comercias.com.br/pt/orcamento';

        const target = `${base}?servicos=${encodedServices}&resumo=${encodedResumo}&totais=${encodedTotals}`;
        window.location.href = target;
      });
    }

    renderAll();
  }

  // ---------- nav buttons ----------
  backBtn.addEventListener('click', ()=>{
    if(state.index > 0) renderQuestion(state.index - 1);
  });
  nextBtn.addEventListener('click', ()=>{
    renderQuestion(state.index + 1);
  });

  // ---------- init ----------
  renderTotalsBox({avulsoSubtotal:0,comboPerc:0,comboDiscount:0,planTotal:0,planSavings:0,total:0});
  renderQuestion(0);

})(); // IIFE end
</script>

</body>
</html>
