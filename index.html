<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Comercias ‚Ä¢ Service Finder</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'ui-sans-serif', 'system-ui'] },
          boxShadow: {
            premium: '0 26px 80px rgba(0,0,0,.42)',
            soft: '0 14px 36px rgba(2,6,23,.25)',
            ringy: '0 0 0 6px rgba(99,102,241,.22)',
          }
        }
      }
    }
  </script>

  <style>
    :root{
      --bg1: rgba(2,6,23,1);
      --panel: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.12);
      --muted: rgba(255,255,255,.65);
      --muted2: rgba(255,255,255,.45);
      --accent1: rgba(99,102,241,1);
      --accent2: rgba(14,165,233,1);
    }
    body{
      background:
        radial-gradient(1100px 620px at 12% 12%, rgba(99,102,241,.26), transparent 55%),
        radial-gradient(900px 520px at 88% 18%, rgba(14,165,233,.18), transparent 55%),
        radial-gradient(880px 560px at 48% 92%, rgba(168,85,247,.14), transparent 60%),
        linear-gradient(180deg, rgba(2,6,23,1), rgba(2,6,23,.96));
      color: white;
    }
    .dots{
      background-image: radial-gradient(rgba(255,255,255,.08) 1px, transparent 1px);
      background-size: 18px 18px;
      mask-image: radial-gradient(circle at 30% 20%, black 0%, transparent 65%);
      opacity: .55;
      pointer-events:none;
    }
    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 26px 80px rgba(0,0,0,.42), inset 0 1px 0 rgba(255,255,255,.08);
    }
    .panel{
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
    }
    .btn-primary{
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      box-shadow: 0 18px 50px rgba(99,102,241,.25);
    }
    .btn-primary:hover{ filter: brightness(1.06); transform: translateY(-1px); }
    .btn-ghost{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
    }
    .btn-ghost:hover{ background: rgba(255,255,255,.10); }
    .ring-focus:focus{ outline:none; box-shadow: 0 0 0 6px rgba(99,102,241,.22); }

    .fade{ opacity:0; transform: translateY(10px); transition: all .22s ease; }
    .fade.show{ opacity:1; transform: translateY(0); }

    .opt{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      transition: transform .14s ease, background .14s ease, border-color .14s ease;
    }
    .opt:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.22);
    }
    .opt.active{
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
      border-color: rgba(255,255,255,.35);
    }

    .chip{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .chip.active{
      background: rgba(255,255,255,1);
      color: rgba(15,23,42,1);
      border-color: rgba(255,255,255,1);
    }

    .grad-border{
      position: relative;
      border-radius: 22px;
      overflow: hidden;
    }
    .grad-border:before{
      content:"";
      position:absolute; inset:0;
      padding: 1px;
      border-radius: 22px;
      background: linear-gradient(135deg, rgba(99,102,241,.95), rgba(14,165,233,.85), rgba(168,85,247,.72));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
      opacity: .6;
    }

    /* modal feel */
    #modalPanel{ transform: translateY(10px) scale(.99); opacity:0; transition: all .16s ease; }
    #modalPanel.show{ transform: translateY(0) scale(1); opacity:1; }

    /* bottom sheet on mobile */
    @media (max-width: 767px){
      #modalPanel{
        border-bottom-left-radius: 0 !important;
        border-bottom-right-radius: 0 !important;
        align-self: flex-end;
        max-height: 92vh;
      }
      .stickyMobileBar{
        position: sticky;
        bottom: 0;
        z-index: 10;
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
      }
    }
  </style>
</head>

<body class="min-h-screen font-sans">
  <div class="fixed inset-0 dots"></div>

  <main class="relative min-h-screen flex items-center justify-center px-4 py-10">
    <div class="w-full max-w-6xl">

      <!-- Header -->
      <div class="flex items-center justify-between mb-6 md:mb-8">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-2xl bg-white/10 border border-white/15 flex items-center justify-center">
            <span class="text-lg">‚ú¶</span>
          </div>
          <div>
            <div class="text-sm text-white/60">Comercias ‚Ä¢ Smart Quote</div>
            <div class="text-lg font-extrabold tracking-tight">Service Finder</div>
          </div>
        </div>

        <div class="inline-flex items-center gap-1 p-1 rounded-2xl btn-ghost">
          <button id="langPTTop" class="ring-focus px-3 py-2 rounded-xl text-sm font-semibold bg-white/10">üáßüá∑ PT</button>
          <button id="langENTop" class="ring-focus px-3 py-2 rounded-xl text-sm font-semibold text-white/70">üá∫üá∏ EN</button>
        </div>
      </div>

      <!-- Hero -->
      <section class="glass rounded-[28px] overflow-hidden">
        <div class="p-6 md:p-10 grid lg:grid-cols-[1.1fr_.9fr] gap-8">
          <div>
            <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/8 border border-white/12 text-xs text-white/70">
              <span class="inline-block h-2 w-2 rounded-full bg-emerald-400"></span>
              <span id="heroBadge">Quiz premium ‚Ä¢ Pacotes ‚Ä¢ Economia por combo</span>
            </div>

            <h1 id="heroTitle" class="mt-4 text-3xl md:text-5xl font-extrabold tracking-tight leading-[1.05]">
              Descubra o melhor pacote para vender mais.
            </h1>

            <p id="heroSub" class="mt-4 text-white/70 text-base md:text-lg max-w-2xl">
              Responda em ~2 minutos. No final, selecione servi√ßos, veja o total estimado e v√° para o or√ßamento pr√©-preenchido.
            </p>

            <div class="mt-6 flex flex-col sm:flex-row gap-3">
              <button id="openModal" class="ring-focus btn-primary transition-all px-6 py-3.5 rounded-2xl font-extrabold inline-flex items-center justify-center gap-2">
                <span id="ctaStart">Come√ßar</span>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="opacity-90">
                  <path d="M8 5l8 7-8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>

              <div class="rounded-2xl btn-ghost px-4 py-3 text-sm text-white/70 leading-snug">
                <div class="font-semibold text-white/85" id="miniNoteTitle">Por que isso converte mais?</div>
                <div id="miniNoteText">
                  Porque mostra 3 caminhos prontos (Essencial/Recomendado/Scale) + economia por combo.
                </div>
              </div>
            </div>

            <div class="mt-6 grid sm:grid-cols-3 gap-3">
              <div class="rounded-2xl btn-ghost p-4">
                <div class="font-semibold" id="b1t">Parece consultoria</div>
                <div class="text-white/65 text-sm mt-1" id="b1s">Sugest√µes certeiras, sem parecer ‚Äúvenda for√ßada‚Äù.</div>
              </div>
              <div class="rounded-2xl btn-ghost p-4">
                <div class="font-semibold" id="b2t">Upsell elegante</div>
                <div class="text-white/65 text-sm mt-1" id="b2s">Add-ons aparecem s√≥ quando aumentam resultado.</div>
              </div>
              <div class="rounded-2xl btn-ghost p-4">
                <div class="font-semibold" id="b3t">Final r√°pido</div>
                <div class="text-white/65 text-sm mt-1" id="b3s">Or√ßamento com dados + servi√ßos j√° selecionados.</div>
              </div>
            </div>
          </div>

          <!-- Preview -->
          <div class="grad-border">
            <div class="rounded-[22px] bg-black/25 border border-white/10 p-5 md:p-6">
              <div class="flex items-center justify-between mb-4">
                <div class="text-sm text-white/70" id="previewTitle">O que voc√™ vai ver</div>
                <div class="text-xs text-white/55" id="previewTime">~2 min</div>
              </div>

              <div class="space-y-3">
                <div class="rounded-2xl bg-white/6 border border-white/10 p-4">
                  <div class="text-white/90 font-semibold" id="p1t">1) Diagn√≥stico</div>
                  <div class="text-white/60 text-sm mt-1" id="p1s">Objetivo, canal, volume, prazo e or√ßamento.</div>
                </div>
                <div class="rounded-2xl bg-white/6 border border-white/10 p-4">
                  <div class="text-white/90 font-semibold" id="p2t">2) 3 pacotes</div>
                  <div class="text-white/60 text-sm mt-1" id="p2s">Escolha r√°pido ou personalize.</div>
                </div>
                <div class="rounded-2xl bg-white/6 border border-white/10 p-4">
                  <div class="text-white/90 font-semibold" id="p3t">3) Economia</div>
                  <div class="text-white/60 text-sm mt-1" id="p3s">Simula√ß√£o autom√°tica de desconto por combo.</div>
                </div>
              </div>

              <div class="mt-5 rounded-2xl bg-gradient-to-r from-indigo-500/20 to-sky-500/20 border border-white/10 p-4">
                <div class="text-sm font-semibold text-white/90" id="dealTitle">Combo (simulado)</div>
                <div class="text-white/70 text-sm mt-1" id="dealText">2 servi√ßos: 5% ‚Ä¢ 3: 8% ‚Ä¢ 4+: 12%</div>
              </div>
            </div>
          </div>
        </div>

        <div class="px-6 md:px-10 py-4 border-t border-white/10 bg-black/15 text-xs text-white/55" id="footerLine">
          *Valores e descontos s√£o estimativas para facilitar a decis√£o.
        </div>
      </section>
    </div>
  </main>

  <!-- MODAL -->
  <div id="modal" class="fixed inset-0 hidden items-end md:items-center justify-center p-0 md:p-8">
    <div id="backdrop" class="absolute inset-0 bg-black/65"></div>

    <div id="modalPanel" class="relative w-full md:w-[min(1140px,96vw)] glass rounded-t-[28px] md:rounded-[28px] overflow-hidden max-h-[92vh] md:max-h-[90vh] flex flex-col">

      <!-- Modal Header -->
      <div class="px-5 md:px-7 py-4 border-b border-white/10 bg-black/15 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-2xl bg-white/10 border border-white/12 flex items-center justify-center">
            <span class="text-lg">‚ö°</span>
          </div>
          <div>
            <div class="font-extrabold tracking-tight" id="modalTitle">Quiz premium</div>
            <div class="text-xs text-white/60" id="modalSub">Pacotes + personaliza√ß√£o + or√ßamento pr√©-preenchido</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <div class="hidden sm:inline-flex items-center gap-1 p-1 rounded-2xl btn-ghost">
            <button id="langPT" class="ring-focus px-3 py-2 rounded-xl text-sm font-semibold bg-white/10">üáßüá∑ PT</button>
            <button id="langEN" class="ring-focus px-3 py-2 rounded-xl text-sm font-semibold text-white/70">üá∫üá∏ EN</button>
          </div>
          <button id="closeModal" class="ring-focus px-3 py-2 rounded-2xl btn-ghost text-white/85">‚úï</button>
        </div>
      </div>

      <!-- Stepper -->
      <div class="px-5 md:px-7 py-4 border-b border-white/10 bg-black/10">
        <div class="flex items-center justify-between gap-3">
          <div class="text-sm font-semibold text-white/85" id="stepTitle">Etapa</div>
          <div class="text-xs text-white/55" id="stepMeta">0/0</div>
        </div>
        <div class="mt-3 h-2 rounded-full bg-white/10 overflow-hidden">
          <div id="stepBar" class="h-2 rounded-full bg-gradient-to-r from-indigo-400 to-sky-400" style="width:0%"></div>
        </div>
      </div>

      <!-- Body -->
      <div class="flex-1 overflow-y-auto">
        <div class="grid md:grid-cols-[1.35fr_.65fr]">
          <div class="p-5 md:p-7">
            <div id="screen"></div>
          </div>

          <aside class="p-5 md:p-7 border-t md:border-t-0 md:border-l border-white/10 bg-black/15">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold text-white/90" id="sideTitle">Resumo</h3>
              <span class="text-xs text-white/55" id="sideHint">live</span>
            </div>

            <div id="sideSummary" class="mt-4 text-sm text-white/85 space-y-2">
              <div class="text-white/55" id="sideEmpty">Responda para ver recomenda√ß√µes.</div>
            </div>

            <div class="mt-5 rounded-3xl border border-white/10 bg-white/5 p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="text-sm font-semibold text-white/90" id="simTitle">Simula√ß√£o</div>
                <span class="text-xs text-white/55" id="simRule">2=5% ‚Ä¢ 3=8% ‚Ä¢ 4+=12%</span>
              </div>
              <div id="totalsBox" class="text-sm text-white/80 space-y-1">
                <div class="flex justify-between"><span id="lblSub">Subtotal</span><span id="vSub">‚Äî</span></div>
                <div class="flex justify-between"><span id="lblDisc">Desconto</span><span id="vDisc">‚Äî</span></div>
                <div class="flex justify-between"><span id="lblPlans">Planos</span><span id="vPlans">‚Äî</span></div>
                <div class="flex justify-between font-extrabold"><span id="lblTotal">Total</span><span id="vTotal">‚Äî</span></div>
              </div>

              <div class="mt-3 text-xs text-white/55" id="noteTotals">
                *Estimativa para acelerar sua decis√£o.
              </div>
            </div>

            <div class="mt-4 text-xs text-white/50" id="sideStrategy">
              Dica: o pacote ‚ÄúRecomendado‚Äù costuma ter o melhor custo-benef√≠cio.
            </div>
          </aside>
        </div>
      </div>

      <!-- Footer actions -->
      <div class="px-5 md:px-7 py-4 border-t border-white/10 bg-black/15 flex items-center justify-between gap-3">
        <button id="backBtn" class="ring-focus px-4 py-2.5 rounded-2xl btn-ghost text-white/90 hidden">Voltar</button>
        <button id="skipBtn" class="ring-focus px-4 py-2.5 rounded-2xl btn-ghost text-white/80 hidden">Pular</button>
        <button id="nextBtn" class="ring-focus px-5 py-2.5 rounded-2xl btn-primary font-extrabold transition-all disabled:opacity-50 disabled:cursor-not-allowed">Continuar</button>
      </div>

    </div>
  </div>

<script>
(() => {
  // =========================================================
  // 1) CAT√ÅLOGO EMBUTIDO (N√ÉO depende de JSON externo)
  //    - Voc√™ pode substituir por seus servi√ßos reais
  // =========================================================
  const CATALOG = {
    observacoes: "Valores podem variar conforme briefing, revis√µes e prazo. O or√ßamento final confirma tudo.",
    categorias: [
      { nome: "Imagens", servicos: [
        { titulo:"Imagem (B√°sica)", descricao:"Arte r√°pida para post/an√∫ncio.", extras:"1 varia√ß√£o ‚Ä¢ Alta resolu√ß√£o", preco:50 },
        { titulo:"Imagem (Profissional)", descricao:"Mais elaborada para campanhas/carrossel.", extras:"2 varia√ß√µes ‚Ä¢ Ajustes finos", preco:90 },
        { titulo:"Imagem (Premium)", descricao:"Dire√ß√£o de arte premium e acabamento.", extras:"3 varia√ß√µes ‚Ä¢ Refinamento", preco:140 },
      ]},
      { nome: "V√≠deos", servicos: [
        { titulo:"V√≠deo (B√°sico)", descricao:"Cortes, legenda simples e ajustes.", extras:"At√© 30s", preco:120 },
        { titulo:"V√≠deo (Profissional)", descricao:"Ritmo + motion leve + legenda melhor.", extras:"At√© 60s", preco:250 },
        { titulo:"V√≠deo (Premium)", descricao:"Storytelling + motion avan√ßado + est√©tica.", extras:"At√© 90s", preco:420 },
      ]},
      { nome: "Servi√ßos Avulsos", servicos: [
        { titulo:"Logo", descricao:"Logo profissional e vers√°til.", extras:"2 op√ß√µes + ajustes", preco:220 },
        { titulo:"Identidade Visual", descricao:"Guia completo (cores/tipografia/padr√µes).", extras:"Manual de marca", preco:480 },
        { titulo:"Roteiro", descricao:"Roteiro curto com gancho e CTA.", extras:"Estrutura + CTA", preco:120 },
        { titulo:"Copywriting", descricao:"Texto persuasivo para an√∫ncios/p√°ginas.", extras:"1 vers√£o + varia√ß√£o", preco:180 },
        { titulo:"Pacote de An√∫ncios", descricao:"Criativos para tr√°fego pago.", extras:"3 pe√ßas", preco:300 },
        { titulo:"Website", descricao:"Landing page institucional.", extras:"P√°gina √∫nica", preco:650 },
        { titulo:"Narra√ß√£o", descricao:"Narra√ß√£o para v√≠deo/ads.", extras:"√Åudio limpo", preco:150 },
        { titulo:"Trilha Sonora", descricao:"Sele√ß√£o e ajuste de trilha.", extras:"Edi√ß√£o", preco:90 },
      ]},
      { nome: "Planos de Social Media", servicos: [
        {
          titulo:"Plano Mensal (B√°sico)",
          descricao:"Consist√™ncia mensal para presen√ßa profissional.",
          inclui:["10 imagens/m√™s","2 v√≠deos curtos/m√™s"],
          beneficios:["Consist√™ncia","Visual profissional"],
          precos_por_periodo:[
            {periodo:"Mensal", preco_total_sem_desc:750, desconto_percentual:0, preco_total_com_desc:750},
            {periodo:"Trimestral", preco_total_sem_desc:2250, desconto_percentual:10, preco_total_com_desc:2025},
            {periodo:"Semestral", preco_total_sem_desc:4500, desconto_percentual:15, preco_total_com_desc:3825},
            {periodo:"Anual", preco_total_sem_desc:9000, desconto_percentual:20, preco_total_com_desc:7200}
          ]
        },
        {
          titulo:"Plano Mensal (Profissional)",
          descricao:"Mais volume para crescer com variedade.",
          inclui:["20 imagens/m√™s","4 v√≠deos curtos/m√™s"],
          beneficios:["Maior volume","Performance melhor"],
          precos_por_periodo:[
            {periodo:"Mensal", preco_total_sem_desc:1400, desconto_percentual:0, preco_total_com_desc:1400},
            {periodo:"Trimestral", preco_total_sem_desc:4200, desconto_percentual:10, preco_total_com_desc:3780},
            {periodo:"Semestral", preco_total_sem_desc:8400, desconto_percentual:15, preco_total_com_desc:7140},
            {periodo:"Anual", preco_total_sem_desc:16800, desconto_percentual:20, preco_total_com_desc:13440}
          ]
        }
      ]}
    ]
  };

  // =========================================================
  // 2) i18n (UI premium)
  // =========================================================
  const I18N = {
    pt: {
      heroBadge:"Quiz premium ‚Ä¢ Pacotes ‚Ä¢ Economia por combo",
      heroTitle:"Descubra o melhor pacote para vender mais.",
      heroSub:"Responda em ~2 minutos. No final, selecione servi√ßos, veja o total estimado e v√° para o or√ßamento pr√©-preenchido.",
      ctaStart:"Come√ßar",
      miniNoteTitle:"Por que isso converte mais?",
      miniNoteText:"Porque mostra 3 caminhos prontos (Essencial/Recomendado/Scale) + economia por combo.",
      b1t:"Parece consultoria", b1s:"Sugest√µes certeiras, sem parecer ‚Äúvenda for√ßada‚Äù.",
      b2t:"Upsell elegante", b2s:"Add-ons aparecem s√≥ quando aumentam resultado.",
      b3t:"Final r√°pido", b3s:"Or√ßamento com dados + servi√ßos j√° selecionados.",
      previewTitle:"O que voc√™ vai ver", previewTime:"~2 min",
      p1t:"1) Diagn√≥stico", p1s:"Objetivo, canal, volume, prazo e or√ßamento.",
      p2t:"2) 3 pacotes", p2s:"Escolha r√°pido ou personalize.",
      p3t:"3) Economia", p3s:"Simula√ß√£o autom√°tica de desconto por combo.",
      dealTitle:"Combo (simulado)", dealText:"2 servi√ßos: 5% ‚Ä¢ 3: 8% ‚Ä¢ 4+: 12%",
      footerLine:"*Valores e descontos s√£o estimativas para facilitar a decis√£o.",

      modalTitle:"Quiz premium",
      modalSub:"Pacotes + personaliza√ß√£o + or√ßamento pr√©-preenchido",
      sideTitle:"Resumo",
      sideEmpty:"Responda para ver recomenda√ß√µes.",
      simTitle:"Simula√ß√£o",
      lblSub:"Subtotal (avulsos)",
      lblDisc:"Desconto combo",
      lblPlans:"Planos",
      lblTotal:"Total",
      noteTotals:"*Estimativa para acelerar sua decis√£o.",
      sideStrategy:"Dica: o pacote ‚ÄúRecomendado‚Äù costuma ter o melhor custo-benef√≠cio.",

      back:"Voltar",
      next:"Continuar",
      skip:"Pular",

      // steps
      step:"Etapa",
      stepOf:"de",
      // questions
      q_goal:"Qual √© o seu objetivo principal?",
      goal_sales:"Gerar vendas/convers√£o",
      goal_social:"Conte√∫do cont√≠nuo para redes",
      goal_brand:"Fortalecer marca/branding",
      goal_edu:"Educar/explicar (conte√∫do t√©cnico)",
      q_channels:"Onde voc√™ vai publicar?",
      ch_instagram:"Instagram (Feed/Reels/Stories)",
      ch_tiktok:"TikTok",
      ch_youtube:"YouTube Shorts",
      ch_whatsapp:"WhatsApp",
      ch_site:"Site / Landing page",
      ch_multi:"V√°rios canais",
      q_focus:"Qual √°rea √© prioridade agora?",
      focus_auto:"Quero recomenda√ß√£o autom√°tica",
      focus_images:"Imagens / artes",
      focus_videos:"V√≠deos",
      focus_ads:"An√∫ncios (criativos)",
      focus_brand:"Branding (logo/identidade)",
      focus_site:"Site / landing",
      q_assets:"Voc√™ j√° tem materiais prontos?",
      as_yes:"Sim (logo/fotos/brand)",
      as_some:"Tenho algo, mas incompleto",
      as_no:"N√£o, preciso criar do zero",
      q_volume:"Volume aproximado",
      vol_low:"Pequeno (1‚Äì5 pe√ßas)",
      vol_mid:"M√©dio (6‚Äì15 pe√ßas)",
      vol_high:"Alto (15+ / premium)",
      q_budget:"Faixa de or√ßamento (aprox.)",
      bud_100:"At√© R$100",
      bud_300:"At√© R$300",
      bud_800:"At√© R$800",
      bud_more:"Acima de R$800",
      q_deadline:"Prazo desejado",
      dl_3:"At√© 3 dias",
      dl_7:"At√© 7 dias",
      dl_more:"Mais que 7 dias",
      q_pref:"Como prefere contratar?",
      pref_bundle:"Pacote (combos)",
      pref_single:"Avulso (1 servi√ßo)",
      pref_any:"Indiferente",

      // results
      resultsTitle:"Seu resultado",
      resultsSub:"Escolha um pacote pronto ou personalize selecionando servi√ßos.",
      pack_essential:"Essencial",
      pack_reco:"Recomendado",
      pack_scale:"Scale",
      badge_essential:"Come√ßar r√°pido",
      badge_reco:"Melhor custo-benef√≠cio",
      badge_scale:"M√°ximo impacto",
      selectPack:"Selecionar pacote",
      customize:"Personalizar servi√ßos",
      selected:"Selecionados",
      period:"Per√≠odo",
      savings:"economiza",
      goQuote:"Finalizar e ir para or√ßamento",
      copy:"Copiar resumo",
      copied:"Copiado!",
      notes:"Observa√ß√µes",
      estTotal:"Total estimado",
      comboHint:"2+ avulsos liberam desconto de combo (simulado)."
    },

    en: {
      heroBadge:"Premium quiz ‚Ä¢ Bundles ‚Ä¢ Combo savings",
      heroTitle:"Find the best package to sell more.",
      heroSub:"Answer in ~2 minutes. Then select services, see the estimated total, and go to a pre-filled quote page.",
      ctaStart:"Start",
      miniNoteTitle:"Why does this convert better?",
      miniNoteText:"Because it shows 3 ready paths (Essential/Recommended/Scale) + combo savings.",
      b1t:"Feels like consulting", b1s:"Confident suggestions without pushy sales.",
      b2t:"Elegant upsell", b2s:"Add-ons appear only when they increase results.",
      b3t:"Fast finish", b3s:"Quote page already filled with your picks.",
      previewTitle:"What you'll get", previewTime:"~2 min",
      p1t:"1) Diagnosis", p1s:"Goal, channel, volume, deadline and budget.",
      p2t:"2) 3 bundles", p2s:"Pick fast or customize.",
      p3t:"3) Savings", p3s:"Automatic combo discount simulation.",
      dealTitle:"Combo (simulated)", dealText:"2 services: 5% ‚Ä¢ 3: 8% ‚Ä¢ 4+: 12%",
      footerLine:"*Prices and discounts are estimates to speed up decision-making.",

      modalTitle:"Premium quiz",
      modalSub:"Bundles + customization + pre-filled quote",
      sideTitle:"Summary",
      sideEmpty:"Answer to see recommendations.",
      simTitle:"Simulation",
      lblSub:"Subtotal (one-offs)",
      lblDisc:"Combo discount",
      lblPlans:"Plans",
      lblTotal:"Total",
      noteTotals:"*Estimate to speed up your decision.",
      sideStrategy:"Tip: the ‚ÄúRecommended‚Äù bundle is usually the best value.",

      back:"Back",
      next:"Continue",
      skip:"Skip",

      step:"Step",
      stepOf:"of",

      q_goal:"What's your main goal?",
      goal_sales:"Drive sales/conversions",
      goal_social:"Ongoing social content",
      goal_brand:"Strengthen brand/branding",
      goal_edu:"Educate/explain (technical)",
      q_channels:"Where will you publish?",
      ch_instagram:"Instagram (Feed/Reels/Stories)",
      ch_tiktok:"TikTok",
      ch_youtube:"YouTube Shorts",
      ch_whatsapp:"WhatsApp",
      ch_site:"Website / Landing page",
      ch_multi:"Multiple channels",
      q_focus:"What's the priority area right now?",
      focus_auto:"Auto recommendation",
      focus_images:"Images / creatives",
      focus_videos:"Videos",
      focus_ads:"Ads (creatives)",
      focus_brand:"Branding (logo/identity)",
      focus_site:"Website / landing",
      q_assets:"Do you have assets ready?",
      as_yes:"Yes (logo/photos/brand)",
      as_some:"Some, but incomplete",
      as_no:"No, need to build from scratch",
      q_volume:"Estimated volume",
      vol_low:"Small (1‚Äì5 items)",
      vol_mid:"Medium (6‚Äì15 items)",
      vol_high:"High (15+ / premium)",
      q_budget:"Budget range (approx.)",
      bud_100:"Up to R$100",
      bud_300:"Up to R$300",
      bud_800:"Up to R$800",
      bud_more:"Above R$800",
      q_deadline:"Desired deadline",
      dl_3:"Up to 3 days",
      dl_7:"Up to 7 days",
      dl_more:"More than 7 days",
      q_pref:"How do you prefer to hire?",
      pref_bundle:"Bundle (combos)",
      pref_single:"Single service",
      pref_any:"No preference",

      resultsTitle:"Your result",
      resultsSub:"Pick a ready bundle or customize by selecting services.",
      pack_essential:"Essential",
      pack_reco:"Recommended",
      pack_scale:"Scale",
      badge_essential:"Start fast",
      badge_reco:"Best value",
      badge_scale:"Max impact",
      selectPack:"Select bundle",
      customize:"Customize services",
      selected:"Selected",
      period:"Period",
      savings:"save",
      goQuote:"Finish and go to quote",
      copy:"Copy summary",
      copied:"Copied!",
      notes:"Notes",
      estTotal:"Estimated total",
      comboHint:"2+ one-offs unlock combo discount (simulated)."
    }
  };

  // =========================================================
  // 3) DOM
  // =========================================================
  const $ = (id)=>document.getElementById(id);
  const modal = $('modal');
  const modalPanel = $('modalPanel');
  const screen = $('screen');
  const openModalBtn = $('openModal');
  const closeModalBtn = $('closeModal');
  const backdrop = $('backdrop');

  const backBtn = $('backBtn');
  const nextBtn = $('nextBtn');
  const skipBtn = $('skipBtn');

  const stepTitle = $('stepTitle');
  const stepMeta = $('stepMeta');
  const stepBar = $('stepBar');

  const sideSummary = $('sideSummary');
  const sideEmpty = $('sideEmpty');

  const vSub = $('vSub');
  const vDisc = $('vDisc');
  const vPlans = $('vPlans');
  const vTotal = $('vTotal');

  const langPTTop = $('langPTTop');
  const langENTop = $('langENTop');
  const langPT = $('langPT');
  const langEN = $('langEN');

  // =========================================================
  // 4) State & helpers
  // =========================================================
  let lang = (localStorage.getItem('comercias_lang') || '').toLowerCase();
  if(lang !== 'pt' && lang !== 'en'){
    const nav = (navigator.language || 'pt').toLowerCase();
    lang = nav.startsWith('en') ? 'en' : 'pt';
  }
  const t = (k)=> I18N[lang]?.[k] ?? k;

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function money(n){
    const num = Number(n);
    if(!isFinite(num)) return '‚Äî';
    return new Intl.NumberFormat(lang==='en'?'en-US':'pt-BR',{style:'currency',currency:'BRL'}).format(num);
  }

  function showModal(){
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setTimeout(()=>modalPanel.classList.add('show'), 10);
  }
  function hideModal(){
    modalPanel.classList.remove('show');
    setTimeout(()=>{
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }, 150);
  }

  openModalBtn.addEventListener('click', showModal);
  closeModalBtn.addEventListener('click', hideModal);
  backdrop.addEventListener('click', hideModal);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && !modal.classList.contains('hidden')) hideModal(); });

  // Build services index
  const allServices = [];
  CATALOG.categorias.forEach((cat)=>{
    (cat.servicos||[]).forEach((s, idx)=>{
      const isPlan = Array.isArray(s.precos_por_periodo) && s.precos_por_periodo.length;
      const minPrice = isPlan
        ? Number((s.precos_por_periodo.find(p=>String(p.periodo).toLowerCase().includes('mensal')) || s.precos_por_periodo[0]).preco_total_com_desc || 0)
        : Number(s.preco || 0);

      const text = [
        cat.nome, s.titulo||'', s.descricao||'', s.extras||'',
        (Array.isArray(s.inclui)?s.inclui.join(' '):''),
        (Array.isArray(s.beneficios)?s.beneficios.join(' '):'')
      ].join(' ').toLowerCase();

      allServices.push({
        ...s,
        __id: `${cat.nome}::${s.titulo || 'Servi√ßo'}::${idx}`,
        __cat: cat.nome,
        __isPlan: isPlan,
        __minPrice: isFinite(minPrice) ? minPrice : 0,
        __text: text
      });
    });
  });

  const state = {
    step: 0,
    answers: {
      goal: null,
      channels: [],
      focus: null,
      assets: null,
      volume: null,
      budget: null,
      deadline: null,
      pref: null
    },
    selected: new Map() // id -> {id, period?}
  };

  // =========================================================
  // 5) Questions (premium = menos perguntas, mais decisivas)
  // =========================================================
  const steps = [
    {
      id:'goal', type:'single', titleKey:'q_goal', required:true,
      options: [
        { value:'sales', labelKey:'goal_sales', icon:'üí∏' },
        { value:'social', labelKey:'goal_social', icon:'üìà' },
        { value:'brand', labelKey:'goal_brand', icon:'‚ú®' },
        { value:'edu', labelKey:'goal_edu', icon:'üéì' },
      ]
    },
    {
      id:'channels', type:'multi', titleKey:'q_channels', required:true, min:1,
      options: [
        { value:'instagram', labelKey:'ch_instagram' },
        { value:'tiktok', labelKey:'ch_tiktok' },
        { value:'youtube', labelKey:'ch_youtube' },
        { value:'whatsapp', labelKey:'ch_whatsapp' },
        { value:'site', labelKey:'ch_site' },
        { value:'multi', labelKey:'ch_multi' },
      ]
    },
    {
      id:'focus', type:'single', titleKey:'q_focus', required:true,
      options: [
        { value:'auto', labelKey:'focus_auto', icon:'üß†' },
        { value:'images', labelKey:'focus_images', icon:'üñºÔ∏è' },
        { value:'videos', labelKey:'focus_videos', icon:'üé¨' },
        { value:'ads', labelKey:'focus_ads', icon:'üì£' },
        { value:'brand', labelKey:'focus_brand', icon:'üè∑Ô∏è' },
        { value:'site', labelKey:'focus_site', icon:'üß©' },
      ]
    },
    {
      id:'assets', type:'single', titleKey:'q_assets', required:true,
      options: [
        { value:'yes', labelKey:'as_yes', icon:'‚úÖ' },
        { value:'some', labelKey:'as_some', icon:'üü®' },
        { value:'no', labelKey:'as_no', icon:'üß±' },
      ]
    },
    {
      id:'volume', type:'single', titleKey:'q_volume', required:true,
      options: [
        { value:'low', labelKey:'vol_low', icon:'ü•à' },
        { value:'mid', labelKey:'vol_mid', icon:'ü•á' },
        { value:'high', labelKey:'vol_high', icon:'üèÜ' },
      ]
    },
    {
      id:'budget', type:'single', titleKey:'q_budget', required:true,
      options: [
        { value:100, labelKey:'bud_100', icon:'üí†' },
        { value:300, labelKey:'bud_300', icon:'üíé' },
        { value:800, labelKey:'bud_800', icon:'üëë' },
        { value:999999, labelKey:'bud_more', icon:'üöÄ' },
      ]
    },
    {
      id:'deadline', type:'single', titleKey:'q_deadline', required:false, skippable:true,
      options: [
        { value:'3d', labelKey:'dl_3', icon:'‚ö°' },
        { value:'7d', labelKey:'dl_7', icon:'üóìÔ∏è' },
        { value:'more', labelKey:'dl_more', icon:'üåø' },
      ]
    },
    {
      id:'pref', type:'single', titleKey:'q_pref', required:true,
      options: [
        { value:'bundle', labelKey:'pref_bundle', icon:'üì¶' },
        { value:'single', labelKey:'pref_single', icon:'üß©' },
        { value:'any', labelKey:'pref_any', icon:'‚öñÔ∏è' },
      ]
    }
  ];

  // =========================================================
  // 6) Scoring & packages (mais ‚Äúinteligente‚Äù e est√°vel)
  // =========================================================
  function comboPerc(qtd){
    if(qtd >= 4) return 12;
    if(qtd === 3) return 8;
    if(qtd === 2) return 5;
    return 0;
  }

  function scoreService(s){
    const a = state.answers;
    let score = 0;

    // Budget fit
    const budget = Number(a.budget || 999999);
    if(budget !== 999999 && s.__minPrice && s.__minPrice > budget) score -= 10;
    if(budget !== 999999 && s.__minPrice && s.__minPrice <= budget) score += 3;

    // Focus mapping
    const cat = (s.__cat||'').toLowerCase();
    if(a.focus === 'images' && /imagens/.test(cat)) score += 8;
    if(a.focus === 'videos' && /v√≠deos|videos/.test(cat)) score += 8;
    if(a.focus === 'ads' && /an√∫ncios|ads|avulsos/.test(cat)) score += 6;
    if(a.focus === 'brand' && /avulsos/.test(cat)) score += 3;
    if(a.focus === 'site' && /avulsos/.test(cat)) score += 3;

    // Keyword based
    const txt = s.__text || '';
    if(a.goal === 'sales'){
      if(/an√∫nc|ads|promo|oferta|cta|copy|venda|convers/.test(txt)) score += 7;
      if(/v√≠deo|video/.test(txt)) score += 2;
    }
    if(a.goal === 'social'){
      if(s.__isPlan) score += 10;
      if(/imagem|imagens|v√≠deo|video|conte√∫do|reels|tiktok|shorts/.test(txt)) score += 5;
    }
    if(a.goal === 'brand'){
      if(/logo|identidade|marca|branding/.test(txt)) score += 9;
      if(/website|site|landing/.test(txt)) score += 3;
    }
    if(a.goal === 'edu'){
      if(/roteiro|narra√ß√£o|narracao|v√≠deo|video/.test(txt)) score += 7;
    }

    // Channels
    const ch = a.channels || [];
    if(ch.includes('site') && /website|site|landing/.test(txt)) score += 5;
    if((ch.includes('instagram')||ch.includes('tiktok')||ch.includes('youtube')||ch.includes('multi')) && /v√≠deo|video|imagem|reels|shorts|tiktok/.test(txt)) score += 2;
    if(ch.includes('whatsapp') && /imagem|banner|arte|imagens/.test(txt)) score += 2;

    // Assets upsell
    if(a.assets === 'no'){
      if(/logo|identidade/.test(txt)) score += 6;
      if(/roteiro|copy/.test(txt)) score += 3;
    }
    if(a.assets === 'some'){
      if(/identidade|copy|roteiro/.test(txt)) score += 3;
    }

    // Volume: favor basic/pro/premium
    if(!s.__isPlan){
      if(a.volume === 'low' && /(b√°sic|basic)/.test(txt)) score += 2;
      if(a.volume === 'mid' && /(profissional|professional)/.test(txt)) score += 2;
      if(a.volume === 'high' && /(premium)/.test(txt)) score += 2;
    }

    // Deadline: slight priority for faster services (if described)
    if(a.deadline === '3d' && /(r√°pid|express|fast)/.test(txt)) score += 2;

    // Prefer bundles
    if(a.pref === 'bundle' && s.__isPlan) score += 3;

    return score;
  }

  function topServices(limit=14){
    const budget = Number(state.answers.budget || 999999);
    const scored = allServices
      .map(s => ({ s, score: scoreService(s) }))
      .filter(x => budget === 999999 || !x.s.__minPrice || x.s.__minPrice <= budget || x.s.__isPlan)
      .sort((a,b)=> (b.score - a.score) || ((a.s.__minPrice||0) - (b.s.__minPrice||0)));
    const pos = scored.filter(x=>x.score > 0).map(x=>x.s);
    return (pos.length ? pos : scored.map(x=>x.s)).slice(0, limit);
  }

  function findByTitle(re){
    return allServices.find(s => re.test((s.titulo||'')+' '+(s.descricao||'')));
  }

  function buildPackages(list){
    const a = state.answers;

    const plan = list.find(s => s.__isPlan);
    const img = list.find(s => /imagens/i.test(s.__cat));
    const vid = list.find(s => /v√≠deos|videos/i.test(s.__cat));
    const logo = findByTitle(/\blogo\b/i);
    const idv  = findByTitle(/identidade/i);
    const ads  = findByTitle(/an√∫ncio|ads|pacote de an√∫ncios/i);
    const site = findByTitle(/website|site/i);
    const copy = findByTitle(/copy/i);
    const rot  = findByTitle(/roteiro/i);

    const essential = [];
    if(a.goal === 'social' && plan) essential.push({id: plan.__id, period: 'Mensal'});
    else {
      if(img) essential.push({id: img.__id});
      if((a.goal === 'sales' || a.goal === 'edu') && vid) essential.push({id: vid.__id});
      if(!essential.length && list[0]) essential.push({id: list[0].__id});
    }

    const recommended = [...essential];
    if(a.assets !== 'yes'){
      if(logo && !recommended.find(x=>x.id===logo.__id)) recommended.unshift({id: logo.__id});
      else if(idv && !recommended.find(x=>x.id===idv.__id)) recommended.unshift({id: idv.__id});
    }
    if(a.goal === 'sales'){
      if(ads && !recommended.find(x=>x.id===ads.__id)) recommended.push({id: ads.__id});
      if(copy && !recommended.find(x=>x.id===copy.__id)) recommended.push({id: copy.__id});
    }
    if(a.goal === 'edu'){
      if(rot && !recommended.find(x=>x.id===rot.__id)) recommended.push({id: rot.__id});
    }
    if((a.channels||[]).includes('site')){
      if(site && !recommended.find(x=>x.id===site.__id)) recommended.push({id: site.__id});
    }
    if(a.pref === 'bundle' && plan && !recommended.find(x=>x.id===plan.__id)) recommended.unshift({id: plan.__id, period:'Mensal'});

    const scale = [...recommended];
    // add a couple more top items
    list.slice(0, 8).forEach(s=>{
      if(scale.length >= 6) return;
      if(!scale.find(x=>x.id===s.__id)) scale.push({id: s.__id, period: s.__isPlan ? 'Mensal' : undefined});
    });

    return [
      { key:'essential', titleKey:'pack_essential', badgeKey:'badge_essential', items: essential },
      { key:'recommended', titleKey:'pack_reco', badgeKey:'badge_reco', items: recommended },
      { key:'scale', titleKey:'pack_scale', badgeKey:'badge_scale', items: scale }
    ];
  }

  function computeTotals(selectedMap){
    const selected = Array.from(selectedMap.values());
    const oneOff = [];
    const plans = [];

    selected.forEach(it=>{
      const s = allServices.find(x=>x.__id===it.id);
      if(!s) return;
      if(s.__isPlan) plans.push({s, period: it.period || 'Mensal'});
      else oneOff.push(s);
    });

    let subtotal = 0;
    oneOff.forEach(s=> subtotal += Number(s.preco || s.__minPrice || 0));

    const perc = comboPerc(oneOff.length);
    const disc = Math.round(subtotal * (perc/100) * 100)/100;

    let planTotal = 0;
    plans.forEach(({s, period})=>{
      const opt = (s.precos_por_periodo||[]).find(p => String(p.periodo).toLowerCase() === String(period).toLowerCase())
              || (s.precos_por_periodo||[])[0];
      planTotal += Number(opt?.preco_total_com_desc || s.__minPrice || 0);
    });

    const total = (subtotal - disc) + planTotal;
    return { subtotal, disc, planTotal, total, perc, count: selected.length, oneOffCount: oneOff.length };
  }

  function updateTotalsUI(){
    const tot = computeTotals(state.selected);
    vSub.textContent = money(tot.subtotal);
    vDisc.textContent = tot.disc ? `-${money(tot.disc)} (${tot.perc}%)` : '‚Äî';
    vPlans.textContent = tot.planTotal ? money(tot.planTotal) : '‚Äî';
    vTotal.textContent = money(tot.total);
  }

  function renderSideSummary(){
    const a = state.answers;
    const lines = [];

    const label = (kPt, kEn)=> (lang==='en'?kEn:kPt);

    if(a.goal) lines.push([label('Objetivo','Goal'), a.goal]);
    if(a.channels?.length) lines.push([label('Canais','Channels'), a.channels.join(', ')]);
    if(a.focus) lines.push([label('Prioridade','Priority'), a.focus]);
    if(a.assets) lines.push([label('Materiais','Assets'), a.assets]);
    if(a.volume) lines.push([label('Volume','Volume'), a.volume]);
    if(a.budget) lines.push([label('Or√ßamento','Budget'), `R$${a.budget}`]);
    if(a.deadline) lines.push([label('Prazo','Deadline'), a.deadline]);
    if(a.pref) lines.push([label('Prefer√™ncia','Preference'), a.pref]);

    if(!lines.length){
      sideSummary.innerHTML = `<div class="text-white/55">${escapeHtml(t('sideEmpty'))}</div>`;
      return;
    }

    sideSummary.innerHTML = `
      <div class="space-y-2">
        ${lines.map(([k,v])=>`
          <div class="flex justify-between gap-3">
            <span class="text-white/55">${escapeHtml(k)}</span>
            <span class="text-white/90 font-semibold text-right">${escapeHtml(String(v))}</span>
          </div>
        `).join('')}
      </div>
    `;
  }

  // =========================================================
  // 7) Render step UI (sem re-render pesado ‚Äî s√≥ a tela)
  // =========================================================
  function setStepUI(){
    const total = steps.length + 1; // + results
    const current = Math.min(state.step + 1, total);
    const pct = Math.round(((current-1)/(total-1))*100);

    stepTitle.textContent = `${t('step')} ${current} ${t('stepOf')} ${total}`;
    stepMeta.textContent = `${current}/${total}`;
    stepBar.style.width = `${pct}%`;

    backBtn.classList.toggle('hidden', state.step === 0);
    skipBtn.classList.toggle('hidden', !(steps[state.step]?.skippable));
    skipBtn.textContent = t('skip');
    backBtn.textContent = t('back');
    nextBtn.textContent = t('next');
  }

  function setScreen(html){
    screen.innerHTML = html;
    const el = screen.querySelector('.fade');
    if(el) setTimeout(()=>el.classList.add('show'), 10);
  }

  function canProceed(){
    if(state.step >= steps.length) return true; // results screen
    const st = steps[state.step];
    const v = state.answers[st.id];

    if(st.type === 'single'){
      return v !== null && v !== undefined;
    }
    if(st.type === 'multi'){
      return Array.isArray(v) && v.length >= (st.min || 1);
    }
    return true;
  }

  function renderCurrent(){
    setStepUI();
    renderSideSummary();
    updateTotalsUI();

    // results
    if(state.step >= steps.length){
      renderResults();
      return;
    }

    const st = steps[state.step];
    const title = t(st.titleKey);

    if(st.type === 'single'){
      const active = state.answers[st.id];
      setScreen(`
        <div class="fade">
          <div class="mb-4">
            <div class="text-white font-extrabold text-2xl tracking-tight">${escapeHtml(title)}</div>
            <div class="text-white/60 text-sm mt-1">${escapeHtml(lang==='en' ? 'Pick one option to continue.' : 'Escolha uma op√ß√£o para continuar.')}</div>
          </div>

          <div class="grid gap-3">
            ${st.options.map(o=>{
              const isActive = String(active) === String(o.value);
              return `
                <button class="opt ${isActive?'active':''} ring-focus w-full text-left rounded-3xl px-4 py-4" data-val="${escapeHtml(o.value)}">
                  <div class="flex items-start justify-between gap-3">
                    <div class="flex items-start gap-3">
                      ${o.icon ? `<div class="h-10 w-10 rounded-2xl bg-white/8 border border-white/10 flex items-center justify-center">${escapeHtml(o.icon)}</div>` : ``}
                      <div>
                        <div class="font-extrabold text-white/95">${escapeHtml(t(o.labelKey))}</div>
                        <div class="text-sm text-white/55 mt-1">${escapeHtml(lang==='en' ? 'Tap to select' : 'Toque para selecionar')}</div>
                      </div>
                    </div>
                    <span class="text-white/35 mt-1">‚Üí</span>
                  </div>
                </button>
              `;
            }).join('')}
          </div>

          <div class="mt-4 text-xs text-white/50">${escapeHtml(CATALOG.observacoes || '')}</div>
        </div>
      `);

      screen.querySelectorAll('button[data-val]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const val = btn.dataset.val;
          state.answers[st.id] = isNaN(Number(val)) ? val : Number(val);
          nextBtn.disabled = !canProceed();
          renderCurrent(); // re-render only this step (small)
        });
      });
    }

    if(st.type === 'multi'){
      const current = Array.isArray(state.answers[st.id]) ? state.answers[st.id] : [];
      const min = st.min || 1;

      setScreen(`
        <div class="fade">
          <div class="mb-4">
            <div class="text-white font-extrabold text-2xl tracking-tight">${escapeHtml(title)}</div>
            <div class="text-white/60 text-sm mt-1">${escapeHtml(lang==='en' ? `Select at least ${min}.` : `Selecione pelo menos ${min}.`)}</div>
          </div>

          <div class="flex flex-wrap gap-2.5">
            ${st.options.map(o=>{
              const isActive = current.includes(o.value);
              return `
                <button type="button" class="chip ${isActive?'active':''} ring-focus px-4 py-3 rounded-2xl text-sm font-bold transition-all" data-val="${escapeHtml(o.value)}">
                  ${escapeHtml(t(o.labelKey))}
                </button>
              `;
            }).join('')}
          </div>

          <div class="mt-5 rounded-2xl panel p-4 flex items-center justify-between">
            <div class="text-sm text-white/70">
              <span class="font-extrabold text-white">${escapeHtml(t('selected'))}</span>: ${current.length}
              <span class="text-white/45">‚Ä¢</span>
              <span class="text-white/60">${escapeHtml(t('comboHint'))}</span>
            </div>
            <div class="text-xs text-white/55">${escapeHtml(lang==='en'?'You can pick multiple':'Voc√™ pode escolher v√°rios')}</div>
          </div>
        </div>
      `);

      screen.querySelectorAll('button[data-val]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const val = btn.dataset.val;
          let cur = Array.isArray(state.answers[st.id]) ? [...state.answers[st.id]] : [];
          if(cur.includes(val)) cur = cur.filter(x=>x!==val);
          else cur.push(val);
          state.answers[st.id] = cur;
          nextBtn.disabled = !canProceed();
          renderCurrent();
        });
      });
    }

    nextBtn.disabled = !canProceed();
  }

  // =========================================================
  // 8) Results (render 1x e atualiza por eventos)
  // =========================================================
  function buildSummaryText(){
    const a = state.answers;
    const tot = computeTotals(state.selected);

    const linesPt = [
      `- Objetivo: ${a.goal}`,
      `- Canais: ${(a.channels||[]).join(', ')}`,
      `- Prioridade: ${a.focus}`,
      `- Materiais: ${a.assets}`,
      `- Volume: ${a.volume}`,
      `- Or√ßamento: R$${a.budget}`,
      `- Prazo: ${a.deadline || '‚Äî'}`,
      `- Prefer√™ncia: ${a.pref}`,
      `- Total estimado: ${money(tot.total)}`
    ];

    const linesEn = [
      `- Goal: ${a.goal}`,
      `- Channels: ${(a.channels||[]).join(', ')}`,
      `- Priority: ${a.focus}`,
      `- Assets: ${a.assets}`,
      `- Volume: ${a.volume}`,
      `- Budget: R$${a.budget}`,
      `- Deadline: ${a.deadline || '‚Äî'}`,
      `- Preference: ${a.pref}`,
      `- Estimated total: ${money(tot.total)}`
    ];

    return (lang==='en'?linesEn:linesPt).join('\n');
  }

  function serviceCardHTML(s, checked){
    const priceLabel = s.__isPlan ? money(s.__minPrice) : money(s.preco || s.__minPrice || 0);
    const periodSel = (s.__isPlan && checked)
      ? `
        <div class="mt-3">
          <label class="text-xs text-white/55">${escapeHtml(t('period'))}</label>
          <select class="planPeriod ring-focus mt-1 w-full border border-white/10 bg-white/6 rounded-2xl px-3 py-2.5 text-sm text-white" data-id="${escapeHtml(s.__id)}">
            ${(s.precos_por_periodo||[]).map(p=>{
              const cur = state.selected.get(s.__id)?.period || 'Mensal';
              const selected = String(cur).toLowerCase() === String(p.periodo).toLowerCase() ? 'selected' : '';
              const econ = Math.max(0, Number(p.preco_total_sem_desc||0) - Number(p.preco_total_com_desc||0));
              const econTxt = econ>0 ? ` ‚Ä¢ ${t('savings')} ${money(econ)}` : '';
              return `<option value="${escapeHtml(p.periodo)}" ${selected}>${escapeHtml(p.periodo)} ‚Äî ${money(p.preco_total_com_desc)}${econTxt}</option>`;
            }).join('')}
          </select>
        </div>
      ` : '';

    return `
      <label class="rounded-3xl border border-white/10 bg-white/5 hover:bg-white/10 transition-all p-4 flex gap-3">
        <input type="checkbox" class="svcCheck mt-1.5 h-4 w-4 accent-indigo-400" data-id="${escapeHtml(s.__id)}" ${checked?'checked':''}>
        <div class="flex-1">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-extrabold text-white/95">${escapeHtml(s.titulo || 'Servi√ßo')}</div>
              <div class="text-xs text-white/50 mt-0.5">${escapeHtml(s.__cat)}</div>
            </div>
            <div class="text-emerald-300 font-extrabold whitespace-nowrap">${escapeHtml(priceLabel)}</div>
          </div>
          <div class="mt-2 text-sm text-white/70">${escapeHtml((s.descricao||''))}</div>
          ${s.extras ? `<div class="mt-2 text-xs text-white/55">${escapeHtml(s.extras)}</div>` : ''}
          ${periodSel}
        </div>
      </label>
    `;
  }

  function renderResults(){
    // build default selection once
    if(state.selected.size === 0){
      const list = topServices(16);
      const packs = buildPackages(list);
      (packs.find(p=>p.key==='recommended') || packs[0]).items.forEach(it=>{
        state.selected.set(it.id, { id: it.id, period: it.period });
      });
    }

    const list = topServices(18);
    const packs = buildPackages(list);

    const tot = computeTotals(state.selected);

    const packCards = packs.map(p=>{
      // compute totals if applied
      const temp = new Map();
      p.items.forEach(it=> temp.set(it.id, {id:it.id, period: it.period}));
      const tp = computeTotals(temp);
      const badgeKey = p.key==='essential'?'badge_essential':(p.key==='recommended'?'badge_reco':'badge_scale');

      const highlight = p.key==='recommended';
      return `
        <div class="rounded-3xl p-4 md:p-5 border ${highlight ? 'border-white/28 bg-white/10' : 'border-white/10 bg-white/5'}">
          <div class="flex items-center justify-between gap-3">
            <div class="text-lg font-extrabold">${escapeHtml(t(p.key==='essential'?'pack_essential':p.key==='recommended'?'pack_reco':'pack_scale'))}</div>
            <span class="text-xs px-2 py-1 rounded-full border border-white/10 bg-white/5 text-white/80 font-semibold">${escapeHtml(t(badgeKey))}</span>
          </div>

          <div class="mt-3 space-y-1">
            ${p.items.slice(0,6).map(it=>{
              const s = allServices.find(x=>x.__id===it.id);
              if(!s) return '';
              return `<div class="text-sm text-white/80">‚Ä¢ ${escapeHtml(s.titulo)}</div>`;
            }).join('')}
          </div>

          <div class="mt-4 flex items-end justify-between gap-3">
            <div>
              <div class="text-xs text-white/55">${escapeHtml(t('estTotal'))}</div>
              <div class="text-xl font-extrabold text-emerald-300">${money(tp.total)}</div>
              <div class="text-xs text-white/55">${tp.disc ? `-${money(tp.disc)} combo` : '‚Äî'}</div>
            </div>
            <button class="pickPack ring-focus px-4 py-2.5 rounded-2xl font-extrabold ${highlight ? 'btn-primary text-white' : 'bg-white text-slate-900'}"
              data-pack="${escapeHtml(p.key)}">
              ${escapeHtml(t('selectPack'))}
            </button>
          </div>
        </div>
      `;
    }).join('');

    // curated checklist = top list + keep selected at top
    const selectedIds = new Set(Array.from(state.selected.keys()));
    const curated = [
      ...allServices.filter(s=>selectedIds.has(s.__id)),
      ...list.filter(s=>!selectedIds.has(s.__id))
    ].slice(0, 16);

    const servicesHTML = curated.map(s=>{
      const checked = state.selected.has(s.__id);
      return serviceCardHTML(s, checked);
    }).join('');

    setScreen(`
      <div class="fade">
        <div class="flex items-start justify-between gap-3 mb-5">
          <div>
            <div class="text-2xl md:text-3xl font-extrabold tracking-tight">${escapeHtml(t('resultsTitle'))}</div>
            <div class="text-white/65 text-sm mt-1">${escapeHtml(t('resultsSub'))}</div>
          </div>
          <button id="restart" class="ring-focus px-4 py-2.5 rounded-2xl btn-ghost font-extrabold">${escapeHtml(lang==='en'?'Restart':'Refazer')}</button>
        </div>

        <div class="grid md:grid-cols-3 gap-3 mb-6">
          ${packCards}
        </div>

        <div class="flex items-center justify-between gap-3 mb-3">
          <div class="text-white font-extrabold text-lg">${escapeHtml(t('customize'))}</div>
          <div class="text-xs text-white/55">${escapeHtml(t('comboHint'))}</div>
        </div>

        <div id="svcList" class="grid gap-3 mb-6">
          ${servicesHTML}
        </div>

        <div class="rounded-3xl border border-white/10 bg-white/5 p-4 md:p-5 mb-4">
          <div class="text-white font-extrabold mb-2">${escapeHtml(lang==='en'?'Auto summary (goes to quote)':'Resumo autom√°tico (vai pro or√ßamento)')}</div>
          <pre id="summaryText" class="whitespace-pre-wrap text-sm text-white/80">${escapeHtml(buildSummaryText())}</pre>
          <div class="mt-3 text-xs text-white/55">${escapeHtml(t('notes'))}: ${escapeHtml(CATALOG.observacoes || '')}</div>
        </div>

        <!-- Mobile sticky bar -->
        <div class="stickyMobileBar rounded-3xl border border-white/10 bg-black/35 p-4 md:hidden">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xs text-white/55">${escapeHtml(t('selected'))}: <span id="mCount" class="text-white/85 font-extrabold">${tot.count}</span></div>
              <div class="text-lg font-extrabold text-emerald-300" id="mTotal">${money(tot.total)}</div>
            </div>
            <button id="goQuoteMobile" class="ring-focus btn-primary px-4 py-3 rounded-2xl font-extrabold">${escapeHtml(t('goQuote'))}</button>
          </div>
        </div>

        <!-- Desktop buttons -->
        <div class="hidden md:flex gap-3">
          <button id="copySummary" class="ring-focus btn-ghost px-6 py-3.5 rounded-2xl font-extrabold">${escapeHtml(t('copy'))}</button>
          <button id="goQuote" class="ring-focus btn-primary flex-1 px-6 py-3.5 rounded-2xl font-extrabold">${escapeHtml(t('goQuote'))}</button>
        </div>

        <div class="md:hidden h-2"></div>
      </div>
    `);

    // Footer buttons on results
    backBtn.classList.remove('hidden');
    skipBtn.classList.add('hidden');
    nextBtn.textContent = lang==='en' ? 'Back to edit' : 'Voltar para editar';
    nextBtn.disabled = false;

    // Events (delegated-ish)
    $('restart').addEventListener('click', ()=>{
      state.step = 0;
      state.answers = { goal:null, channels:[], focus:null, assets:null, volume:null, budget:null, deadline:null, pref:null };
      state.selected.clear();
      renderCurrent();
    });

    // Pick pack
    screen.querySelectorAll('.pickPack').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const key = btn.dataset.pack;
        const pack = packs.find(p=>p.key===key);
        if(!pack) return;
        state.selected.clear();
        pack.items.forEach(it=> state.selected.set(it.id, {id:it.id, period:it.period}));
        updateTotalsUI();
        renderSideSummary();
        renderResults();
      });
    });

    // Checkbox services
    screen.querySelectorAll('.svcCheck').forEach(ch=>{
      ch.addEventListener('change', ()=>{
        const id = ch.dataset.id;
        if(ch.checked) state.selected.set(id, {id, period: 'Mensal'});
        else state.selected.delete(id);

        // update UI parts without full heavy redraw
        updateTotalsUI();
        renderSideSummary();
        const newTot = computeTotals(state.selected);
        const mCount = $('mCount'); const mTotal = $('mTotal');
        if(mCount) mCount.textContent = newTot.count;
        if(mTotal) mTotal.textContent = money(newTot.total);

        // update summary text
        const st = $('summaryText');
        if(st) st.textContent = buildSummaryText();

        // if this is a plan, we need to re-render that card's select dropdown area -> easiest: re-render results lightly
        // but only when a plan is toggled (rare)
        const s = allServices.find(x=>x.__id===id);
        if(s?.__isPlan) renderResults();
      });
    });

    // Plan period changes
    screen.querySelectorAll('.planPeriod').forEach(sel=>{
      sel.addEventListener('change', ()=>{
        const id = sel.dataset.id;
        const it = state.selected.get(id);
        if(it){ it.period = sel.value; state.selected.set(id, it); }
        updateTotalsUI();
        const st = $('summaryText');
        if(st) st.textContent = buildSummaryText();
      });
    });

    // copy
    const copyBtn = $('copySummary');
    if(copyBtn){
      copyBtn.addEventListener('click', async ()=>{
        try{
          await navigator.clipboard.writeText(buildSummaryText());
          copyBtn.textContent = t('copied');
          setTimeout(()=>copyBtn.textContent = t('copy'), 1100);
        }catch(e){
          alert(lang==='en' ? 'Copy failed. Please select and copy manually.' : 'Falha ao copiar. Selecione e copie manualmente.');
        }
      });
    }

    // go quote
    function goToQuote(){
      const summary = buildSummaryText();
      const selectedDetail = Array.from(state.selected.values()).map(it=>{
        const s = allServices.find(x=>x.__id===it.id);
        if(!s) return null;

        let price = s.__minPrice;
        if(s.__isPlan){
          const opt = (s.precos_por_periodo||[]).find(p=>String(p.periodo).toLowerCase()===String(it.period||'Mensal').toLowerCase())
                  || (s.precos_por_periodo||[])[0];
          price = Number(opt?.preco_total_com_desc || s.__minPrice || 0);
        } else {
          price = Number(s.preco || s.__minPrice || 0);
        }

        return {
          category: s.__cat,
          title: s.titulo,
          kind: s.__isPlan ? 'plan' : 'one_off',
          period: s.__isPlan ? (it.period || 'Mensal') : undefined,
          price
        };
      }).filter(Boolean);

      const base = (lang==='en')
        ? 'https://www.comercias.com.br/en/orcamento'
        : 'https://www.comercias.com.br/pt/orcamento';

      const encodedResumo = encodeURIComponent(summary);
      const encodedServices = encodeURIComponent(JSON.stringify(selectedDetail));
      const totalsPayload = computeTotals(state.selected);
      const encodedTotals = encodeURIComponent(JSON.stringify(totalsPayload));

      window.location.href = `${base}?servicos=${encodedServices}&resumo=${encodedResumo}&totais=${encodedTotals}`;
    }

    const goBtn = $('goQuote');
    if(goBtn) goBtn.addEventListener('click', goToQuote);
    const goBtnM = $('goQuoteMobile');
    if(goBtnM) goBtnM.addEventListener('click', goToQuote);
  }

  // =========================================================
  // 9) Navigation
  // =========================================================
  backBtn.addEventListener('click', ()=>{
    if(state.step > 0){
      state.step -= 1;
      renderCurrent();
    }
  });

  skipBtn.addEventListener('click', ()=>{
    const st = steps[state.step];
    if(st?.skippable){
      state.answers[st.id] = null;
      state.step += 1;
      renderCurrent();
    }
  });

  nextBtn.addEventListener('click', ()=>{
    // if on results, go back one step for editing
    if(state.step >= steps.length){
      state.step = steps.length - 1;
      renderCurrent();
      return;
    }

    if(!canProceed()) return;

    // advance
    state.step += 1;

    // pre-build recommended selection once we reach results
    if(state.step === steps.length){
      // auto-select recommended pack if empty
      if(state.selected.size === 0){
        const list = topServices(16);
        const packs = buildPackages(list);
        (packs.find(p=>p.key==='recommended') || packs[0]).items.forEach(it=>{
          state.selected.set(it.id, {id:it.id, period:it.period});
        });
      }
    }

    renderCurrent();
  });

  // =========================================================
  // 10) Language switching
  // =========================================================
  function applyCopy(){
    $('heroBadge').textContent = t('heroBadge');
    $('heroTitle').textContent = t('heroTitle');
    $('heroSub').textContent = t('heroSub');
    $('ctaStart').textContent = t('ctaStart');
    $('miniNoteTitle').textContent = t('miniNoteTitle');
    $('miniNoteText').textContent = t('miniNoteText');

    $('b1t').textContent = t('b1t'); $('b1s').textContent = t('b1s');
    $('b2t').textContent = t('b2t'); $('b2s').textContent = t('b2s');
    $('b3t').textContent = t('b3t'); $('b3s').textContent = t('b3s');

    $('previewTitle').textContent = t('previewTitle');
    $('previewTime').textContent = t('previewTime');
    $('p1t').textContent = t('p1t'); $('p1s').textContent = t('p1s');
    $('p2t').textContent = t('p2t'); $('p2s').textContent = t('p2s');
    $('p3t').textContent = t('p3t'); $('p3s').textContent = t('p3s');
    $('dealTitle').textContent = t('dealTitle');
    $('dealText').textContent = t('dealText');
    $('footerLine').textContent = t('footerLine');

    $('modalTitle').textContent = t('modalTitle');
    $('modalSub').textContent = t('modalSub');
    $('sideTitle').textContent = t('sideTitle');
    $('sideEmpty').textContent = t('sideEmpty');
    $('simTitle').textContent = t('simTitle');
    $('lblSub').textContent = t('lblSub');
    $('lblDisc').textContent = t('lblDisc');
    $('lblPlans').textContent = t('lblPlans');
    $('lblTotal').textContent = t('lblTotal');
    $('noteTotals').textContent = t('noteTotals');
    $('sideStrategy').textContent = t('sideStrategy');
  }

  function setLang(newLang){
    lang = newLang;
    localStorage.setItem('comercias_lang', newLang);
    document.documentElement.lang = (newLang === 'en') ? 'en' : 'pt-BR';

    // toggle UI
    langPTTop.classList.toggle('bg-white/10', newLang==='pt');
    langENTop.classList.toggle('bg-white/10', newLang==='en');
    langPTTop.classList.toggle('text-white/70', newLang!=='pt');
    langENTop.classList.toggle('text-white/70', newLang!=='en');

    langPT.classList.toggle('bg-white/10', newLang==='pt');
    langEN.classList.toggle('bg-white/10', newLang==='en');
    langPT.classList.toggle('text-white/70', newLang!=='pt');
    langEN.classList.toggle('text-white/70', newLang!=='en');

    applyCopy();
    renderCurrent();
  }

  langPTTop.addEventListener('click', ()=>setLang('pt'));
  langENTop.addEventListener('click', ()=>setLang('en'));
  langPT.addEventListener('click', ()=>setLang('pt'));
  langEN.addEventListener('click', ()=>setLang('en'));

  // =========================================================
  // 11) Init
  // =========================================================
  applyCopy();
  setLang(lang);

  // Start screen render
  renderCurrent();

})();
</script>
</body>
</html>
